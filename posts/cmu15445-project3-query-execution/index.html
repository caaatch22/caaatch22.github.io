<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>CMU15445-project3 Query Excution | Mingjie&#39;s Home</title>
<meta name="keywords" content="database, cmu15445">
<meta name="description" content="Overview

åœ¨è¿™æ¬¡å®éªŒå†™å®Œåï¼Œæˆ‘ä»¬å·²ç»èƒ½ä½¿ç”¨bustub-shellå®Œæˆæ‰§è¡Œ sql è¯­å¥äº†ï¼Œè¿˜æ˜¯æŒºæœ‰æˆå°±æ„Ÿçš„ã€‚åŒæ—¶ï¼ŒTA ä¸ºæˆ‘ä»¬å‡†å¤‡äº†æµè§ˆå™¨ä¸Šçš„bustub ï¼Œæ–¹ä¾¿å’Œæˆ‘ä»¬å†™çš„å¯¹æ¯”è°ƒè¯•ã€‚ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ explain æ¥æŸ¥çœ‹ä»–çš„ä¼˜åŒ–ç­–ç•¥ä¸æ‰§è¡Œæ­¥éª¤ã€‚

è¿™æ¬¡å®éªŒçš„ä¸»è¦éš¾ç‚¹åœ¨äºè¯»ä»£ç ï¼Œç†æ¸… bustub çš„æ‰§è¡Œå¼•æ“çš„æ•°æ®æµä»¥åŠä»£ç ä¸­çš„å®ç°ã€‚ææ‡‚äº†ä¹‹åå„ä¸ªç®—å­çš„å®ç°å°±å¾ˆç®€å•äº†ï¼ˆç›¸å¯¹ B&#43;æ ‘ï¼‰ã€‚


ä¸Šå›¾æ˜¯ bustub çš„æ•´ä½“æ¶æ„ã€‚
Parser
sql è¯­å¥çš„è§£æå°±åƒå…¶ä»–ç¼–ç¨‹è¯­è¨€ä¸€æ ·ï¼ŒåŒæ ·éœ€è¦ç¿»è¯‘æˆæ¯”è¾ƒç»“æ„åŒ–çš„ä¸œè¥¿ã€‚Parser é˜¶æ®µä¼šç”Ÿæˆä¸€ä¸ªæŠ½è±¡è¯­æ³•æ ‘(AST, Abstract Syntax Tree)ã€‚ è¿™å¹¶ä¸æ˜¯æ•°æ®åº“æ ¸å¿ƒéƒ¨åˆ†ï¼Œbustub ç›´æ¥ä½¿ç”¨äº† PostgreSQL çš„ parser åº“ libpg_queryã€‚
Binder
å¾—åˆ° AST åï¼Œéœ€è¦å°†è¿™äº›è¯è¯­ç»‘å®šåˆ°æ•°æ®åº“å®ä½“ä¸Šï¼Œè¿™å°±æ˜¯ Binder çš„å·¥ä½œã€‚ä¾‹å¦‚æœ‰è¿™æ ·ä¸€æ¡ sqlï¼š
SELECT table1.y, table2.x FROM table1 INNER JOIN table2 ON table1.x = table2.y;
å…¶ä¸­ SELECT å’Œ FROM æ˜¯å…³é”®å­—ï¼Œx å’Œ table1 æ˜¯æ ‡è¯†ç¬¦ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ explain æ¥çœ‹çœ‹ binder å±‚ï¼ˆbustub-shell æœªå®Œæˆæ—¶ä¹Ÿå¯ä»¥ä½¿ç”¨ explainï¼‰ï¼š
 === BINDER ===                                               
 BoundSelec {                                        
   table=BoundJoin { type=Inner, left=BoundBaseTableRef { table=table1, oid=25 }, right=BoundBaseTableRef { table=table2, oid=26 }, condition=(table1.x=table2.y) }, 
   columns=[table1.y, table2.x],                       
   groupBy=[],
   having=,  
   where=,  
   limit=, 
   offset=,
   order_by=[],                                 
   is_distinct=false,         
   ctes=,
}
å¯ä»¥çœ‹å‡ºï¼Œbinderçš„ä½œç”¨å°±æ˜¯å¯¹ASTçš„å„ä¸ªèŠ‚ç‚¹ç»‘å®šä¸€ä¸ªï¼ˆç‰©ç†ï¼‰å®ä½“ã€‚">
<meta name="author" content="">
<link rel="canonical" href="https://caaatch22.github.io/posts/cmu15445-project3-query-execution/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.678b5c47efa744d2e0dd0d61101075e6aecdc9a0631e7ad8538f4ec0cca79273.css" integrity="sha256-Z4tcR&#43;&#43;nRNLg3Q1hEBB15q7NyaBjHnrYU49OwMynknM=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://caaatch22.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://caaatch22.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://caaatch22.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://caaatch22.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://caaatch22.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://caaatch22.github.io/posts/cmu15445-project3-query-execution/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-WEG841BBW9"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-WEG841BBW9');
        }
      </script><meta property="og:title" content="CMU15445-project3 Query Excution" />
<meta property="og:description"
  content="Overview

åœ¨è¿™æ¬¡å®éªŒå†™å®Œåï¼Œæˆ‘ä»¬å·²ç»èƒ½ä½¿ç”¨bustub-shellå®Œæˆæ‰§è¡Œ sql è¯­å¥äº†ï¼Œè¿˜æ˜¯æŒºæœ‰æˆå°±æ„Ÿçš„ã€‚åŒæ—¶ï¼ŒTA ä¸ºæˆ‘ä»¬å‡†å¤‡äº†æµè§ˆå™¨ä¸Šçš„bustub ï¼Œæ–¹ä¾¿å’Œæˆ‘ä»¬å†™çš„å¯¹æ¯”è°ƒè¯•ã€‚ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ explain æ¥æŸ¥çœ‹ä»–çš„ä¼˜åŒ–ç­–ç•¥ä¸æ‰§è¡Œæ­¥éª¤ã€‚

è¿™æ¬¡å®éªŒçš„ä¸»è¦éš¾ç‚¹åœ¨äºè¯»ä»£ç ï¼Œç†æ¸… bustub çš„æ‰§è¡Œå¼•æ“çš„æ•°æ®æµä»¥åŠä»£ç ä¸­çš„å®ç°ã€‚ææ‡‚äº†ä¹‹åå„ä¸ªç®—å­çš„å®ç°å°±å¾ˆç®€å•äº†ï¼ˆç›¸å¯¹ B&#43;æ ‘ï¼‰ã€‚


ä¸Šå›¾æ˜¯ bustub çš„æ•´ä½“æ¶æ„ã€‚
Parser
sql è¯­å¥çš„è§£æå°±åƒå…¶ä»–ç¼–ç¨‹è¯­è¨€ä¸€æ ·ï¼ŒåŒæ ·éœ€è¦ç¿»è¯‘æˆæ¯”è¾ƒç»“æ„åŒ–çš„ä¸œè¥¿ã€‚Parser é˜¶æ®µä¼šç”Ÿæˆä¸€ä¸ªæŠ½è±¡è¯­æ³•æ ‘(AST, Abstract Syntax Tree)ã€‚ è¿™å¹¶ä¸æ˜¯æ•°æ®åº“æ ¸å¿ƒéƒ¨åˆ†ï¼Œbustub ç›´æ¥ä½¿ç”¨äº† PostgreSQL çš„ parser åº“ libpg_queryã€‚
Binder
å¾—åˆ° AST åï¼Œéœ€è¦å°†è¿™äº›è¯è¯­ç»‘å®šåˆ°æ•°æ®åº“å®ä½“ä¸Šï¼Œè¿™å°±æ˜¯ Binder çš„å·¥ä½œã€‚ä¾‹å¦‚æœ‰è¿™æ ·ä¸€æ¡ sqlï¼š
SELECT table1.y, table2.x FROM table1 INNER JOIN table2 ON table1.x = table2.y;
å…¶ä¸­ SELECT å’Œ FROM æ˜¯å…³é”®å­—ï¼Œx å’Œ table1 æ˜¯æ ‡è¯†ç¬¦ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ explain æ¥çœ‹çœ‹ binder å±‚ï¼ˆbustub-shell æœªå®Œæˆæ—¶ä¹Ÿå¯ä»¥ä½¿ç”¨ explainï¼‰ï¼š
 === BINDER ===                                               
 BoundSelec {                                        
   table=BoundJoin { type=Inner, left=BoundBaseTableRef { table=table1, oid=25 }, right=BoundBaseTableRef { table=table2, oid=26 }, condition=(table1.x=table2.y) }, 
   columns=[table1.y, table2.x],                       
   groupBy=[],
   having=,  
   where=,  
   limit=, 
   offset=,
   order_by=[],                                 
   is_distinct=false,         
   ctes=,
}
å¯ä»¥çœ‹å‡ºï¼Œbinderçš„ä½œç”¨å°±æ˜¯å¯¹ASTçš„å„ä¸ªèŠ‚ç‚¹ç»‘å®šä¸€ä¸ªï¼ˆç‰©ç†ï¼‰å®ä½“ã€‚" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://caaatch22.github.io/posts/cmu15445-project3-query-execution/" />
<meta property="og:image" content="https://caaatch22.github.io/img/busTub/query_excution/architecture-overview.png" /><meta property="article:section" content="posts" />

<meta property="article:published_time" content="2023-01-17T23:45:12+00:00" />

<meta property="article:modified_time" content="2023-01-17T23:45:12+00:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://caaatch22.github.io/img/busTub/query_excution/architecture-overview.png" />
<meta name="twitter:title" content="CMU15445-project3 Query Excution" />
<meta name="twitter:description"
    content="Overview

åœ¨è¿™æ¬¡å®éªŒå†™å®Œåï¼Œæˆ‘ä»¬å·²ç»èƒ½ä½¿ç”¨bustub-shellå®Œæˆæ‰§è¡Œ sql è¯­å¥äº†ï¼Œè¿˜æ˜¯æŒºæœ‰æˆå°±æ„Ÿçš„ã€‚åŒæ—¶ï¼ŒTA ä¸ºæˆ‘ä»¬å‡†å¤‡äº†æµè§ˆå™¨ä¸Šçš„bustub ï¼Œæ–¹ä¾¿å’Œæˆ‘ä»¬å†™çš„å¯¹æ¯”è°ƒè¯•ã€‚ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ explain æ¥æŸ¥çœ‹ä»–çš„ä¼˜åŒ–ç­–ç•¥ä¸æ‰§è¡Œæ­¥éª¤ã€‚

è¿™æ¬¡å®éªŒçš„ä¸»è¦éš¾ç‚¹åœ¨äºè¯»ä»£ç ï¼Œç†æ¸… bustub çš„æ‰§è¡Œå¼•æ“çš„æ•°æ®æµä»¥åŠä»£ç ä¸­çš„å®ç°ã€‚ææ‡‚äº†ä¹‹åå„ä¸ªç®—å­çš„å®ç°å°±å¾ˆç®€å•äº†ï¼ˆç›¸å¯¹ B&#43;æ ‘ï¼‰ã€‚


ä¸Šå›¾æ˜¯ bustub çš„æ•´ä½“æ¶æ„ã€‚
Parser
sql è¯­å¥çš„è§£æå°±åƒå…¶ä»–ç¼–ç¨‹è¯­è¨€ä¸€æ ·ï¼ŒåŒæ ·éœ€è¦ç¿»è¯‘æˆæ¯”è¾ƒç»“æ„åŒ–çš„ä¸œè¥¿ã€‚Parser é˜¶æ®µä¼šç”Ÿæˆä¸€ä¸ªæŠ½è±¡è¯­æ³•æ ‘(AST, Abstract Syntax Tree)ã€‚ è¿™å¹¶ä¸æ˜¯æ•°æ®åº“æ ¸å¿ƒéƒ¨åˆ†ï¼Œbustub ç›´æ¥ä½¿ç”¨äº† PostgreSQL çš„ parser åº“ libpg_queryã€‚
Binder
å¾—åˆ° AST åï¼Œéœ€è¦å°†è¿™äº›è¯è¯­ç»‘å®šåˆ°æ•°æ®åº“å®ä½“ä¸Šï¼Œè¿™å°±æ˜¯ Binder çš„å·¥ä½œã€‚ä¾‹å¦‚æœ‰è¿™æ ·ä¸€æ¡ sqlï¼š
SELECT table1.y, table2.x FROM table1 INNER JOIN table2 ON table1.x = table2.y;
å…¶ä¸­ SELECT å’Œ FROM æ˜¯å…³é”®å­—ï¼Œx å’Œ table1 æ˜¯æ ‡è¯†ç¬¦ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ explain æ¥çœ‹çœ‹ binder å±‚ï¼ˆbustub-shell æœªå®Œæˆæ—¶ä¹Ÿå¯ä»¥ä½¿ç”¨ explainï¼‰ï¼š
 === BINDER ===                                               
 BoundSelec {                                        
   table=BoundJoin { type=Inner, left=BoundBaseTableRef { table=table1, oid=25 }, right=BoundBaseTableRef { table=table2, oid=26 }, condition=(table1.x=table2.y) }, 
   columns=[table1.y, table2.x],                       
   groupBy=[],
   having=,  
   where=,  
   limit=, 
   offset=,
   order_by=[],                                 
   is_distinct=false,         
   ctes=,
}
å¯ä»¥çœ‹å‡ºï¼Œbinderçš„ä½œç”¨å°±æ˜¯å¯¹ASTçš„å„ä¸ªèŠ‚ç‚¹ç»‘å®šä¸€ä¸ªï¼ˆç‰©ç†ï¼‰å®ä½“ã€‚" />


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://caaatch22.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "CMU15445-project3 Query Excution",
      "item": "https://caaatch22.github.io/posts/cmu15445-project3-query-execution/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "CMU15445-project3 Query Excution",
  "name": "CMU15445-project3 Query Excution",
  "description": "Overview åœ¨è¿™æ¬¡å®éªŒå†™å®Œåï¼Œæˆ‘ä»¬å·²ç»èƒ½ä½¿ç”¨bustub-shellå®Œæˆæ‰§è¡Œ sql è¯­å¥äº†ï¼Œè¿˜æ˜¯æŒºæœ‰æˆå°±æ„Ÿçš„ã€‚åŒæ—¶ï¼ŒTA ä¸ºæˆ‘ä»¬å‡†å¤‡äº†æµè§ˆå™¨ä¸Šçš„bustub ï¼Œæ–¹ä¾¿å’Œæˆ‘ä»¬å†™çš„å¯¹æ¯”è°ƒè¯•ã€‚ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ explain æ¥æŸ¥çœ‹ä»–çš„ä¼˜åŒ–ç­–ç•¥ä¸æ‰§è¡Œæ­¥éª¤ã€‚\nè¿™æ¬¡å®éªŒçš„ä¸»è¦éš¾ç‚¹åœ¨äºè¯»ä»£ç ï¼Œç†æ¸… bustub çš„æ‰§è¡Œå¼•æ“çš„æ•°æ®æµä»¥åŠä»£ç ä¸­çš„å®ç°ã€‚ææ‡‚äº†ä¹‹åå„ä¸ªç®—å­çš„å®ç°å°±å¾ˆç®€å•äº†ï¼ˆç›¸å¯¹ B+æ ‘ï¼‰ã€‚\nä¸Šå›¾æ˜¯ bustub çš„æ•´ä½“æ¶æ„ã€‚\nParser sql è¯­å¥çš„è§£æå°±åƒå…¶ä»–ç¼–ç¨‹è¯­è¨€ä¸€æ ·ï¼ŒåŒæ ·éœ€è¦ç¿»è¯‘æˆæ¯”è¾ƒç»“æ„åŒ–çš„ä¸œè¥¿ã€‚Parser é˜¶æ®µä¼šç”Ÿæˆä¸€ä¸ªæŠ½è±¡è¯­æ³•æ ‘(AST, Abstract Syntax Tree)ã€‚ è¿™å¹¶ä¸æ˜¯æ•°æ®åº“æ ¸å¿ƒéƒ¨åˆ†ï¼Œbustub ç›´æ¥ä½¿ç”¨äº† PostgreSQL çš„ parser åº“ libpg_queryã€‚\nBinder å¾—åˆ° AST åï¼Œéœ€è¦å°†è¿™äº›è¯è¯­ç»‘å®šåˆ°æ•°æ®åº“å®ä½“ä¸Šï¼Œè¿™å°±æ˜¯ Binder çš„å·¥ä½œã€‚ä¾‹å¦‚æœ‰è¿™æ ·ä¸€æ¡ sqlï¼š\nSELECT table1.y, table2.x FROM table1 INNER JOIN table2 ON table1.x = table2.y; å…¶ä¸­ SELECT å’Œ FROM æ˜¯å…³é”®å­—ï¼Œx å’Œ table1 æ˜¯æ ‡è¯†ç¬¦ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ explain æ¥çœ‹çœ‹ binder å±‚ï¼ˆbustub-shell æœªå®Œæˆæ—¶ä¹Ÿå¯ä»¥ä½¿ç”¨ explainï¼‰ï¼š\n=== BINDER === BoundSelec { table=BoundJoin { type=Inner, left=BoundBaseTableRef { table=table1, oid=25 }, right=BoundBaseTableRef { table=table2, oid=26 }, condition=(table1.x=table2.y) }, columns=[table1.y, table2.x], groupBy=[], having=, where=, limit=, offset=, order_by=[], is_distinct=false, ctes=, } å¯ä»¥çœ‹å‡ºï¼Œbinderçš„ä½œç”¨å°±æ˜¯å¯¹ASTçš„å„ä¸ªèŠ‚ç‚¹ç»‘å®šä¸€ä¸ªï¼ˆç‰©ç†ï¼‰å®ä½“ã€‚\n",
  "keywords": [
    "database", "cmu15445"
  ],
  "articleBody": "Overview åœ¨è¿™æ¬¡å®éªŒå†™å®Œåï¼Œæˆ‘ä»¬å·²ç»èƒ½ä½¿ç”¨bustub-shellå®Œæˆæ‰§è¡Œ sql è¯­å¥äº†ï¼Œè¿˜æ˜¯æŒºæœ‰æˆå°±æ„Ÿçš„ã€‚åŒæ—¶ï¼ŒTA ä¸ºæˆ‘ä»¬å‡†å¤‡äº†æµè§ˆå™¨ä¸Šçš„bustub ï¼Œæ–¹ä¾¿å’Œæˆ‘ä»¬å†™çš„å¯¹æ¯”è°ƒè¯•ã€‚ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ explain æ¥æŸ¥çœ‹ä»–çš„ä¼˜åŒ–ç­–ç•¥ä¸æ‰§è¡Œæ­¥éª¤ã€‚\nè¿™æ¬¡å®éªŒçš„ä¸»è¦éš¾ç‚¹åœ¨äºè¯»ä»£ç ï¼Œç†æ¸… bustub çš„æ‰§è¡Œå¼•æ“çš„æ•°æ®æµä»¥åŠä»£ç ä¸­çš„å®ç°ã€‚ææ‡‚äº†ä¹‹åå„ä¸ªç®—å­çš„å®ç°å°±å¾ˆç®€å•äº†ï¼ˆç›¸å¯¹ B+æ ‘ï¼‰ã€‚\nä¸Šå›¾æ˜¯ bustub çš„æ•´ä½“æ¶æ„ã€‚\nParser sql è¯­å¥çš„è§£æå°±åƒå…¶ä»–ç¼–ç¨‹è¯­è¨€ä¸€æ ·ï¼ŒåŒæ ·éœ€è¦ç¿»è¯‘æˆæ¯”è¾ƒç»“æ„åŒ–çš„ä¸œè¥¿ã€‚Parser é˜¶æ®µä¼šç”Ÿæˆä¸€ä¸ªæŠ½è±¡è¯­æ³•æ ‘(AST, Abstract Syntax Tree)ã€‚ è¿™å¹¶ä¸æ˜¯æ•°æ®åº“æ ¸å¿ƒéƒ¨åˆ†ï¼Œbustub ç›´æ¥ä½¿ç”¨äº† PostgreSQL çš„ parser åº“ libpg_queryã€‚\nBinder å¾—åˆ° AST åï¼Œéœ€è¦å°†è¿™äº›è¯è¯­ç»‘å®šåˆ°æ•°æ®åº“å®ä½“ä¸Šï¼Œè¿™å°±æ˜¯ Binder çš„å·¥ä½œã€‚ä¾‹å¦‚æœ‰è¿™æ ·ä¸€æ¡ sqlï¼š\nSELECT table1.y, table2.x FROM table1 INNER JOIN table2 ON table1.x = table2.y; å…¶ä¸­ SELECT å’Œ FROM æ˜¯å…³é”®å­—ï¼Œx å’Œ table1 æ˜¯æ ‡è¯†ç¬¦ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ explain æ¥çœ‹çœ‹ binder å±‚ï¼ˆbustub-shell æœªå®Œæˆæ—¶ä¹Ÿå¯ä»¥ä½¿ç”¨ explainï¼‰ï¼š\n=== BINDER === BoundSelec { table=BoundJoin { type=Inner, left=BoundBaseTableRef { table=table1, oid=25 }, right=BoundBaseTableRef { table=table2, oid=26 }, condition=(table1.x=table2.y) }, columns=[table1.y, table2.x], groupBy=[], having=, where=, limit=, offset=, order_by=[], is_distinct=false, ctes=, } å¯ä»¥çœ‹å‡ºï¼Œbinderçš„ä½œç”¨å°±æ˜¯å¯¹ASTçš„å„ä¸ªèŠ‚ç‚¹ç»‘å®šä¸€ä¸ªï¼ˆç‰©ç†ï¼‰å®ä½“ã€‚\nPlanner å¾—åˆ° Bustub AST åï¼ŒPlanner éå†è¿™æ£µæ ‘ï¼Œç”Ÿæˆåˆæ­¥çš„æŸ¥è¯¢è®¡åˆ’ã€‚æŸ¥è¯¢è®¡åˆ’ä¹Ÿæ˜¯ä¸€æ£µæ ‘çš„å½¢å¼ã€‚ä¾‹å¦‚è¿™æ¡ sqlï¼š\nSELECT table1.y, table2.x FROM table1 INNER JOIN table2 ON t1.x = t2.y; æŸ¥çœ‹ explainï¼š\n=== PLANNER === Projection { exprs=[#0.1, #0.2] } | (table1.y:INTEGER, table2.x:INTEGER) NestedLoopJoin { type=Inner, predicate=(#0.0=#1.1) } | (table1.x:INTEGER, table1.y:INTEGER, table2.x:INTEGER, table2.y:INTEGER) SeqScan { table=table1 } | (table1.x:INTEGER, table1.y:INTEGER) SeqScan { table=table2 } | (table2.x:INTEGER, table2.y:INTEGER) ä¸Šé¢çš„è§£é‡Šå…¶å®æ˜¯æ ‘å‹çš„ï¼Œå¦‚ä¸‹å›¾ï¼š æŸ¥è¯¢è®¡åˆ’è§„å®šäº†æ•°æ®çš„æµå‘ã€‚æ•°æ®ä»æ ‘å¶æµå‘æ ‘æ ¹ï¼Œè‡ªåº•å‘ä¸Šåœ°æµåŠ¨ï¼Œåœ¨æ ¹èŠ‚ç‚¹è¾“å‡ºç»“æœã€‚\nOptimizer ç”ŸæˆæŸ¥è¯¢è®¡åˆ’å ç”± Planner å¾—åˆ°åˆæ­¥çš„æŸ¥è¯¢è®¡åˆ’åï¼Œå†å°†æŸ¥è¯¢è®¡åˆ’äº¤ç»™ Optimizer è¿›è¡Œä¿®æ”¹ä¼˜åŒ–ï¼Œç”Ÿæˆä¼˜åŒ–è¿‡åçš„æœ€ç»ˆæŸ¥è¯¢è®¡åˆ’ã€‚Optimizer ä¸»è¦æœ‰ä¸¤ç§å®ç°æ–¹å¼ï¼š\nRule-based. é€šè¿‡è‡ªåŠ¨é‡å†™æŸ¥è¯¢æ¥é¿å…æ•ˆç‡ä½çš„æ–¹æ³•ã€‚ä¾‹å¦‚æˆ‘ä»¬åœ¨ Task 3 ä¸­å°†è¦å®ç°çš„ï¼Œå°† Limit + Sort åˆå¹¶ä¸º TopNã€‚ è¿™ç§ Optimizer ä¸éœ€è¦çŸ¥é“æ•°æ®çš„å…·ä½“å†…å®¹ï¼Œä»…æ˜¯æ ¹æ®é¢„å…ˆå®šä¹‰å¥½çš„è§„åˆ™ä¿®æ”¹ Plan Nodeã€‚ Cost-based. ç”¨æŸç§æ¨¡å‹æ¥é¢„ä¼°æ‰§è¡Œè®¡åˆ’çš„æ—¶é—´ï¼Œè¿™å°±éœ€è¦å­˜å¾ˆå¤šè·Ÿæ•°æ®ç›¸å…³çš„æ•°æ® é€šè¿‡å¯¹ä¸åŒæ¨¡å‹çš„ cost æ¯”è¾ƒé€‰å‡ºæ‰§è¡Œ cost æœ€å°çš„ã€‚ è¿™ä¹Ÿä¼šé€ æˆä¸€äº›é¢å¤–å¼€é”€ ï¼ˆè¿è¡Œè¿™ä¸ªcost modelï¼‰ Bustub çš„ Optimizer é‡‡ç”¨ç¬¬ä¸€ç§å®ç°æ–¹å¼ã€‚\nä¸€èˆ¬æ¥è¯´ï¼ŒPlanner ç”Ÿæˆçš„æ˜¯ Logical Plan Nodeï¼Œä»£è¡¨æŠ½è±¡çš„ Planã€‚Optimizer åˆ™ç”Ÿæˆ Physical Plan Nodeï¼Œä»£è¡¨å…·ä½“æ‰§è¡Œçš„ Planã€‚ä¾‹å¦‚æ˜¯ Joinã€‚åœ¨ Planner ç”Ÿæˆçš„æŸ¥è¯¢è®¡åˆ’ä¸­ï¼ŒJoin å°±æ˜¯ Joinã€‚åœ¨ Optimizer ç”Ÿæˆçš„æŸ¥è¯¢è®¡åˆ’ä¸­ï¼ŒJoin ä¼šè¢«ä¼˜åŒ–æˆå…·ä½“çš„ HashJoin æˆ– NestedIndexJoin ç­‰ç­‰ã€‚åœ¨ Bustub ä¸­ï¼Œå¹¶ä¸åŒºåˆ† Logical Plan Node å’Œ Physical Plan Nodeã€‚Planner ä¼šç›´æ¥ç”Ÿæˆ Physical Plan Nodeã€‚\nExecutor åœ¨æ‹¿åˆ° Optimizer ç”Ÿæˆçš„å…·ä½“çš„æŸ¥è¯¢è®¡åˆ’åï¼Œå°±å¯ä»¥ç”ŸæˆçœŸæ­£æ‰§è¡ŒæŸ¥è¯¢è®¡åˆ’çš„ä¸€ç³»åˆ—ç®—å­äº†ã€‚ç®—å­ä¹Ÿæ˜¯æˆ‘ä»¬åœ¨ Project 3 ä¸­éœ€è¦å®ç°çš„ä¸»è¦å†…å®¹ã€‚ç”Ÿæˆç®—å­çš„æ­¥éª¤å¾ˆç®€å•ï¼Œéå†æŸ¥è¯¢è®¡åˆ’æ ‘ï¼Œå°†æ ‘ä¸Šçš„ PlanNode æ›¿æ¢æˆå¯¹åº”çš„ Executorã€‚ç®—å­çš„æ‰§è¡Œæ¨¡å‹ä¹Ÿå¤§è‡´åˆ†ä¸ºä¸‰ç§ï¼š\nIterator/Pipeline Model(volcano model)ã€‚æ¯ä¸ªç®—å­éƒ½æœ‰ Init() å’Œ Next() ä¸¤ä¸ªæ–¹æ³•ã€‚Init() å¯¹ç®—å­è¿›è¡Œåˆå§‹åŒ–å·¥ä½œã€‚Next() åˆ™æ˜¯å‘ä¸‹å±‚ç®—å­è¯·æ±‚ä¸‹ä¸€æ¡æ•°æ®ã€‚å½“ Next() è¿”å› false æ—¶ï¼Œåˆ™ä»£è¡¨ä¸‹å±‚ç®—å­å·²ç»æ²¡æœ‰å‰©ä½™æ•°æ®ï¼Œè¿­ä»£ç»“æŸã€‚ç«å±±æ¨¡å‹ä¸€æ¬¡è°ƒç”¨åªå‘ä¸‹å±‚ç®—å­è¯·æ±‚ä¸€æ¡æ•°æ®ï¼Œå ç”¨å†…å­˜è¾ƒå°ï¼Œä½†å‡½æ•°è°ƒç”¨å¼€é”€å¤§ã€‚ Materialization Model. æ‰€æœ‰ç®—å­ç«‹å³è®¡ç®—å‡ºæ‰€æœ‰ç»“æœå¹¶è¿”å›ã€‚å’Œ Iterator Model ç›¸åã€‚è¿™ç§æ¨¡å‹çš„å¼Šç«¯æ˜¾è€Œæ˜“è§ï¼Œå½“æ•°æ®é‡è¾ƒå¤§æ—¶ï¼Œå†…å­˜å ç”¨å¾ˆé«˜ï¼Œä½†å‡å°‘äº†å‡½æ•°è°ƒç”¨çš„å¼€é”€ã€‚æ¯”è¾ƒé€‚åˆæŸ¥è¯¢æ•°æ®é‡è¾ƒå°çš„ OLTP workloadsã€‚\nVectorized/Batch Model. å¯¹ä¸Šé¢ä¸¤ç§æ¨¡å‹çš„ä¸­å’Œï¼Œä¸€æ¬¡è°ƒç”¨è¿”å›ä¸€æ‰¹æ•°æ®ã€‚åˆ©äº SIMD åŠ é€Ÿã€‚ç›®å‰æ¯”è¾ƒå…ˆè¿›çš„ OLAP æ•°æ®åº“é‡‡ç”¨è¿™ç§æ¨¡å‹ã€‚\nBustub é‡‡ç”¨ Iterator Modelã€‚\nMetadata ä¸Šé¢ä»‹ç»äº† sqlè¯­å¥æ‰§è¡Œè¿‡ç¨‹ï¼Œè¶³ä»¥è®©æˆ‘ä»¬å¯¹æ•´ä¸ªæ‰§è¡Œå¼•æ“æœ‰å¤§ä½“äº†è§£ã€‚ä½†æ˜¯æˆ‘åœ¨åšè¿™ä¸ª lab æ—¶å€™è¿˜æ˜¯æœ‰å¾ˆå¤šå›°æƒ‘çš„åœ°æ–¹ã€‚æœ€åæ˜¯è¿·è¿·ç³Šç³Šçš„å†™å®Œäº†æ‰æ•´ç†äº†ä¸‹ã€‚å¤§ä½“ä¸Šçš„ä¿¡æ¯åŒ…æ‹¬åœ¨ä¸‹å›¾ä¸­ï¼š ï¼ˆå›¾ç‰‡æ”¹è‡ªè¿™ç¯‡åšå®¢ï¼‰\nTask #1 - Access Method Executors SeqScan å®ç°æ¯”è¾ƒç®€å•ï¼Œè·å– table_iter ç›´æ¥éå†å³å¯ã€‚è¿™é‡Œè¯´è¯´è¿™ä¸ªplan_-\u003efilter_predicate_ï¼Œ ä»–æ˜¯ä¸€ä¸ªAbstractExpressionRefï¼Œè€Œä¸€ä¸ªAbstractExpressionæ„æ€æ˜¯ä¸€ä¸ª è¡¨è¾¾å¼ ï¼Œä»–é‡Œé¢æœ€é‡è¦çš„ä¸¤ä¸ªå‡½æ•°æ˜¯ Evaluate(const Tuple *tuple, const Schema \u0026schema)å’Œ EvaluateJoin(const Tuple *left_tuple, const Schema \u0026left_schema, const Tuple *right_tuple, const Schema \u0026right_schema)ï¼Œä¸»è¦å°±æ˜¯ç”¨æ¥åš filter çš„ã€‚ä¾‹å¦‚\nselect * from table1 where x = 1; å¦‚æœä»»ä½•ä¼˜åŒ–éƒ½æ²¡æœ‰ï¼Œé‚£ä¹ˆä¸Šè¿°è¯­å¥å¯ä»¥è§£æä¸ºä¸¤å±‚ï¼š\nä» table1 ä¸­é€‰å‡ºæ‰€æœ‰çš„ tupleã€‚ é€‰å‡º x = 1çš„ tupleã€‚ç›¸å½“äºåº•ä¸‹çš„ seqscan ç»“ç‚¹ä¼šå°†æ‰€æœ‰ tuple å‘åˆ°ä¸Šä¸€å±‚ï¼Œç„¶åä¸Šä¸€å±‚å†åšä¸€æ¬¡ filterã€‚ä½†æ˜¯æˆ‘ä»¬é€šè¿‡è°“è¯ä¸‹æ¨ï¼Œå¯ä»¥åœ¨seqscan æ—¶å€™å°±é€šè¿‡ filter_predicate_ å°†éœ€è¦çš„è¿‡æ»¤å‡ºæ¥ï¼Œä¸éœ€è¦çš„ä¸ç”¨å‘ç»™ä¸Šä¸€å±‚ã€‚ï¼ˆå½“ç„¶ï¼Œè¿™ä¸ªä¾‹å­ä¸å¤ªå‡†ç¡®ã€‚åœ¨è¿™ä¸ªæƒ…å†µä¸‹æœ¬æ¥å°±æ˜¯ä¸€æ¬¡æå®šçš„ï¼Œæ€»ä¹‹æ˜¯åœ¨å¤æ‚çš„æ—¶å€™å¯ä»¥æŠŠè°“è¯ä¸‹æ¨ï¼‰ã€‚ è¿™ä¸ª Evaluate è¿”å›ä¸€ä¸ª Valueï¼Œå®é™…ä¸Šå¦‚æœåšfilteråº”è¯¥è¿”å› booleanï¼Œæ‰€ä»¥éœ€è¦é€šè¿‡filter_predicate_-\u003eEvaluate(tuple, table_info_-\u003eschema_).GetAs()è½¬åŒ–ä¸€ä¸‹ã€‚ å¦å¤–ï¼Œseqscan å®é™…ä¸Šä¸ä¼šç”¨åˆ° filter_predicateã€‚åé¢é‡åˆ°éœ€è¦ predicate çš„åœ°æ–¹ä¼šå†å¼ºè°ƒã€‚ Insert \u0026 Delete è¿™ä¸¤ä¸ªç®—å­æ˜¯å”¯äºŒçš„å†™ç®—å­ï¼ˆå®é™…ä¸Šåé¢çš„ä¼˜åŒ–è¿‡ç¨‹ä¸­éœ€è¦å®ç°ä¸€ä¸ª updateç®—å­ï¼‰ã€‚\næˆ‘ä»¬å…ˆçœ‹ä¸‹è¿™ä¸¤ä¸ªç®—å­çš„è¡Œä¸ºï¼š\nbustub\u003e insert into t1 values (0, 'ğŸ¥°', 10), (1, 'ğŸ¥°ğŸ¥°', 11), (2, 'ğŸ¥°ğŸ¥°ğŸ¥°', 12), (3, 'ğŸ¥°ğŸ¥°ğŸ¥°ğŸ¥°', 13), (4, 'ğŸ¥°ğŸ¥°ğŸ¥°ğŸ¥°', 14); // output +-------------------------------+ | __bustub_internal.insert_rows | +-------------------------------+ | 5 | +-------------------------------+ è¿™ä¸¤ä¸ªç®—å­ä»–ä»¬ä¼šä¸€ç›´ nextï¼Œç„¶åè¿”å›ä¸€æ¬¡ï¼Œè¿”å›çš„æ˜¯æ’å…¥/åˆ é™¤ tuple çš„ä¸ªæ•°ï¼ˆæ‰€ç”Ÿæˆçš„tupleï¼‰ã€‚æœ‰ç‚¹åƒ pipeline breakerï¼Œä½†æ˜¯ç”±äºä»–ä»¬ä¸€å®šæ˜¯é¡¶å±‚ç®—å­ï¼Œæ‰€ä»¥å¥½åƒä¸å« pipeline breakerã€‚\nä¸ªäººæ„Ÿè§‰è¿™ä¸ªè¿”å›ä¸ªæ•°çš„è®¾è®¡æœ‰ç‚¹ä¸æ˜¯å¾ˆåˆç†ï¼Œå®ƒä¸€å®šè¦å°†ä¸ªæ•°è½¬åŒ–æˆä¸€ä¸ªtupleè¿”å›ã€‚å¤§æ¦‚æ˜¯è¿™æ ·çš„æ“ä½œã€‚\n*tuple = Tuple(std::vector\u003cValue\u003e(GetOutputSchema().GetColumnCount() /* ColumnCount() should be one*/, Value(TypeId::INTEGER, counter)), \u0026GetOutputSchema()); å¦å¤–éœ€è¦æ³¨æ„çš„å°±æ˜¯è¿™äº› å¢åŠ /åˆ é™¤ tuple æ—¶ï¼Œå¯¹åº”çš„ç´¢å¼•é¡¹ä¹Ÿéœ€è¦å¢åŠ /åˆ é™¤ã€‚\nIndexScan è¿™ä¸ªå°±ç®€å•äº†ï¼Œåœ¨ Init() æ—¶å€™ä¿å­˜ index_iterï¼Œ next() æ—¶ç›´æ¥è°ƒç”¨å†è‡ªå¢å°±å¯ä»¥ã€‚\nTask #2 - Aggregation \u0026 Join Executors Aggregation aggregation æ“ä½œæ˜¯ä¸€ä¸ª pipeline breakerã€‚ä»–ä¼šåœ¨ init å¾—åˆ°å…¨éƒ¨ç­”æ¡ˆç„¶åå† next æ—¶ä¸€æ¡ä¸€æ¡è¿”å›ã€‚\nSimpleAggregationHashTable ç»´æŠ¤ä¸€å¼ å“ˆå¸Œè¡¨ï¼Œé”®ä¸º AggregateKeyï¼Œå€¼ä¸º AggregateValueï¼Œå‡ä¸º std::vectorã€‚key ä»£è¡¨ group by çš„å­—æ®µçš„æ•°ç»„ï¼Œvalue åˆ™æ˜¯éœ€è¦ aggregate çš„å­—æ®µçš„æ•°ç»„ã€‚åœ¨ä¸‹å±‚ç®—å­ä¼ æ¥ä¸€ä¸ª tuple æ—¶ï¼Œå°† tuple çš„ group by å­—æ®µå’Œ aggregate å­—æ®µåˆ†åˆ«æå–å‡ºæ¥ï¼Œè°ƒç”¨ InsertCombine() å°† group by å’Œ aggregate çš„æ˜ å°„å…³ç³»å­˜å…¥ SimpleAggregationHashTableã€‚è‹¥å½“å‰ hashmap ä¸­æ²¡æœ‰ group by çš„è®°å½•ï¼Œåˆ™åˆ›å»ºåˆå€¼ï¼›è‹¥å·²æœ‰è®°å½•ï¼Œåˆ™æŒ‰ aggregate è§„åˆ™é€ä¸€æ›´æ–°æ‰€æœ‰çš„ aggregate å­—æ®µï¼Œä¾‹å¦‚å– max/minï¼Œæ±‚ sum ç­‰ç­‰ã€‚ä¾‹å¦‚ä¸‹é¢è¿™æ¡ sqlï¼š\nSELECT min(t.z), max(t.z), sum(t.z) FROM t GROUP BY t.x, t.y; group byï¼ˆAggregateKeyï¼‰ä¸º {t.x, t.y}ï¼Œaggregateï¼ˆAggregateValueï¼‰ä¸º {t.z, t.z, t.z}ã€‚aggregate è§„åˆ™ä¸º {min, max, sum}ã€‚\néœ€è¦é¢å¤–æ³¨æ„ count(column) å’Œ count(*) çš„åŒºåˆ«ï¼Œä»¥åŠå¯¹ç©ºå€¼çš„å¤„ç†ã€‚\nåœ¨ Init() ä¸­è®¡ç®—å‡ºæ•´å¼  hashmap åï¼Œåœ¨ Next() ä¸­ç›´æ¥åˆ©ç”¨ hashmap iterator å°†ç»“æœä¾æ¬¡å–å‡ºã€‚è¿™é‡Œçš„è¾“å‡ºå½¢å¼æœ‰ç‚¹å¥‡æ€ªï¼Œéœ€è¦è¿™æ ·çš„è¾“å‡ºï¼š schema å·²ç»åœ¨ GetOutputSchema() ä¸­å‡†å¤‡å¥½äº†ã€‚\nNestedLoopJoin æˆ‘çš„å®ç°æ¯”è¾ƒ trickyã€‚æˆ‘åœ¨ init æ—¶å€™ç›´æ¥æŠŠä¸‹å±‚ç®—å­ï¼ˆleft_executorå’Œright_executorï¼‰æ‰€æœ‰çš„tupleéƒ½å¾—åˆ°äº†ï¼ˆç›¸å½“äºå½“ä½œ pipeline breakerï¼‰ï¼Œä¿å­˜åœ¨ä¸¤å¼ è¡¨ä¸­ã€‚å† nextæ—¶å€™è¿›è¡ŒåŒ¹é…ã€‚è¿™é‡Œçš„ left-join å’Œ inner-join æ˜¯éœ€è¦åˆ†å¼€å®ç°çš„ï¼Œå¯ä»¥åœ¨ç½‘ä¸ŠæŸ¥ä¸‹left-joinå’Œinner-joinçš„åŒºåˆ«ã€‚ åœ¨è¿™é‡Œåˆ¤æ–­å·¦å³ä¸¤ä¸ª tuple æ˜¯å¦ match å°±éœ€è¦ç”¨åˆ°plan_-\u003ePredicate().EvaluateJoin()ï¼ŒåŒæ ·è¦ GetAs()ã€‚\nå½“æˆ‘ä»¬å¾—åˆ°ä¸€ä¸ª match åï¼Œè¿”å›å‰è®°å¾—ä¿å­˜ä¸Šä¸‹æ–‡ï¼Œä¾‹å¦‚ï¼Œä½ å¯ä»¥ä¿å­˜ match çš„ tuple å†å·¦è¡¨ä¸­çš„ä¸‹æ ‡å’Œå³è¡¨ä¸­çš„ä¸‹æ ‡ï¼Œè¿™æ ·ä¸‹æ¬¡è°ƒç”¨ next æ—¶å€™ï¼Œå°±ä¸ç”¨é‡æ–°æ‰«æä¸€æ¬¡ã€‚\nNestedIndexJoin åœ¨è¿›è¡Œ equi-join æ—¶ï¼Œå¦‚æœå‘ç° JOIN ON å³è¾¹çš„å­—æ®µä¸Šå»ºäº† indexï¼Œåˆ™ Optimizer ä¼šå°† NestedLoopJoin ä¼˜åŒ–ä¸º NestedIndexJoinã€‚å…·ä½“å®ç°å’Œ NestedLoopJoin å·®ä¸å¤šï¼Œåªæ˜¯åœ¨å°è¯•åŒ¹é…å³è¡¨ tuple æ—¶ï¼Œä¼šæ‹¿ join key å» B+Tree Index é‡Œè¿›è¡ŒæŸ¥è¯¢ã€‚å¦‚æœæŸ¥è¯¢åˆ°ç»“æœï¼Œå°±æ‹¿ç€æŸ¥åˆ°çš„ RID å»å³è¡¨è·å– tuple ç„¶åè£…é…æˆç»“æœè¾“å‡ºã€‚\nTask #3 - Sort + Limit Executors and Top-N Optimization sort è¿™ä¸ªå®éªŒçš„ sort æ— éœ€è¿›è¡Œå¤–éƒ¨æ’åºï¼Œé‡è½½å°äºåå°±å¯ä»¥å®ç°ã€‚å°±æ˜¯æ¯”è¾ƒçš„æ–¹å¼æœ‰ç‚¹å¥‡æ€ªï¼Œå¯ä»¥ç±»æ¯”ä»¥ä¸‹å†™ï¼š\norder_key.second-\u003eEvaluate(\u0026lhs, schema).CompareLessThan(order_key.second-\u003eEvaluate(\u0026rhs, schema)) limit ç®€å•ï¼Œlimit é™åˆ¶åœ¨ plan_-\u003eGetlimit()é‡Œé¢ã€‚\nTop-N Optimization Rule ç®€å•ï¼Œä¼˜å…ˆé˜Ÿåˆ—é‡è½½å°äºï¼ˆé‡è½½æ–¹å¼ä¸ sort ç›¸åŒï¼‰ï¼Œç„¶åæˆªå–å‰ n ä¸ªã€‚\nSort + Limit As TopN è¿™æ˜¯ Project 3 é‡Œæœ€åä¸€ä¸ªå¿…åšçš„å°é—®ï¼Œä¹Ÿæ˜¯å”¯ä¸€ä¸€ä¸ª Optimizer ï¼Œå°† Sort + Limit ä¼˜åŒ–ä¸º TopNã€‚å…ˆçœ‹çœ‹ Optimizer æ˜¯å¦‚ä½•æ‰§è¡Œä¼˜åŒ–è§„åˆ™çš„ï¼š\nauto Optimizer::OptimizeCustom(const AbstractPlanNodeRef \u0026plan) -\u003e AbstractPlanNodeRef { auto p = plan; p = OptimizeMergeProjection(p); p = OptimizeMergeFilterNLJ(p); p = OptimizeNLJAsIndexJoin(p); p = OptimizeNLJAsHashJoin(p); // Enable this rule after you have implemented hash join. p = OptimizeOrderByAsIndexScan(p); p = OptimizeSortLimitAsTopN(p); // what we should add return p; } å¯ä»¥çœ‹åˆ°ï¼Œè®©æœªç»ä¼˜åŒ–çš„åŸå§‹ plan æ ‘ä¾æ¬¡ç»å†å¤šæ¡è§„åˆ™ï¼Œæ¥ç”Ÿæˆä¼˜åŒ–è¿‡çš„ planã€‚æˆ‘ä»¬çš„ä»»åŠ¡å°±æ˜¯æ–°å¢ä¸€æ¡è§„åˆ™ã€‚çœ‹çœ‹å…¶ä»–è§„åˆ™æ˜¯æ€ä¹ˆå®ç°çš„ï¼Œä¾‹å¦‚ NLJAsIndexJoinï¼š\nauto Optimizer::OptimizeNLJAsIndexJoin(const AbstractPlanNodeRef \u0026plan) -\u003e AbstractPlanNodeRef { std::vector\u003cAbstractPlanNodeRef\u003e children; for (const auto \u0026child : plan-\u003eGetChildren()) { children.emplace_back(OptimizeNLJAsIndexJoin(child)); } auto optimized_plan = plan-\u003eCloneWithChildren(std::move(children)); if (optimized_plan-\u003eGetType() == PlanType::NestedLoopJoin) { // apply the rule and return } return optimized_plan; } å¯ä»¥çœ‹åˆ°ï¼Œå®é™…ä¸Šå°±æ˜¯å¯¹ plan tree è¿›è¡Œååºéå†ï¼Œè‡ªåº•å‘ä¸Šåœ°é€‚ç”¨è§„åˆ™ï¼Œæ”¹å†™èŠ‚ç‚¹ã€‚éå†åˆ°æŸä¸ªèŠ‚ç‚¹æ—¶ï¼Œé€šè¿‡ if è¯­å¥æ¥åˆ¤æ–­å½“å‰èŠ‚ç‚¹çš„ç±»å‹æ˜¯å¦ç¬¦åˆæˆ‘ä»¬è¦ä¼˜åŒ–çš„ç±»å‹ï¼Œè‹¥ç¬¦åˆåˆ™è¿›è¡Œä¼˜åŒ–ã€‚\nå¤§è‡´äº†è§£å¦‚ä½•å¯¹ plan è¿›è¡Œä¼˜åŒ–åï¼Œå°±å¯ä»¥å¼€å§‹å†™æˆ‘ä»¬çš„ä¼˜åŒ–è§„åˆ™äº†ã€‚éœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼Œèƒ½ä¼˜åŒ–ä¸ºä¸€ä¸ª TopN ç®—å­çš„å½¢å¼æ˜¯ï¼Œä¸Šå±‚èŠ‚ç‚¹ä¸º Limitï¼Œä¸‹å±‚èŠ‚ç‚¹ä¸º Sortï¼Œä¸èƒ½åè¿‡æ¥ã€‚åŒæ ·ï¼Œæˆ‘ä»¬å¯¹ plan tree è¿›è¡Œåç»­éå†ï¼Œåœ¨é‡åˆ° Limit æ—¶ï¼Œåˆ¤æ–­å…¶ä¸‹å±‚èŠ‚ç‚¹æ˜¯å¦ä¸º Sortï¼Œè‹¥ä¸º Sortï¼Œåˆ™å°†è¿™ä¸¤ä¸ªèŠ‚ç‚¹æ›¿æ¢ä¸ºä¸€ä¸ª TopNã€‚è¿˜æ˜¯æ¯”è¾ƒå¥½å®ç°çš„ï¼Œåªæ˜¯ä»£ç çœ‹èµ·æ¥å¯èƒ½æœ‰ç‚¹å¤æ‚ã€‚\nLeaderboard Task æš‚æ—¶è¿˜æ²¡å†™ï¼Œæœ‰ç©ºäº†è¡¥è¡¥\nAC! Resources bustub on web è¯¾ç¨‹å®˜ç½‘ Github Repo Youtubeè¯¾ç¨‹è§†é¢‘ 2022fall ï¼ˆå¦‚æœå¯¹è‹±æ–‡å­—å¹•æœ‰å‹åŠ›çš„è¯å¯ä»¥åœ¨ chrome æ’ä»¶é‡Œä¸‹ä¸ªä¸­è‹±æ–‡åŒå­—å¹•æ’ä»¶ï¼‰ ",
  "wordCount" : "736",
  "inLanguage": "en",
  "image":"https://caaatch22.github.io/img/busTub/query_excution/architecture-overview.png","datePublished": "2023-01-17T23:45:12Z",
  "dateModified": "2023-01-17T23:45:12Z",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://caaatch22.github.io/posts/cmu15445-project3-query-execution/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Mingjie's Home",
    "logo": {
      "@type": "ImageObject",
      "url": "https://caaatch22.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://caaatch22.github.io/" accesskey="h" title="Mingjie&#39;s Home (Alt + H)">Mingjie&#39;s Home</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
                <ul class="lang-switch"><li>|</li>
                </ul>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://caaatch22.github.io/about/" title="About">
                    <span>About</span>
                </a>
            </li>
            <li>
                <a href="https://caaatch22.github.io/cv/" title="CV">
                    <span>CV</span>
                </a>
            </li>
            <li>
                <a href="https://caaatch22.github.io/archives/" title="Archives">
                    <span>Archives</span>
                </a>
            </li>
            <li>
                <a href="https://caaatch22.github.io/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://caaatch22.github.io/">Home</a>&nbsp;Â»&nbsp;<a href="https://caaatch22.github.io/posts/">Posts</a></div>
    <h1 class="post-title">
      CMU15445-project3 Query Excution
    </h1>
    <div class="post-meta">&lt;span title=&#39;2023-01-17 23:45:12 &#43;0000 UTC&#39;&gt;January 17, 2023&lt;/span&gt;&amp;nbsp;Â·&amp;nbsp;4 min

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">Table of Contents</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#overview" aria-label="Overview">Overview</a><ul>
                            
                    <li>
                        <a href="#parser" aria-label="Parser">Parser</a></li>
                    <li>
                        <a href="#binder" aria-label="Binder">Binder</a></li>
                    <li>
                        <a href="#planner" aria-label="Planner">Planner</a></li>
                    <li>
                        <a href="#optimizer" aria-label="Optimizer">Optimizer</a></li>
                    <li>
                        <a href="#executor" aria-label="Executor">Executor</a></li></ul>
                    </li>
                    <li>
                        <a href="#metadata" aria-label="Metadata">Metadata</a></li>
                    <li>
                        <a href="#task-1---access-method-executors" aria-label="Task #1 - Access Method Executors">Task #1 - Access Method Executors</a><ul>
                            
                    <li>
                        <a href="#seqscan" aria-label="SeqScan">SeqScan</a></li>
                    <li>
                        <a href="#insert--delete" aria-label="Insert &amp; Delete">Insert &amp; Delete</a></li>
                    <li>
                        <a href="#indexscan" aria-label="IndexScan">IndexScan</a></li></ul>
                    </li>
                    <li>
                        <a href="#task-2---aggregation--join-executors" aria-label="Task #2 - Aggregation &amp; Join Executors">Task #2 - Aggregation &amp; Join Executors</a><ul>
                            
                    <li>
                        <a href="#aggregation" aria-label="Aggregation">Aggregation</a></li>
                    <li>
                        <a href="#nestedloopjoin" aria-label="NestedLoopJoin">NestedLoopJoin</a></li>
                    <li>
                        <a href="#nestedindexjoin" aria-label="NestedIndexJoin">NestedIndexJoin</a></li></ul>
                    </li>
                    <li>
                        <a href="#task-3---sort--limit-executors-and-top-n-optimization" aria-label="Task #3 - Sort &#43; Limit Executors and Top-N Optimization">Task #3 - Sort + Limit Executors and Top-N Optimization</a><ul>
                            
                    <li>
                        <a href="#sort" aria-label="sort">sort</a></li>
                    <li>
                        <a href="#limit" aria-label="limit">limit</a></li>
                    <li>
                        <a href="#top-n-optimization-rule" aria-label="Top-N Optimization Rule">Top-N Optimization Rule</a></li>
                    <li>
                        <a href="#sort--limit-as-topn" aria-label="Sort &#43; Limit As TopN">Sort + Limit As TopN</a></li></ul>
                    </li>
                    <li>
                        <a href="#leaderboard-task" aria-label="Leaderboard Task">Leaderboard Task</a></li>
                    <li>
                        <a href="#resources" aria-label="Resources">Resources</a>
                    </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
         
         activeElement = elements[0];
         const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
         document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
     }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 && 
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
             const id = encodeURI(element.getAttribute('id')).toLowerCase();
             if (element === activeElement){
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
             } else {
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
             }
         })
     }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
</script>

  <div class="post-content"><h2 id="overview">Overview<a hidden class="anchor" aria-hidden="true" href="#overview">#</a></h2>
<blockquote>
<p>åœ¨è¿™æ¬¡å®éªŒå†™å®Œåï¼Œæˆ‘ä»¬å·²ç»èƒ½ä½¿ç”¨bustub-shellå®Œæˆæ‰§è¡Œ sql è¯­å¥äº†ï¼Œè¿˜æ˜¯æŒºæœ‰æˆå°±æ„Ÿçš„ã€‚åŒæ—¶ï¼ŒTA ä¸ºæˆ‘ä»¬å‡†å¤‡äº†<a href="https://15445.courses.cs.cmu.edu/fall2022/bustub/">æµè§ˆå™¨ä¸Šçš„bustub</a> ï¼Œæ–¹ä¾¿å’Œæˆ‘ä»¬å†™çš„å¯¹æ¯”è°ƒè¯•ã€‚ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ <code>explain</code> æ¥æŸ¥çœ‹ä»–çš„ä¼˜åŒ–ç­–ç•¥ä¸æ‰§è¡Œæ­¥éª¤ã€‚</p>
</blockquote>
<p>è¿™æ¬¡å®éªŒçš„ä¸»è¦éš¾ç‚¹åœ¨äºè¯»ä»£ç ï¼Œç†æ¸… bustub çš„æ‰§è¡Œå¼•æ“çš„æ•°æ®æµä»¥åŠä»£ç ä¸­çš„å®ç°ã€‚ææ‡‚äº†ä¹‹åå„ä¸ªç®—å­çš„å®ç°å°±å¾ˆç®€å•äº†ï¼ˆç›¸å¯¹ B+æ ‘ï¼‰ã€‚</p>
<p><img loading="lazy" src="/img/busTub/query_excution/project-structure.png" alt=""  />
</p>
<p>ä¸Šå›¾æ˜¯ bustub çš„æ•´ä½“æ¶æ„ã€‚</p>
<h3 id="parser">Parser<a hidden class="anchor" aria-hidden="true" href="#parser">#</a></h3>
<p>sql è¯­å¥çš„è§£æå°±åƒå…¶ä»–ç¼–ç¨‹è¯­è¨€ä¸€æ ·ï¼ŒåŒæ ·éœ€è¦ç¿»è¯‘æˆæ¯”è¾ƒç»“æ„åŒ–çš„ä¸œè¥¿ã€‚Parser é˜¶æ®µä¼šç”Ÿæˆä¸€ä¸ª<em>æŠ½è±¡è¯­æ³•æ ‘(AST, Abstract Syntax Tree)</em>ã€‚ è¿™å¹¶ä¸æ˜¯æ•°æ®åº“æ ¸å¿ƒéƒ¨åˆ†ï¼Œbustub ç›´æ¥ä½¿ç”¨äº† PostgreSQL çš„ parser åº“ libpg_queryã€‚</p>
<h3 id="binder">Binder<a hidden class="anchor" aria-hidden="true" href="#binder">#</a></h3>
<p>å¾—åˆ° AST åï¼Œéœ€è¦å°†è¿™äº›è¯è¯­ç»‘å®šåˆ°æ•°æ®åº“å®ä½“ä¸Šï¼Œè¿™å°±æ˜¯ Binder çš„å·¥ä½œã€‚ä¾‹å¦‚æœ‰è¿™æ ·ä¸€æ¡ sqlï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> table1.y, table2.x <span style="color:#66d9ef">FROM</span> table1 <span style="color:#66d9ef">INNER</span> <span style="color:#66d9ef">JOIN</span> table2 <span style="color:#66d9ef">ON</span> table1.x <span style="color:#f92672">=</span> table2.y;
</span></span></code></pre></div><p>å…¶ä¸­ <code>SELECT</code> å’Œ <code>FROM</code> æ˜¯å…³é”®å­—ï¼Œ<code>x</code> å’Œ <code>table1</code> æ˜¯æ ‡è¯†ç¬¦ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>explain</code> æ¥çœ‹çœ‹ <code>binder</code> å±‚ï¼ˆbustub-shell æœªå®Œæˆæ—¶ä¹Ÿå¯ä»¥ä½¿ç”¨ explainï¼‰ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span> <span style="color:#f92672">===</span> BINDER <span style="color:#f92672">===</span>                                               
</span></span><span style="display:flex;"><span> BoundSelec <span style="color:#f92672">{</span>                                        
</span></span><span style="display:flex;"><span>   table<span style="color:#f92672">=</span>BoundJoin <span style="color:#f92672">{</span> type<span style="color:#f92672">=</span>Inner, left<span style="color:#f92672">=</span>BoundBaseTableRef <span style="color:#f92672">{</span> table<span style="color:#f92672">=</span>table1, oid<span style="color:#f92672">=</span><span style="color:#ae81ff">25</span> <span style="color:#f92672">}</span>, right<span style="color:#f92672">=</span>BoundBaseTableRef <span style="color:#f92672">{</span> table<span style="color:#f92672">=</span>table2, oid<span style="color:#f92672">=</span><span style="color:#ae81ff">26</span> <span style="color:#f92672">}</span>, condition<span style="color:#f92672">=(</span>table1.x<span style="color:#f92672">=</span>table2.y<span style="color:#f92672">)</span> <span style="color:#f92672">}</span>, 
</span></span><span style="display:flex;"><span>   columns<span style="color:#f92672">=[</span>table1.y, table2.x<span style="color:#f92672">]</span>,                       
</span></span><span style="display:flex;"><span>   groupBy<span style="color:#f92672">=[]</span>,
</span></span><span style="display:flex;"><span>   having<span style="color:#f92672">=</span>,  
</span></span><span style="display:flex;"><span>   where<span style="color:#f92672">=</span>,  
</span></span><span style="display:flex;"><span>   limit<span style="color:#f92672">=</span>, 
</span></span><span style="display:flex;"><span>   offset<span style="color:#f92672">=</span>,
</span></span><span style="display:flex;"><span>   order_by<span style="color:#f92672">=[]</span>,                                 
</span></span><span style="display:flex;"><span>   is_distinct<span style="color:#f92672">=</span>false,         
</span></span><span style="display:flex;"><span>   ctes<span style="color:#f92672">=</span>,
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>å¯ä»¥çœ‹å‡ºï¼Œbinderçš„ä½œç”¨å°±æ˜¯å¯¹ASTçš„å„ä¸ªèŠ‚ç‚¹ç»‘å®šä¸€ä¸ªï¼ˆç‰©ç†ï¼‰å®ä½“ã€‚</p>
<h3 id="planner">Planner<a hidden class="anchor" aria-hidden="true" href="#planner">#</a></h3>
<p>å¾—åˆ° Bustub AST åï¼ŒPlanner éå†è¿™æ£µæ ‘ï¼Œç”Ÿæˆåˆæ­¥çš„æŸ¥è¯¢è®¡åˆ’ã€‚æŸ¥è¯¢è®¡åˆ’ä¹Ÿæ˜¯ä¸€æ£µæ ‘çš„å½¢å¼ã€‚ä¾‹å¦‚è¿™æ¡ sqlï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> table1.y, table2.x <span style="color:#66d9ef">FROM</span> table1 <span style="color:#66d9ef">INNER</span> <span style="color:#66d9ef">JOIN</span> table2 <span style="color:#66d9ef">ON</span> t1.x <span style="color:#f92672">=</span> t2.y;
</span></span></code></pre></div><p>æŸ¥çœ‹ explainï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span> <span style="color:#f92672">===</span> PLANNER <span style="color:#f92672">===</span>
</span></span><span style="display:flex;"><span> Projection <span style="color:#f92672">{</span> exprs<span style="color:#f92672">=[</span><span style="color:#75715e">#0.1, #0.2] } | (table1.y:INTEGER, table2.x:INTEGER)                                                                                            </span>
</span></span><span style="display:flex;"><span>   NestedLoopJoin <span style="color:#f92672">{</span> type<span style="color:#f92672">=</span>Inner, predicate<span style="color:#f92672">=(</span><span style="color:#75715e">#0.0=#1.1) } | (table1.x:INTEGER, table1.y:INTEGER, table2.x:INTEGER, table2.y:INTEGER)                                   </span>
</span></span><span style="display:flex;"><span>     SeqScan <span style="color:#f92672">{</span> table<span style="color:#f92672">=</span>table1 <span style="color:#f92672">}</span> | <span style="color:#f92672">(</span>table1.x:INTEGER, table1.y:INTEGER<span style="color:#f92672">)</span>                                                                                                 
</span></span><span style="display:flex;"><span>     SeqScan <span style="color:#f92672">{</span> table<span style="color:#f92672">=</span>table2 <span style="color:#f92672">}</span> | <span style="color:#f92672">(</span>table2.x:INTEGER, table2.y:INTEGER<span style="color:#f92672">)</span> 
</span></span></code></pre></div><p>ä¸Šé¢çš„è§£é‡Šå…¶å®æ˜¯æ ‘å‹çš„ï¼Œå¦‚ä¸‹å›¾ï¼š
<img loading="lazy" src="/img/busTub/query_excution/planner-tree.png" alt=""  />

æŸ¥è¯¢è®¡åˆ’è§„å®šäº†æ•°æ®çš„æµå‘ã€‚æ•°æ®ä»æ ‘å¶æµå‘æ ‘æ ¹ï¼Œè‡ªåº•å‘ä¸Šåœ°æµåŠ¨ï¼Œåœ¨æ ¹èŠ‚ç‚¹è¾“å‡ºç»“æœã€‚</p>
<h3 id="optimizer">Optimizer<a hidden class="anchor" aria-hidden="true" href="#optimizer">#</a></h3>
<p>ç”ŸæˆæŸ¥è¯¢è®¡åˆ’å
ç”± Planner å¾—åˆ°åˆæ­¥çš„æŸ¥è¯¢è®¡åˆ’åï¼Œå†å°†æŸ¥è¯¢è®¡åˆ’äº¤ç»™ Optimizer è¿›è¡Œä¿®æ”¹ä¼˜åŒ–ï¼Œç”Ÿæˆä¼˜åŒ–è¿‡åçš„æœ€ç»ˆæŸ¥è¯¢è®¡åˆ’ã€‚Optimizer ä¸»è¦æœ‰ä¸¤ç§å®ç°æ–¹å¼ï¼š</p>
<ul>
<li>Rule-based.
<ul>
<li>é€šè¿‡è‡ªåŠ¨é‡å†™æŸ¥è¯¢æ¥é¿å…æ•ˆç‡ä½çš„æ–¹æ³•ã€‚ä¾‹å¦‚æˆ‘ä»¬åœ¨ Task 3 ä¸­å°†è¦å®ç°çš„ï¼Œå°† <code>Limit + Sort</code> åˆå¹¶ä¸º <code>TopN</code>ã€‚</li>
<li>è¿™ç§ Optimizer ä¸éœ€è¦çŸ¥é“æ•°æ®çš„å…·ä½“å†…å®¹ï¼Œä»…æ˜¯æ ¹æ®é¢„å…ˆå®šä¹‰å¥½çš„è§„åˆ™ä¿®æ”¹ <code>Plan Node</code>ã€‚</li>
</ul>
</li>
<li>Cost-based.
<ul>
<li>ç”¨æŸç§æ¨¡å‹æ¥é¢„ä¼°æ‰§è¡Œè®¡åˆ’çš„æ—¶é—´ï¼Œè¿™å°±éœ€è¦å­˜å¾ˆå¤šè·Ÿæ•°æ®ç›¸å…³çš„æ•°æ®</li>
<li>é€šè¿‡å¯¹ä¸åŒæ¨¡å‹çš„ cost æ¯”è¾ƒé€‰å‡ºæ‰§è¡Œ cost æœ€å°çš„ã€‚</li>
<li>è¿™ä¹Ÿä¼šé€ æˆä¸€äº›é¢å¤–å¼€é”€ ï¼ˆè¿è¡Œè¿™ä¸ªcost modelï¼‰</li>
</ul>
</li>
</ul>
<p>Bustub çš„ Optimizer é‡‡ç”¨ç¬¬ä¸€ç§å®ç°æ–¹å¼ã€‚</p>
<blockquote>
<p>ä¸€èˆ¬æ¥è¯´ï¼ŒPlanner ç”Ÿæˆçš„æ˜¯ Logical Plan Nodeï¼Œä»£è¡¨æŠ½è±¡çš„ Planã€‚Optimizer åˆ™ç”Ÿæˆ Physical Plan Nodeï¼Œä»£è¡¨å…·ä½“æ‰§è¡Œçš„ Planã€‚ä¾‹å¦‚æ˜¯ Joinã€‚åœ¨ Planner ç”Ÿæˆçš„æŸ¥è¯¢è®¡åˆ’ä¸­ï¼ŒJoin å°±æ˜¯ Joinã€‚åœ¨ Optimizer ç”Ÿæˆçš„æŸ¥è¯¢è®¡åˆ’ä¸­ï¼ŒJoin ä¼šè¢«ä¼˜åŒ–æˆå…·ä½“çš„ HashJoin æˆ– NestedIndexJoin ç­‰ç­‰ã€‚åœ¨ Bustub ä¸­ï¼Œå¹¶ä¸åŒºåˆ† Logical Plan Node å’Œ Physical Plan Nodeã€‚Planner ä¼šç›´æ¥ç”Ÿæˆ Physical Plan Nodeã€‚</p>
</blockquote>
<h3 id="executor">Executor<a hidden class="anchor" aria-hidden="true" href="#executor">#</a></h3>
<p>åœ¨æ‹¿åˆ° Optimizer ç”Ÿæˆçš„å…·ä½“çš„æŸ¥è¯¢è®¡åˆ’åï¼Œå°±å¯ä»¥ç”ŸæˆçœŸæ­£æ‰§è¡ŒæŸ¥è¯¢è®¡åˆ’çš„ä¸€ç³»åˆ—ç®—å­äº†ã€‚ç®—å­ä¹Ÿæ˜¯æˆ‘ä»¬åœ¨ Project 3 ä¸­éœ€è¦å®ç°çš„ä¸»è¦å†…å®¹ã€‚ç”Ÿæˆç®—å­çš„æ­¥éª¤å¾ˆç®€å•ï¼Œéå†æŸ¥è¯¢è®¡åˆ’æ ‘ï¼Œå°†æ ‘ä¸Šçš„ PlanNode æ›¿æ¢æˆå¯¹åº”çš„ Executorã€‚ç®—å­çš„æ‰§è¡Œæ¨¡å‹ä¹Ÿå¤§è‡´åˆ†ä¸ºä¸‰ç§ï¼š</p>
<ol>
<li>
<p>Iterator/Pipeline Model(volcano model)ã€‚æ¯ä¸ªç®—å­éƒ½æœ‰ Init() å’Œ Next() ä¸¤ä¸ªæ–¹æ³•ã€‚Init() å¯¹ç®—å­è¿›è¡Œåˆå§‹åŒ–å·¥ä½œã€‚Next() åˆ™æ˜¯å‘ä¸‹å±‚ç®—å­è¯·æ±‚ä¸‹ä¸€æ¡æ•°æ®ã€‚å½“ Next() è¿”å› false æ—¶ï¼Œåˆ™ä»£è¡¨ä¸‹å±‚ç®—å­å·²ç»æ²¡æœ‰å‰©ä½™æ•°æ®ï¼Œè¿­ä»£ç»“æŸã€‚ç«å±±æ¨¡å‹ä¸€æ¬¡è°ƒç”¨åªå‘ä¸‹å±‚ç®—å­è¯·æ±‚ä¸€æ¡æ•°æ®ï¼Œå ç”¨å†…å­˜è¾ƒå°ï¼Œä½†å‡½æ•°è°ƒç”¨å¼€é”€å¤§ã€‚ <img loading="lazy" src="/img/busTub/query_excution/iterator-model.png" alt=""  />
</p>
</li>
<li>
<p>Materialization Model. æ‰€æœ‰ç®—å­ç«‹å³è®¡ç®—å‡ºæ‰€æœ‰ç»“æœå¹¶è¿”å›ã€‚å’Œ Iterator Model ç›¸åã€‚è¿™ç§æ¨¡å‹çš„å¼Šç«¯æ˜¾è€Œæ˜“è§ï¼Œå½“æ•°æ®é‡è¾ƒå¤§æ—¶ï¼Œå†…å­˜å ç”¨å¾ˆé«˜ï¼Œä½†å‡å°‘äº†å‡½æ•°è°ƒç”¨çš„å¼€é”€ã€‚æ¯”è¾ƒé€‚åˆæŸ¥è¯¢æ•°æ®é‡è¾ƒå°çš„ OLTP workloadsã€‚</p>
</li>
<li>
<p>Vectorized/Batch Model. å¯¹ä¸Šé¢ä¸¤ç§æ¨¡å‹çš„ä¸­å’Œï¼Œä¸€æ¬¡è°ƒç”¨è¿”å›ä¸€æ‰¹æ•°æ®ã€‚åˆ©äº SIMD åŠ é€Ÿã€‚ç›®å‰æ¯”è¾ƒå…ˆè¿›çš„ OLAP æ•°æ®åº“é‡‡ç”¨è¿™ç§æ¨¡å‹ã€‚</p>
</li>
</ol>
<p>Bustub é‡‡ç”¨ Iterator Modelã€‚</p>
<h2 id="metadata">Metadata<a hidden class="anchor" aria-hidden="true" href="#metadata">#</a></h2>
<p>ä¸Šé¢ä»‹ç»äº† sqlè¯­å¥æ‰§è¡Œè¿‡ç¨‹ï¼Œè¶³ä»¥è®©æˆ‘ä»¬å¯¹æ•´ä¸ªæ‰§è¡Œå¼•æ“æœ‰å¤§ä½“äº†è§£ã€‚ä½†æ˜¯æˆ‘åœ¨åšè¿™ä¸ª lab æ—¶å€™è¿˜æ˜¯æœ‰å¾ˆå¤šå›°æƒ‘çš„åœ°æ–¹ã€‚æœ€åæ˜¯è¿·è¿·ç³Šç³Šçš„å†™å®Œäº†æ‰æ•´ç†äº†ä¸‹ã€‚å¤§ä½“ä¸Šçš„ä¿¡æ¯åŒ…æ‹¬åœ¨ä¸‹å›¾ä¸­ï¼š
<img loading="lazy" src="/img/busTub/query_excution/table-matedata.png" alt=""  />

ï¼ˆå›¾ç‰‡æ”¹è‡ª<a href="https://blog.eleven.wiki/posts/cmu15-445-project3-query-execution/">è¿™ç¯‡åšå®¢</a>ï¼‰</p>
<h2 id="task-1---access-method-executors">Task #1 - Access Method Executors<a hidden class="anchor" aria-hidden="true" href="#task-1---access-method-executors">#</a></h2>
<h3 id="seqscan">SeqScan<a hidden class="anchor" aria-hidden="true" href="#seqscan">#</a></h3>
<p>å®ç°æ¯”è¾ƒç®€å•ï¼Œè·å– table_iter ç›´æ¥éå†å³å¯ã€‚è¿™é‡Œè¯´è¯´è¿™ä¸ª<code>plan_-&gt;filter_predicate_</code>ï¼Œ ä»–æ˜¯ä¸€ä¸ª<code>AbstractExpressionRef</code>ï¼Œè€Œä¸€ä¸ª<code>AbstractExpression</code>æ„æ€æ˜¯ä¸€ä¸ª <em>è¡¨è¾¾å¼</em> ï¼Œä»–é‡Œé¢æœ€é‡è¦çš„ä¸¤ä¸ªå‡½æ•°æ˜¯ <code>Evaluate(const Tuple *tuple, const Schema &amp;schema)</code>å’Œ <code>EvaluateJoin(const Tuple *left_tuple, const Schema &amp;left_schema, const Tuple *right_tuple, const Schema &amp;right_schema)</code>ï¼Œä¸»è¦å°±æ˜¯ç”¨æ¥åš filter çš„ã€‚ä¾‹å¦‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> table1 <span style="color:#66d9ef">where</span> x <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span></code></pre></div><p>å¦‚æœä»»ä½•ä¼˜åŒ–éƒ½æ²¡æœ‰ï¼Œé‚£ä¹ˆä¸Šè¿°è¯­å¥å¯ä»¥è§£æä¸ºä¸¤å±‚ï¼š</p>
<ol>
<li>ä» table1 ä¸­é€‰å‡ºæ‰€æœ‰çš„ tupleã€‚</li>
<li>é€‰å‡º x = 1çš„ tupleã€‚ç›¸å½“äºåº•ä¸‹çš„ seqscan ç»“ç‚¹ä¼šå°†æ‰€æœ‰ tuple å‘åˆ°ä¸Šä¸€å±‚ï¼Œç„¶åä¸Šä¸€å±‚å†åšä¸€æ¬¡ filterã€‚ä½†æ˜¯æˆ‘ä»¬é€šè¿‡è°“è¯ä¸‹æ¨ï¼Œå¯ä»¥åœ¨seqscan æ—¶å€™å°±é€šè¿‡ filter_predicate_ å°†éœ€è¦çš„è¿‡æ»¤å‡ºæ¥ï¼Œä¸éœ€è¦çš„ä¸ç”¨å‘ç»™ä¸Šä¸€å±‚ã€‚ï¼ˆå½“ç„¶ï¼Œè¿™ä¸ªä¾‹å­ä¸å¤ªå‡†ç¡®ã€‚åœ¨è¿™ä¸ªæƒ…å†µä¸‹æœ¬æ¥å°±æ˜¯ä¸€æ¬¡æå®šçš„ï¼Œæ€»ä¹‹æ˜¯åœ¨å¤æ‚çš„æ—¶å€™å¯ä»¥æŠŠè°“è¯ä¸‹æ¨ï¼‰ã€‚
è¿™ä¸ª Evaluate è¿”å›ä¸€ä¸ª <code>Value</code>ï¼Œå®é™…ä¸Šå¦‚æœåšfilteråº”è¯¥è¿”å› booleanï¼Œæ‰€ä»¥éœ€è¦é€šè¿‡<code>filter_predicate_-&gt;Evaluate(tuple, table_info_-&gt;schema_).GetAs&lt;bool&gt;()</code>è½¬åŒ–ä¸€ä¸‹ã€‚
å¦å¤–ï¼Œseqscan å®é™…ä¸Šä¸ä¼šç”¨åˆ° filter_predicateã€‚åé¢é‡åˆ°éœ€è¦ predicate çš„åœ°æ–¹ä¼šå†å¼ºè°ƒã€‚</li>
</ol>
<h3 id="insert--delete">Insert &amp; Delete<a hidden class="anchor" aria-hidden="true" href="#insert--delete">#</a></h3>
<p>è¿™ä¸¤ä¸ªç®—å­æ˜¯å”¯äºŒçš„å†™ç®—å­ï¼ˆå®é™…ä¸Šåé¢çš„ä¼˜åŒ–è¿‡ç¨‹ä¸­éœ€è¦å®ç°ä¸€ä¸ª updateç®—å­ï¼‰ã€‚</p>
<p>æˆ‘ä»¬å…ˆçœ‹ä¸‹è¿™ä¸¤ä¸ªç®—å­çš„è¡Œä¸ºï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>bustub<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">insert</span> <span style="color:#66d9ef">into</span> t1 <span style="color:#66d9ef">values</span> (<span style="color:#ae81ff">0</span>, <span style="color:#e6db74">&#39;ğŸ¥°&#39;</span>, <span style="color:#ae81ff">10</span>), (<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#39;ğŸ¥°ğŸ¥°&#39;</span>, <span style="color:#ae81ff">11</span>), (<span style="color:#ae81ff">2</span>, <span style="color:#e6db74">&#39;ğŸ¥°ğŸ¥°ğŸ¥°&#39;</span>, <span style="color:#ae81ff">12</span>), (<span style="color:#ae81ff">3</span>, <span style="color:#e6db74">&#39;ğŸ¥°ğŸ¥°ğŸ¥°ğŸ¥°&#39;</span>, <span style="color:#ae81ff">13</span>), (<span style="color:#ae81ff">4</span>, <span style="color:#e6db74">&#39;ğŸ¥°ğŸ¥°ğŸ¥°ğŸ¥°&#39;</span>, <span style="color:#ae81ff">14</span>);
</span></span><span style="display:flex;"><span><span style="color:#f92672">//</span> <span style="color:#66d9ef">output</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#75715e">-------------------------------+
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">|</span> __bustub_internal.insert_rows <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#75715e">-------------------------------+
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">|</span> <span style="color:#ae81ff">5</span>                             <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#75715e">-------------------------------+
</span></span></span></code></pre></div><p>è¿™ä¸¤ä¸ªç®—å­ä»–ä»¬ä¼šä¸€ç›´ nextï¼Œç„¶åè¿”å›ä¸€æ¬¡ï¼Œè¿”å›çš„æ˜¯æ’å…¥/åˆ é™¤ tuple çš„ä¸ªæ•°ï¼ˆæ‰€ç”Ÿæˆçš„tupleï¼‰ã€‚æœ‰ç‚¹åƒ <code>pipeline breaker</code>ï¼Œä½†æ˜¯ç”±äºä»–ä»¬ä¸€å®šæ˜¯é¡¶å±‚ç®—å­ï¼Œæ‰€ä»¥å¥½åƒä¸å« <code>pipeline breaker</code>ã€‚</p>
<p>ä¸ªäººæ„Ÿè§‰è¿™ä¸ªè¿”å›ä¸ªæ•°çš„è®¾è®¡æœ‰ç‚¹ä¸æ˜¯å¾ˆåˆç†ï¼Œå®ƒä¸€å®šè¦å°†ä¸ªæ•°è½¬åŒ–æˆä¸€ä¸ªtupleè¿”å›ã€‚å¤§æ¦‚æ˜¯è¿™æ ·çš„æ“ä½œã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>  <span style="color:#f92672">*</span>tuple <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>      Tuple(std<span style="color:#f92672">::</span>vector<span style="color:#f92672">&lt;</span>Value<span style="color:#f92672">&gt;</span>(GetOutputSchema().GetColumnCount() <span style="color:#75715e">/* ColumnCount() should be one*/</span>, Value(TypeId<span style="color:#f92672">::</span>INTEGER, counter)),
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&amp;</span>GetOutputSchema());
</span></span></code></pre></div><p>å¦å¤–éœ€è¦æ³¨æ„çš„å°±æ˜¯è¿™äº› å¢åŠ /åˆ é™¤ tuple æ—¶ï¼Œå¯¹åº”çš„ç´¢å¼•é¡¹ä¹Ÿéœ€è¦å¢åŠ /åˆ é™¤ã€‚</p>
<h3 id="indexscan">IndexScan<a hidden class="anchor" aria-hidden="true" href="#indexscan">#</a></h3>
<p>è¿™ä¸ªå°±ç®€å•äº†ï¼Œåœ¨ Init() æ—¶å€™ä¿å­˜ index_iterï¼Œ next() æ—¶ç›´æ¥è°ƒç”¨å†è‡ªå¢å°±å¯ä»¥ã€‚</p>
<h2 id="task-2---aggregation--join-executors">Task #2 - Aggregation &amp; Join Executors<a hidden class="anchor" aria-hidden="true" href="#task-2---aggregation--join-executors">#</a></h2>
<h3 id="aggregation">Aggregation<a hidden class="anchor" aria-hidden="true" href="#aggregation">#</a></h3>
<p>aggregation æ“ä½œæ˜¯ä¸€ä¸ª <code>pipeline breaker</code>ã€‚ä»–ä¼šåœ¨ init å¾—åˆ°å…¨éƒ¨ç­”æ¡ˆç„¶åå† next æ—¶ä¸€æ¡ä¸€æ¡è¿”å›ã€‚</p>
<p><code>SimpleAggregationHashTable</code> ç»´æŠ¤ä¸€å¼ å“ˆå¸Œè¡¨ï¼Œé”®ä¸º <code>AggregateKey</code>ï¼Œå€¼ä¸º <code>AggregateValue</code>ï¼Œå‡ä¸º <code>std::vector&lt;Value&gt;</code>ã€‚key ä»£è¡¨ group by çš„å­—æ®µçš„æ•°ç»„ï¼Œvalue åˆ™æ˜¯éœ€è¦ aggregate çš„å­—æ®µçš„æ•°ç»„ã€‚åœ¨ä¸‹å±‚ç®—å­ä¼ æ¥ä¸€ä¸ª tuple æ—¶ï¼Œå°† tuple çš„ group by å­—æ®µå’Œ aggregate å­—æ®µåˆ†åˆ«æå–å‡ºæ¥ï¼Œè°ƒç”¨ <code>InsertCombine()</code> å°† group by å’Œ aggregate çš„æ˜ å°„å…³ç³»å­˜å…¥ <code>SimpleAggregationHashTable</code>ã€‚è‹¥å½“å‰ hashmap ä¸­æ²¡æœ‰ group by çš„è®°å½•ï¼Œåˆ™åˆ›å»ºåˆå€¼ï¼›è‹¥å·²æœ‰è®°å½•ï¼Œåˆ™æŒ‰ aggregate è§„åˆ™é€ä¸€æ›´æ–°æ‰€æœ‰çš„ aggregate å­—æ®µï¼Œä¾‹å¦‚å– max/minï¼Œæ±‚ sum ç­‰ç­‰ã€‚ä¾‹å¦‚ä¸‹é¢è¿™æ¡ sqlï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> <span style="color:#66d9ef">min</span>(t.z), <span style="color:#66d9ef">max</span>(t.z), <span style="color:#66d9ef">sum</span>(t.z) <span style="color:#66d9ef">FROM</span> t <span style="color:#66d9ef">GROUP</span> <span style="color:#66d9ef">BY</span> t.x, t.y;
</span></span></code></pre></div><p>group byï¼ˆAggregateKeyï¼‰ä¸º {t.x, t.y}ï¼Œaggregateï¼ˆAggregateValueï¼‰ä¸º {t.z, t.z, t.z}ã€‚aggregate è§„åˆ™ä¸º {min, max, sum}ã€‚</p>
<p>éœ€è¦é¢å¤–æ³¨æ„ <code>count(column)</code> å’Œ <code>count(*)</code> çš„åŒºåˆ«ï¼Œä»¥åŠå¯¹ç©ºå€¼çš„å¤„ç†ã€‚</p>
<p>åœ¨ Init() ä¸­è®¡ç®—å‡ºæ•´å¼  hashmap åï¼Œåœ¨ Next() ä¸­ç›´æ¥åˆ©ç”¨ hashmap iterator å°†ç»“æœä¾æ¬¡å–å‡ºã€‚è¿™é‡Œçš„è¾“å‡ºå½¢å¼æœ‰ç‚¹å¥‡æ€ªï¼Œéœ€è¦è¿™æ ·çš„è¾“å‡ºï¼š
<img loading="lazy" src="/img/busTub/query_excution/aggregate-return.png" alt=""  />
</p>
<p><code>schema</code> å·²ç»åœ¨ <code>GetOutputSchema()</code> ä¸­å‡†å¤‡å¥½äº†ã€‚</p>
<h3 id="nestedloopjoin">NestedLoopJoin<a hidden class="anchor" aria-hidden="true" href="#nestedloopjoin">#</a></h3>
<p>æˆ‘çš„å®ç°æ¯”è¾ƒ trickyã€‚æˆ‘åœ¨ init æ—¶å€™ç›´æ¥æŠŠä¸‹å±‚ç®—å­ï¼ˆleft_executorå’Œright_executorï¼‰æ‰€æœ‰çš„tupleéƒ½å¾—åˆ°äº†ï¼ˆç›¸å½“äºå½“ä½œ pipeline breakerï¼‰ï¼Œä¿å­˜åœ¨ä¸¤å¼ è¡¨ä¸­ã€‚å† nextæ—¶å€™è¿›è¡ŒåŒ¹é…ã€‚è¿™é‡Œçš„ left-join å’Œ inner-join æ˜¯éœ€è¦åˆ†å¼€å®ç°çš„ï¼Œå¯ä»¥åœ¨ç½‘ä¸ŠæŸ¥ä¸‹left-joinå’Œinner-joinçš„åŒºåˆ«ã€‚
åœ¨è¿™é‡Œåˆ¤æ–­å·¦å³ä¸¤ä¸ª tuple æ˜¯å¦ match å°±éœ€è¦ç”¨åˆ°<code>plan_-&gt;Predicate().EvaluateJoin()</code>ï¼ŒåŒæ ·è¦ <code>GetAs&lt;bool&gt;()</code>ã€‚</p>
<p>å½“æˆ‘ä»¬å¾—åˆ°ä¸€ä¸ª match åï¼Œè¿”å›å‰è®°å¾—<strong>ä¿å­˜ä¸Šä¸‹æ–‡</strong>ï¼Œä¾‹å¦‚ï¼Œä½ å¯ä»¥ä¿å­˜ match çš„ tuple å†å·¦è¡¨ä¸­çš„ä¸‹æ ‡å’Œå³è¡¨ä¸­çš„ä¸‹æ ‡ï¼Œè¿™æ ·ä¸‹æ¬¡è°ƒç”¨ next æ—¶å€™ï¼Œå°±ä¸ç”¨é‡æ–°æ‰«æä¸€æ¬¡ã€‚</p>
<h3 id="nestedindexjoin">NestedIndexJoin<a hidden class="anchor" aria-hidden="true" href="#nestedindexjoin">#</a></h3>
<p>åœ¨è¿›è¡Œ equi-join æ—¶ï¼Œå¦‚æœå‘ç° JOIN ON å³è¾¹çš„å­—æ®µä¸Šå»ºäº† indexï¼Œåˆ™ Optimizer ä¼šå°† NestedLoopJoin ä¼˜åŒ–ä¸º NestedIndexJoinã€‚å…·ä½“å®ç°å’Œ NestedLoopJoin å·®ä¸å¤šï¼Œåªæ˜¯åœ¨å°è¯•åŒ¹é…å³è¡¨ tuple æ—¶ï¼Œä¼šæ‹¿ join key å» B+Tree Index é‡Œè¿›è¡ŒæŸ¥è¯¢ã€‚å¦‚æœæŸ¥è¯¢åˆ°ç»“æœï¼Œå°±æ‹¿ç€æŸ¥åˆ°çš„ RID å»å³è¡¨è·å– tuple ç„¶åè£…é…æˆç»“æœè¾“å‡ºã€‚</p>
<h2 id="task-3---sort--limit-executors-and-top-n-optimization">Task #3 - Sort + Limit Executors and Top-N Optimization<a hidden class="anchor" aria-hidden="true" href="#task-3---sort--limit-executors-and-top-n-optimization">#</a></h2>
<h3 id="sort">sort<a hidden class="anchor" aria-hidden="true" href="#sort">#</a></h3>
<p>è¿™ä¸ªå®éªŒçš„ sort æ— éœ€è¿›è¡Œå¤–éƒ¨æ’åºï¼Œé‡è½½å°äºåå°±å¯ä»¥å®ç°ã€‚å°±æ˜¯æ¯”è¾ƒçš„æ–¹å¼æœ‰ç‚¹å¥‡æ€ªï¼Œå¯ä»¥ç±»æ¯”ä»¥ä¸‹å†™ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>order_key.second<span style="color:#f92672">-&gt;</span>Evaluate(<span style="color:#f92672">&amp;</span>lhs, schema).CompareLessThan(order_key.second<span style="color:#f92672">-&gt;</span>Evaluate(<span style="color:#f92672">&amp;</span>rhs, schema))
</span></span></code></pre></div><h3 id="limit">limit<a hidden class="anchor" aria-hidden="true" href="#limit">#</a></h3>
<p>ç®€å•ï¼Œlimit é™åˆ¶åœ¨ <code>plan_-&gt;Getlimit()</code>é‡Œé¢ã€‚</p>
<h3 id="top-n-optimization-rule">Top-N Optimization Rule<a hidden class="anchor" aria-hidden="true" href="#top-n-optimization-rule">#</a></h3>
<p>ç®€å•ï¼Œä¼˜å…ˆé˜Ÿåˆ—é‡è½½å°äºï¼ˆé‡è½½æ–¹å¼ä¸ sort ç›¸åŒï¼‰ï¼Œç„¶åæˆªå–å‰ n ä¸ªã€‚</p>
<h3 id="sort--limit-as-topn">Sort + Limit As TopN<a hidden class="anchor" aria-hidden="true" href="#sort--limit-as-topn">#</a></h3>
<p>è¿™æ˜¯ Project 3 é‡Œæœ€åä¸€ä¸ªå¿…åšçš„å°é—®ï¼Œä¹Ÿæ˜¯å”¯ä¸€ä¸€ä¸ª Optimizer ï¼Œå°† Sort + Limit ä¼˜åŒ–ä¸º TopNã€‚å…ˆçœ‹çœ‹ Optimizer æ˜¯å¦‚ä½•æ‰§è¡Œä¼˜åŒ–è§„åˆ™çš„ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">auto</span> Optimizer<span style="color:#f92672">::</span>OptimizeCustom(<span style="color:#66d9ef">const</span> AbstractPlanNodeRef <span style="color:#f92672">&amp;</span>plan) <span style="color:#f92672">-&gt;</span> AbstractPlanNodeRef {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">auto</span> p <span style="color:#f92672">=</span> plan;
</span></span><span style="display:flex;"><span>  p <span style="color:#f92672">=</span> OptimizeMergeProjection(p);
</span></span><span style="display:flex;"><span>  p <span style="color:#f92672">=</span> OptimizeMergeFilterNLJ(p);
</span></span><span style="display:flex;"><span>  p <span style="color:#f92672">=</span> OptimizeNLJAsIndexJoin(p);
</span></span><span style="display:flex;"><span>  p <span style="color:#f92672">=</span> OptimizeNLJAsHashJoin(p);  <span style="color:#75715e">// Enable this rule after you have implemented hash join.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  p <span style="color:#f92672">=</span> OptimizeOrderByAsIndexScan(p);
</span></span><span style="display:flex;"><span>  p <span style="color:#f92672">=</span> OptimizeSortLimitAsTopN(p);  <span style="color:#75715e">// what we should add
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">return</span> p;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>å¯ä»¥çœ‹åˆ°ï¼Œè®©æœªç»ä¼˜åŒ–çš„åŸå§‹ plan æ ‘ä¾æ¬¡ç»å†å¤šæ¡è§„åˆ™ï¼Œæ¥ç”Ÿæˆä¼˜åŒ–è¿‡çš„ planã€‚æˆ‘ä»¬çš„ä»»åŠ¡å°±æ˜¯æ–°å¢ä¸€æ¡è§„åˆ™ã€‚çœ‹çœ‹å…¶ä»–è§„åˆ™æ˜¯æ€ä¹ˆå®ç°çš„ï¼Œä¾‹å¦‚ NLJAsIndexJoinï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">auto</span> Optimizer<span style="color:#f92672">::</span>OptimizeNLJAsIndexJoin(<span style="color:#66d9ef">const</span> AbstractPlanNodeRef <span style="color:#f92672">&amp;</span>plan) <span style="color:#f92672">-&gt;</span> AbstractPlanNodeRef {
</span></span><span style="display:flex;"><span>  std<span style="color:#f92672">::</span>vector<span style="color:#f92672">&lt;</span>AbstractPlanNodeRef<span style="color:#f92672">&gt;</span> children;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">auto</span> <span style="color:#f92672">&amp;</span>child : plan<span style="color:#f92672">-&gt;</span>GetChildren()) {
</span></span><span style="display:flex;"><span>    children.emplace_back(OptimizeNLJAsIndexJoin(child));
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">auto</span> optimized_plan <span style="color:#f92672">=</span> plan<span style="color:#f92672">-&gt;</span>CloneWithChildren(std<span style="color:#f92672">::</span>move(children));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (optimized_plan<span style="color:#f92672">-&gt;</span>GetType() <span style="color:#f92672">==</span> PlanType<span style="color:#f92672">::</span>NestedLoopJoin) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// apply the rule and return
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> optimized_plan;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>å¯ä»¥çœ‹åˆ°ï¼Œå®é™…ä¸Šå°±æ˜¯å¯¹ plan tree è¿›è¡Œååºéå†ï¼Œè‡ªåº•å‘ä¸Šåœ°é€‚ç”¨è§„åˆ™ï¼Œæ”¹å†™èŠ‚ç‚¹ã€‚éå†åˆ°æŸä¸ªèŠ‚ç‚¹æ—¶ï¼Œé€šè¿‡ if è¯­å¥æ¥åˆ¤æ–­å½“å‰èŠ‚ç‚¹çš„ç±»å‹æ˜¯å¦ç¬¦åˆæˆ‘ä»¬è¦ä¼˜åŒ–çš„ç±»å‹ï¼Œè‹¥ç¬¦åˆåˆ™è¿›è¡Œä¼˜åŒ–ã€‚</p>
<p>å¤§è‡´äº†è§£å¦‚ä½•å¯¹ plan è¿›è¡Œä¼˜åŒ–åï¼Œå°±å¯ä»¥å¼€å§‹å†™æˆ‘ä»¬çš„ä¼˜åŒ–è§„åˆ™äº†ã€‚éœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼Œèƒ½ä¼˜åŒ–ä¸ºä¸€ä¸ª TopN ç®—å­çš„å½¢å¼æ˜¯ï¼Œä¸Šå±‚èŠ‚ç‚¹ä¸º Limitï¼Œä¸‹å±‚èŠ‚ç‚¹ä¸º Sortï¼Œä¸èƒ½åè¿‡æ¥ã€‚åŒæ ·ï¼Œæˆ‘ä»¬å¯¹ plan tree è¿›è¡Œåç»­éå†ï¼Œåœ¨é‡åˆ° Limit æ—¶ï¼Œåˆ¤æ–­å…¶ä¸‹å±‚èŠ‚ç‚¹æ˜¯å¦ä¸º Sortï¼Œè‹¥ä¸º Sortï¼Œåˆ™å°†è¿™ä¸¤ä¸ªèŠ‚ç‚¹æ›¿æ¢ä¸ºä¸€ä¸ª TopNã€‚è¿˜æ˜¯æ¯”è¾ƒå¥½å®ç°çš„ï¼Œåªæ˜¯ä»£ç çœ‹èµ·æ¥å¯èƒ½æœ‰ç‚¹å¤æ‚ã€‚</p>
<h2 id="leaderboard-task">Leaderboard Task<a hidden class="anchor" aria-hidden="true" href="#leaderboard-task">#</a></h2>
<p>æš‚æ—¶è¿˜æ²¡å†™ï¼Œæœ‰ç©ºäº†è¡¥è¡¥</p>
<p><strong>AC!</strong>
<img loading="lazy" src="/img/busTub/query_excution/p3-result.png" alt=""  />
</p>
<h2 id="resources">Resources<a hidden class="anchor" aria-hidden="true" href="#resources">#</a></h2>
<ul>
<li><a href="https://15445.courses.cs.cmu.edu/fall2022/bustub/">bustub on web</a></li>
<li><a href="https://15445.courses.cs.cmu.edu/fall2022">è¯¾ç¨‹å®˜ç½‘</a></li>
<li><a href="https://github.com/cmu-db/bustub">Github Repo</a></li>
<li><a href="https://www.youtube.com/watch?v=uikbtpVZS2s&amp;list=PLSE8ODhjZXjaKScG3l0nuOiDTTqpfnWFf&amp;ab_channel=CMUDatabaseGroup">Youtubeè¯¾ç¨‹è§†é¢‘ 2022fall</a> ï¼ˆå¦‚æœå¯¹è‹±æ–‡å­—å¹•æœ‰å‹åŠ›çš„è¯å¯ä»¥åœ¨ chrome æ’ä»¶é‡Œä¸‹ä¸ªä¸­è‹±æ–‡åŒå­—å¹•æ’ä»¶ï¼‰</li>
</ul>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://caaatch22.github.io/tags/database/">Database</a></li>
      <li><a href="https://caaatch22.github.io/tags/cmu15445/">Cmu15445</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://caaatch22.github.io/posts/%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84%E7%BD%91%E7%BB%9C%E5%BA%93-httpserver/">
    <span class="title">Â« Prev</span>
    <br>
    <span>è½»é‡çº§é«˜å¹¶å‘ç½‘ç»œåº“&#43;httpserver</span>
  </a>
  <a class="next" href="https://caaatch22.github.io/posts/%E7%AE%97%E6%B3%95%E7%AB%9E%E8%B5%9B%E4%B8%AD%E7%9A%84wavelet-tree/">
    <span class="title">Next Â»</span>
    <br>
    <span>å°†Wavelet Treeç”¨äºç®—æ³•ç«èµ›</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2024 <a href="https://caaatch22.github.io/">Mingjie&#39;s Home</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
