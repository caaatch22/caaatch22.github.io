<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/">
  <channel>
    <title>Database on Mingjie&#39;s Home</title>
    <link>https://caaatch22.github.io/tags/database/</link>
    <description>Recent content in Database on Mingjie&#39;s Home</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>zh-cn</language>
    <lastBuildDate>Tue, 17 Jan 2023 23:45:12 +0000</lastBuildDate><atom:link href="https://caaatch22.github.io/tags/database/index.xml" rel="self" type="application/rss+xml" />
    <item>
      <title>CMU15445-project3 Query Excution</title>
      <link>https://caaatch22.github.io/posts/cmu15445-project3-query-execution/</link>
      <pubDate>Tue, 17 Jan 2023 23:45:12 +0000</pubDate>
      
      <guid>https://caaatch22.github.io/posts/cmu15445-project3-query-execution/</guid>
      <description>&lt;h2 id=&#34;overview&#34;&gt;Overview&lt;/h2&gt;
&lt;blockquote&gt;
&lt;p&gt;åœ¨è¿™æ¬¡å®éªŒå†™å®Œåï¼Œæˆ‘ä»¬å·²ç»èƒ½ä½¿ç”¨bustub-shellå®Œæˆæ‰§è¡Œ sql è¯­å¥äº†ï¼Œè¿˜æ˜¯æŒºæœ‰æˆå°±æ„Ÿçš„ã€‚åŒæ—¶ï¼ŒTA ä¸ºæˆ‘ä»¬å‡†å¤‡äº†&lt;a href=&#34;https://15445.courses.cs.cmu.edu/fall2022/bustub/&#34;&gt;æµè§ˆå™¨ä¸Šçš„bustub&lt;/a&gt; ï¼Œæ–¹ä¾¿å’Œæˆ‘ä»¬å†™çš„å¯¹æ¯”è°ƒè¯•ã€‚ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ &lt;code&gt;explain&lt;/code&gt; æ¥æŸ¥çœ‹ä»–çš„ä¼˜åŒ–ç­–ç•¥ä¸æ‰§è¡Œæ­¥éª¤ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;è¿™æ¬¡å®éªŒçš„ä¸»è¦éš¾ç‚¹åœ¨äºè¯»ä»£ç ï¼Œç†æ¸… bustub çš„æ‰§è¡Œå¼•æ“çš„æ•°æ®æµä»¥åŠä»£ç ä¸­çš„å®ç°ã€‚ææ‡‚äº†ä¹‹åå„ä¸ªç®—å­çš„å®ç°å°±å¾ˆç®€å•äº†ï¼ˆç›¸å¯¹ B+æ ‘ï¼‰ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; src=&#34;https://caaatch22.github.io/img/busTub/query_excution/project-structure.png&#34; alt=&#34;&#34;  /&gt;
&lt;/p&gt;
&lt;p&gt;ä¸Šå›¾æ˜¯ bustub çš„æ•´ä½“æ¶æ„ã€‚&lt;/p&gt;
&lt;h3 id=&#34;parser&#34;&gt;Parser&lt;/h3&gt;
&lt;p&gt;sql è¯­å¥çš„è§£æå°±åƒå…¶ä»–ç¼–ç¨‹è¯­è¨€ä¸€æ ·ï¼ŒåŒæ ·éœ€è¦ç¿»è¯‘æˆæ¯”è¾ƒç»“æ„åŒ–çš„ä¸œè¥¿ã€‚Parser é˜¶æ®µä¼šç”Ÿæˆä¸€ä¸ª&lt;em&gt;æŠ½è±¡è¯­æ³•æ ‘(AST, Abstract Syntax Tree)&lt;/em&gt;ã€‚ è¿™å¹¶ä¸æ˜¯æ•°æ®åº“æ ¸å¿ƒéƒ¨åˆ†ï¼Œbustub ç›´æ¥ä½¿ç”¨äº† PostgreSQL çš„ parser åº“ libpg_queryã€‚&lt;/p&gt;
&lt;h3 id=&#34;binder&#34;&gt;Binder&lt;/h3&gt;
&lt;p&gt;å¾—åˆ° AST åï¼Œéœ€è¦å°†è¿™äº›è¯è¯­ç»‘å®šåˆ°æ•°æ®åº“å®ä½“ä¸Šï¼Œè¿™å°±æ˜¯ Binder çš„å·¥ä½œã€‚ä¾‹å¦‚æœ‰è¿™æ ·ä¸€æ¡ sqlï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;SELECT&lt;/span&gt; table1.y, table2.x &lt;span style=&#34;color:#66d9ef&#34;&gt;FROM&lt;/span&gt; table1 &lt;span style=&#34;color:#66d9ef&#34;&gt;INNER&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;JOIN&lt;/span&gt; table2 &lt;span style=&#34;color:#66d9ef&#34;&gt;ON&lt;/span&gt; table1.x &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; table2.y;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;å…¶ä¸­ &lt;code&gt;SELECT&lt;/code&gt; å’Œ &lt;code&gt;FROM&lt;/code&gt; æ˜¯å…³é”®å­—ï¼Œ&lt;code&gt;x&lt;/code&gt; å’Œ &lt;code&gt;table1&lt;/code&gt; æ˜¯æ ‡è¯†ç¬¦ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ &lt;code&gt;explain&lt;/code&gt; æ¥çœ‹çœ‹ &lt;code&gt;binder&lt;/code&gt; å±‚ï¼ˆbustub-shell æœªå®Œæˆæ—¶ä¹Ÿå¯ä»¥ä½¿ç”¨ explainï¼‰ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;===&lt;/span&gt; BINDER &lt;span style=&#34;color:#f92672&#34;&gt;===&lt;/span&gt;                                               
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt; BoundSelec &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;                                        
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;   table&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;BoundJoin &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt; type&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;Inner, left&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;BoundBaseTableRef &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt; table&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;table1, oid&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;25&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;, right&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;BoundBaseTableRef &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt; table&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;table2, oid&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;26&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;, condition&lt;span style=&#34;color:#f92672&#34;&gt;=(&lt;/span&gt;table1.x&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;table2.y&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;, 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;   columns&lt;span style=&#34;color:#f92672&#34;&gt;=[&lt;/span&gt;table1.y, table2.x&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt;,                       
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;   groupBy&lt;span style=&#34;color:#f92672&#34;&gt;=[]&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;   having&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;,  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;   where&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;,  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;   limit&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;, 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;   offset&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;   order_by&lt;span style=&#34;color:#f92672&#34;&gt;=[]&lt;/span&gt;,                                 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;   is_distinct&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;false,         
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;   ctes&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;å¯ä»¥çœ‹å‡ºï¼Œbinderçš„ä½œç”¨å°±æ˜¯å¯¹ASTçš„å„ä¸ªèŠ‚ç‚¹ç»‘å®šä¸€ä¸ªï¼ˆç‰©ç†ï¼‰å®ä½“ã€‚&lt;/p&gt;</description>
      <content:encoded><![CDATA[<h2 id="overview">Overview</h2>
<blockquote>
<p>åœ¨è¿™æ¬¡å®éªŒå†™å®Œåï¼Œæˆ‘ä»¬å·²ç»èƒ½ä½¿ç”¨bustub-shellå®Œæˆæ‰§è¡Œ sql è¯­å¥äº†ï¼Œè¿˜æ˜¯æŒºæœ‰æˆå°±æ„Ÿçš„ã€‚åŒæ—¶ï¼ŒTA ä¸ºæˆ‘ä»¬å‡†å¤‡äº†<a href="https://15445.courses.cs.cmu.edu/fall2022/bustub/">æµè§ˆå™¨ä¸Šçš„bustub</a> ï¼Œæ–¹ä¾¿å’Œæˆ‘ä»¬å†™çš„å¯¹æ¯”è°ƒè¯•ã€‚ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ <code>explain</code> æ¥æŸ¥çœ‹ä»–çš„ä¼˜åŒ–ç­–ç•¥ä¸æ‰§è¡Œæ­¥éª¤ã€‚</p>
</blockquote>
<p>è¿™æ¬¡å®éªŒçš„ä¸»è¦éš¾ç‚¹åœ¨äºè¯»ä»£ç ï¼Œç†æ¸… bustub çš„æ‰§è¡Œå¼•æ“çš„æ•°æ®æµä»¥åŠä»£ç ä¸­çš„å®ç°ã€‚ææ‡‚äº†ä¹‹åå„ä¸ªç®—å­çš„å®ç°å°±å¾ˆç®€å•äº†ï¼ˆç›¸å¯¹ B+æ ‘ï¼‰ã€‚</p>
<p><img loading="lazy" src="/img/busTub/query_excution/project-structure.png" alt=""  />
</p>
<p>ä¸Šå›¾æ˜¯ bustub çš„æ•´ä½“æ¶æ„ã€‚</p>
<h3 id="parser">Parser</h3>
<p>sql è¯­å¥çš„è§£æå°±åƒå…¶ä»–ç¼–ç¨‹è¯­è¨€ä¸€æ ·ï¼ŒåŒæ ·éœ€è¦ç¿»è¯‘æˆæ¯”è¾ƒç»“æ„åŒ–çš„ä¸œè¥¿ã€‚Parser é˜¶æ®µä¼šç”Ÿæˆä¸€ä¸ª<em>æŠ½è±¡è¯­æ³•æ ‘(AST, Abstract Syntax Tree)</em>ã€‚ è¿™å¹¶ä¸æ˜¯æ•°æ®åº“æ ¸å¿ƒéƒ¨åˆ†ï¼Œbustub ç›´æ¥ä½¿ç”¨äº† PostgreSQL çš„ parser åº“ libpg_queryã€‚</p>
<h3 id="binder">Binder</h3>
<p>å¾—åˆ° AST åï¼Œéœ€è¦å°†è¿™äº›è¯è¯­ç»‘å®šåˆ°æ•°æ®åº“å®ä½“ä¸Šï¼Œè¿™å°±æ˜¯ Binder çš„å·¥ä½œã€‚ä¾‹å¦‚æœ‰è¿™æ ·ä¸€æ¡ sqlï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> table1.y, table2.x <span style="color:#66d9ef">FROM</span> table1 <span style="color:#66d9ef">INNER</span> <span style="color:#66d9ef">JOIN</span> table2 <span style="color:#66d9ef">ON</span> table1.x <span style="color:#f92672">=</span> table2.y;
</span></span></code></pre></div><p>å…¶ä¸­ <code>SELECT</code> å’Œ <code>FROM</code> æ˜¯å…³é”®å­—ï¼Œ<code>x</code> å’Œ <code>table1</code> æ˜¯æ ‡è¯†ç¬¦ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>explain</code> æ¥çœ‹çœ‹ <code>binder</code> å±‚ï¼ˆbustub-shell æœªå®Œæˆæ—¶ä¹Ÿå¯ä»¥ä½¿ç”¨ explainï¼‰ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span> <span style="color:#f92672">===</span> BINDER <span style="color:#f92672">===</span>                                               
</span></span><span style="display:flex;"><span> BoundSelec <span style="color:#f92672">{</span>                                        
</span></span><span style="display:flex;"><span>   table<span style="color:#f92672">=</span>BoundJoin <span style="color:#f92672">{</span> type<span style="color:#f92672">=</span>Inner, left<span style="color:#f92672">=</span>BoundBaseTableRef <span style="color:#f92672">{</span> table<span style="color:#f92672">=</span>table1, oid<span style="color:#f92672">=</span><span style="color:#ae81ff">25</span> <span style="color:#f92672">}</span>, right<span style="color:#f92672">=</span>BoundBaseTableRef <span style="color:#f92672">{</span> table<span style="color:#f92672">=</span>table2, oid<span style="color:#f92672">=</span><span style="color:#ae81ff">26</span> <span style="color:#f92672">}</span>, condition<span style="color:#f92672">=(</span>table1.x<span style="color:#f92672">=</span>table2.y<span style="color:#f92672">)</span> <span style="color:#f92672">}</span>, 
</span></span><span style="display:flex;"><span>   columns<span style="color:#f92672">=[</span>table1.y, table2.x<span style="color:#f92672">]</span>,                       
</span></span><span style="display:flex;"><span>   groupBy<span style="color:#f92672">=[]</span>,
</span></span><span style="display:flex;"><span>   having<span style="color:#f92672">=</span>,  
</span></span><span style="display:flex;"><span>   where<span style="color:#f92672">=</span>,  
</span></span><span style="display:flex;"><span>   limit<span style="color:#f92672">=</span>, 
</span></span><span style="display:flex;"><span>   offset<span style="color:#f92672">=</span>,
</span></span><span style="display:flex;"><span>   order_by<span style="color:#f92672">=[]</span>,                                 
</span></span><span style="display:flex;"><span>   is_distinct<span style="color:#f92672">=</span>false,         
</span></span><span style="display:flex;"><span>   ctes<span style="color:#f92672">=</span>,
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>å¯ä»¥çœ‹å‡ºï¼Œbinderçš„ä½œç”¨å°±æ˜¯å¯¹ASTçš„å„ä¸ªèŠ‚ç‚¹ç»‘å®šä¸€ä¸ªï¼ˆç‰©ç†ï¼‰å®ä½“ã€‚</p>
<h3 id="planner">Planner</h3>
<p>å¾—åˆ° Bustub AST åï¼ŒPlanner éå†è¿™æ£µæ ‘ï¼Œç”Ÿæˆåˆæ­¥çš„æŸ¥è¯¢è®¡åˆ’ã€‚æŸ¥è¯¢è®¡åˆ’ä¹Ÿæ˜¯ä¸€æ£µæ ‘çš„å½¢å¼ã€‚ä¾‹å¦‚è¿™æ¡ sqlï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> table1.y, table2.x <span style="color:#66d9ef">FROM</span> table1 <span style="color:#66d9ef">INNER</span> <span style="color:#66d9ef">JOIN</span> table2 <span style="color:#66d9ef">ON</span> t1.x <span style="color:#f92672">=</span> t2.y;
</span></span></code></pre></div><p>æŸ¥çœ‹ explainï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span> <span style="color:#f92672">===</span> PLANNER <span style="color:#f92672">===</span>
</span></span><span style="display:flex;"><span> Projection <span style="color:#f92672">{</span> exprs<span style="color:#f92672">=[</span><span style="color:#75715e">#0.1, #0.2] } | (table1.y:INTEGER, table2.x:INTEGER)                                                                                            </span>
</span></span><span style="display:flex;"><span>   NestedLoopJoin <span style="color:#f92672">{</span> type<span style="color:#f92672">=</span>Inner, predicate<span style="color:#f92672">=(</span><span style="color:#75715e">#0.0=#1.1) } | (table1.x:INTEGER, table1.y:INTEGER, table2.x:INTEGER, table2.y:INTEGER)                                   </span>
</span></span><span style="display:flex;"><span>     SeqScan <span style="color:#f92672">{</span> table<span style="color:#f92672">=</span>table1 <span style="color:#f92672">}</span> | <span style="color:#f92672">(</span>table1.x:INTEGER, table1.y:INTEGER<span style="color:#f92672">)</span>                                                                                                 
</span></span><span style="display:flex;"><span>     SeqScan <span style="color:#f92672">{</span> table<span style="color:#f92672">=</span>table2 <span style="color:#f92672">}</span> | <span style="color:#f92672">(</span>table2.x:INTEGER, table2.y:INTEGER<span style="color:#f92672">)</span> 
</span></span></code></pre></div><p>ä¸Šé¢çš„è§£é‡Šå…¶å®æ˜¯æ ‘å‹çš„ï¼Œå¦‚ä¸‹å›¾ï¼š
<img loading="lazy" src="/img/busTub/query_excution/planner-tree.png" alt=""  />

æŸ¥è¯¢è®¡åˆ’è§„å®šäº†æ•°æ®çš„æµå‘ã€‚æ•°æ®ä»æ ‘å¶æµå‘æ ‘æ ¹ï¼Œè‡ªåº•å‘ä¸Šåœ°æµåŠ¨ï¼Œåœ¨æ ¹èŠ‚ç‚¹è¾“å‡ºç»“æœã€‚</p>
<h3 id="optimizer">Optimizer</h3>
<p>ç”ŸæˆæŸ¥è¯¢è®¡åˆ’å
ç”± Planner å¾—åˆ°åˆæ­¥çš„æŸ¥è¯¢è®¡åˆ’åï¼Œå†å°†æŸ¥è¯¢è®¡åˆ’äº¤ç»™ Optimizer è¿›è¡Œä¿®æ”¹ä¼˜åŒ–ï¼Œç”Ÿæˆä¼˜åŒ–è¿‡åçš„æœ€ç»ˆæŸ¥è¯¢è®¡åˆ’ã€‚Optimizer ä¸»è¦æœ‰ä¸¤ç§å®ç°æ–¹å¼ï¼š</p>
<ul>
<li>Rule-based.
<ul>
<li>é€šè¿‡è‡ªåŠ¨é‡å†™æŸ¥è¯¢æ¥é¿å…æ•ˆç‡ä½çš„æ–¹æ³•ã€‚ä¾‹å¦‚æˆ‘ä»¬åœ¨ Task 3 ä¸­å°†è¦å®ç°çš„ï¼Œå°† <code>Limit + Sort</code> åˆå¹¶ä¸º <code>TopN</code>ã€‚</li>
<li>è¿™ç§ Optimizer ä¸éœ€è¦çŸ¥é“æ•°æ®çš„å…·ä½“å†…å®¹ï¼Œä»…æ˜¯æ ¹æ®é¢„å…ˆå®šä¹‰å¥½çš„è§„åˆ™ä¿®æ”¹ <code>Plan Node</code>ã€‚</li>
</ul>
</li>
<li>Cost-based.
<ul>
<li>ç”¨æŸç§æ¨¡å‹æ¥é¢„ä¼°æ‰§è¡Œè®¡åˆ’çš„æ—¶é—´ï¼Œè¿™å°±éœ€è¦å­˜å¾ˆå¤šè·Ÿæ•°æ®ç›¸å…³çš„æ•°æ®</li>
<li>é€šè¿‡å¯¹ä¸åŒæ¨¡å‹çš„ cost æ¯”è¾ƒé€‰å‡ºæ‰§è¡Œ cost æœ€å°çš„ã€‚</li>
<li>è¿™ä¹Ÿä¼šé€ æˆä¸€äº›é¢å¤–å¼€é”€ ï¼ˆè¿è¡Œè¿™ä¸ªcost modelï¼‰</li>
</ul>
</li>
</ul>
<p>Bustub çš„ Optimizer é‡‡ç”¨ç¬¬ä¸€ç§å®ç°æ–¹å¼ã€‚</p>
<blockquote>
<p>ä¸€èˆ¬æ¥è¯´ï¼ŒPlanner ç”Ÿæˆçš„æ˜¯ Logical Plan Nodeï¼Œä»£è¡¨æŠ½è±¡çš„ Planã€‚Optimizer åˆ™ç”Ÿæˆ Physical Plan Nodeï¼Œä»£è¡¨å…·ä½“æ‰§è¡Œçš„ Planã€‚ä¾‹å¦‚æ˜¯ Joinã€‚åœ¨ Planner ç”Ÿæˆçš„æŸ¥è¯¢è®¡åˆ’ä¸­ï¼ŒJoin å°±æ˜¯ Joinã€‚åœ¨ Optimizer ç”Ÿæˆçš„æŸ¥è¯¢è®¡åˆ’ä¸­ï¼ŒJoin ä¼šè¢«ä¼˜åŒ–æˆå…·ä½“çš„ HashJoin æˆ– NestedIndexJoin ç­‰ç­‰ã€‚åœ¨ Bustub ä¸­ï¼Œå¹¶ä¸åŒºåˆ† Logical Plan Node å’Œ Physical Plan Nodeã€‚Planner ä¼šç›´æ¥ç”Ÿæˆ Physical Plan Nodeã€‚</p>
</blockquote>
<h3 id="executor">Executor</h3>
<p>åœ¨æ‹¿åˆ° Optimizer ç”Ÿæˆçš„å…·ä½“çš„æŸ¥è¯¢è®¡åˆ’åï¼Œå°±å¯ä»¥ç”ŸæˆçœŸæ­£æ‰§è¡ŒæŸ¥è¯¢è®¡åˆ’çš„ä¸€ç³»åˆ—ç®—å­äº†ã€‚ç®—å­ä¹Ÿæ˜¯æˆ‘ä»¬åœ¨ Project 3 ä¸­éœ€è¦å®ç°çš„ä¸»è¦å†…å®¹ã€‚ç”Ÿæˆç®—å­çš„æ­¥éª¤å¾ˆç®€å•ï¼Œéå†æŸ¥è¯¢è®¡åˆ’æ ‘ï¼Œå°†æ ‘ä¸Šçš„ PlanNode æ›¿æ¢æˆå¯¹åº”çš„ Executorã€‚ç®—å­çš„æ‰§è¡Œæ¨¡å‹ä¹Ÿå¤§è‡´åˆ†ä¸ºä¸‰ç§ï¼š</p>
<ol>
<li>
<p>Iterator/Pipeline Model(volcano model)ã€‚æ¯ä¸ªç®—å­éƒ½æœ‰ Init() å’Œ Next() ä¸¤ä¸ªæ–¹æ³•ã€‚Init() å¯¹ç®—å­è¿›è¡Œåˆå§‹åŒ–å·¥ä½œã€‚Next() åˆ™æ˜¯å‘ä¸‹å±‚ç®—å­è¯·æ±‚ä¸‹ä¸€æ¡æ•°æ®ã€‚å½“ Next() è¿”å› false æ—¶ï¼Œåˆ™ä»£è¡¨ä¸‹å±‚ç®—å­å·²ç»æ²¡æœ‰å‰©ä½™æ•°æ®ï¼Œè¿­ä»£ç»“æŸã€‚ç«å±±æ¨¡å‹ä¸€æ¬¡è°ƒç”¨åªå‘ä¸‹å±‚ç®—å­è¯·æ±‚ä¸€æ¡æ•°æ®ï¼Œå ç”¨å†…å­˜è¾ƒå°ï¼Œä½†å‡½æ•°è°ƒç”¨å¼€é”€å¤§ã€‚ <img loading="lazy" src="/img/busTub/query_excution/iterator-model.png" alt=""  />
</p>
</li>
<li>
<p>Materialization Model. æ‰€æœ‰ç®—å­ç«‹å³è®¡ç®—å‡ºæ‰€æœ‰ç»“æœå¹¶è¿”å›ã€‚å’Œ Iterator Model ç›¸åã€‚è¿™ç§æ¨¡å‹çš„å¼Šç«¯æ˜¾è€Œæ˜“è§ï¼Œå½“æ•°æ®é‡è¾ƒå¤§æ—¶ï¼Œå†…å­˜å ç”¨å¾ˆé«˜ï¼Œä½†å‡å°‘äº†å‡½æ•°è°ƒç”¨çš„å¼€é”€ã€‚æ¯”è¾ƒé€‚åˆæŸ¥è¯¢æ•°æ®é‡è¾ƒå°çš„ OLTP workloadsã€‚</p>
</li>
<li>
<p>Vectorized/Batch Model. å¯¹ä¸Šé¢ä¸¤ç§æ¨¡å‹çš„ä¸­å’Œï¼Œä¸€æ¬¡è°ƒç”¨è¿”å›ä¸€æ‰¹æ•°æ®ã€‚åˆ©äº SIMD åŠ é€Ÿã€‚ç›®å‰æ¯”è¾ƒå…ˆè¿›çš„ OLAP æ•°æ®åº“é‡‡ç”¨è¿™ç§æ¨¡å‹ã€‚</p>
</li>
</ol>
<p>Bustub é‡‡ç”¨ Iterator Modelã€‚</p>
<h2 id="metadata">Metadata</h2>
<p>ä¸Šé¢ä»‹ç»äº† sqlè¯­å¥æ‰§è¡Œè¿‡ç¨‹ï¼Œè¶³ä»¥è®©æˆ‘ä»¬å¯¹æ•´ä¸ªæ‰§è¡Œå¼•æ“æœ‰å¤§ä½“äº†è§£ã€‚ä½†æ˜¯æˆ‘åœ¨åšè¿™ä¸ª lab æ—¶å€™è¿˜æ˜¯æœ‰å¾ˆå¤šå›°æƒ‘çš„åœ°æ–¹ã€‚æœ€åæ˜¯è¿·è¿·ç³Šç³Šçš„å†™å®Œäº†æ‰æ•´ç†äº†ä¸‹ã€‚å¤§ä½“ä¸Šçš„ä¿¡æ¯åŒ…æ‹¬åœ¨ä¸‹å›¾ä¸­ï¼š
<img loading="lazy" src="/img/busTub/query_excution/table-matedata.png" alt=""  />

ï¼ˆå›¾ç‰‡æ”¹è‡ª<a href="https://blog.eleven.wiki/posts/cmu15-445-project3-query-execution/">è¿™ç¯‡åšå®¢</a>ï¼‰</p>
<h2 id="task-1---access-method-executors">Task #1 - Access Method Executors</h2>
<h3 id="seqscan">SeqScan</h3>
<p>å®ç°æ¯”è¾ƒç®€å•ï¼Œè·å– table_iter ç›´æ¥éå†å³å¯ã€‚è¿™é‡Œè¯´è¯´è¿™ä¸ª<code>plan_-&gt;filter_predicate_</code>ï¼Œ ä»–æ˜¯ä¸€ä¸ª<code>AbstractExpressionRef</code>ï¼Œè€Œä¸€ä¸ª<code>AbstractExpression</code>æ„æ€æ˜¯ä¸€ä¸ª <em>è¡¨è¾¾å¼</em> ï¼Œä»–é‡Œé¢æœ€é‡è¦çš„ä¸¤ä¸ªå‡½æ•°æ˜¯ <code>Evaluate(const Tuple *tuple, const Schema &amp;schema)</code>å’Œ <code>EvaluateJoin(const Tuple *left_tuple, const Schema &amp;left_schema, const Tuple *right_tuple, const Schema &amp;right_schema)</code>ï¼Œä¸»è¦å°±æ˜¯ç”¨æ¥åš filter çš„ã€‚ä¾‹å¦‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> table1 <span style="color:#66d9ef">where</span> x <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span></code></pre></div><p>å¦‚æœä»»ä½•ä¼˜åŒ–éƒ½æ²¡æœ‰ï¼Œé‚£ä¹ˆä¸Šè¿°è¯­å¥å¯ä»¥è§£æä¸ºä¸¤å±‚ï¼š</p>
<ol>
<li>ä» table1 ä¸­é€‰å‡ºæ‰€æœ‰çš„ tupleã€‚</li>
<li>é€‰å‡º x = 1çš„ tupleã€‚ç›¸å½“äºåº•ä¸‹çš„ seqscan ç»“ç‚¹ä¼šå°†æ‰€æœ‰ tuple å‘åˆ°ä¸Šä¸€å±‚ï¼Œç„¶åä¸Šä¸€å±‚å†åšä¸€æ¬¡ filterã€‚ä½†æ˜¯æˆ‘ä»¬é€šè¿‡è°“è¯ä¸‹æ¨ï¼Œå¯ä»¥åœ¨seqscan æ—¶å€™å°±é€šè¿‡ filter_predicate_ å°†éœ€è¦çš„è¿‡æ»¤å‡ºæ¥ï¼Œä¸éœ€è¦çš„ä¸ç”¨å‘ç»™ä¸Šä¸€å±‚ã€‚ï¼ˆå½“ç„¶ï¼Œè¿™ä¸ªä¾‹å­ä¸å¤ªå‡†ç¡®ã€‚åœ¨è¿™ä¸ªæƒ…å†µä¸‹æœ¬æ¥å°±æ˜¯ä¸€æ¬¡æå®šçš„ï¼Œæ€»ä¹‹æ˜¯åœ¨å¤æ‚çš„æ—¶å€™å¯ä»¥æŠŠè°“è¯ä¸‹æ¨ï¼‰ã€‚
è¿™ä¸ª Evaluate è¿”å›ä¸€ä¸ª <code>Value</code>ï¼Œå®é™…ä¸Šå¦‚æœåšfilteråº”è¯¥è¿”å› booleanï¼Œæ‰€ä»¥éœ€è¦é€šè¿‡<code>filter_predicate_-&gt;Evaluate(tuple, table_info_-&gt;schema_).GetAs&lt;bool&gt;()</code>è½¬åŒ–ä¸€ä¸‹ã€‚
å¦å¤–ï¼Œseqscan å®é™…ä¸Šä¸ä¼šç”¨åˆ° filter_predicateã€‚åé¢é‡åˆ°éœ€è¦ predicate çš„åœ°æ–¹ä¼šå†å¼ºè°ƒã€‚</li>
</ol>
<h3 id="insert--delete">Insert &amp; Delete</h3>
<p>è¿™ä¸¤ä¸ªç®—å­æ˜¯å”¯äºŒçš„å†™ç®—å­ï¼ˆå®é™…ä¸Šåé¢çš„ä¼˜åŒ–è¿‡ç¨‹ä¸­éœ€è¦å®ç°ä¸€ä¸ª updateç®—å­ï¼‰ã€‚</p>
<p>æˆ‘ä»¬å…ˆçœ‹ä¸‹è¿™ä¸¤ä¸ªç®—å­çš„è¡Œä¸ºï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>bustub<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">insert</span> <span style="color:#66d9ef">into</span> t1 <span style="color:#66d9ef">values</span> (<span style="color:#ae81ff">0</span>, <span style="color:#e6db74">&#39;ğŸ¥°&#39;</span>, <span style="color:#ae81ff">10</span>), (<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#39;ğŸ¥°ğŸ¥°&#39;</span>, <span style="color:#ae81ff">11</span>), (<span style="color:#ae81ff">2</span>, <span style="color:#e6db74">&#39;ğŸ¥°ğŸ¥°ğŸ¥°&#39;</span>, <span style="color:#ae81ff">12</span>), (<span style="color:#ae81ff">3</span>, <span style="color:#e6db74">&#39;ğŸ¥°ğŸ¥°ğŸ¥°ğŸ¥°&#39;</span>, <span style="color:#ae81ff">13</span>), (<span style="color:#ae81ff">4</span>, <span style="color:#e6db74">&#39;ğŸ¥°ğŸ¥°ğŸ¥°ğŸ¥°&#39;</span>, <span style="color:#ae81ff">14</span>);
</span></span><span style="display:flex;"><span><span style="color:#f92672">//</span> <span style="color:#66d9ef">output</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#75715e">-------------------------------+
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">|</span> __bustub_internal.insert_rows <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#75715e">-------------------------------+
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">|</span> <span style="color:#ae81ff">5</span>                             <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#75715e">-------------------------------+
</span></span></span></code></pre></div><p>è¿™ä¸¤ä¸ªç®—å­ä»–ä»¬ä¼šä¸€ç›´ nextï¼Œç„¶åè¿”å›ä¸€æ¬¡ï¼Œè¿”å›çš„æ˜¯æ’å…¥/åˆ é™¤ tuple çš„ä¸ªæ•°ï¼ˆæ‰€ç”Ÿæˆçš„tupleï¼‰ã€‚æœ‰ç‚¹åƒ <code>pipeline breaker</code>ï¼Œä½†æ˜¯ç”±äºä»–ä»¬ä¸€å®šæ˜¯é¡¶å±‚ç®—å­ï¼Œæ‰€ä»¥å¥½åƒä¸å« <code>pipeline breaker</code>ã€‚</p>
<p>ä¸ªäººæ„Ÿè§‰è¿™ä¸ªè¿”å›ä¸ªæ•°çš„è®¾è®¡æœ‰ç‚¹ä¸æ˜¯å¾ˆåˆç†ï¼Œå®ƒä¸€å®šè¦å°†ä¸ªæ•°è½¬åŒ–æˆä¸€ä¸ªtupleè¿”å›ã€‚å¤§æ¦‚æ˜¯è¿™æ ·çš„æ“ä½œã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>  <span style="color:#f92672">*</span>tuple <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>      Tuple(std<span style="color:#f92672">::</span>vector<span style="color:#f92672">&lt;</span>Value<span style="color:#f92672">&gt;</span>(GetOutputSchema().GetColumnCount() <span style="color:#75715e">/* ColumnCount() should be one*/</span>, Value(TypeId<span style="color:#f92672">::</span>INTEGER, counter)),
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&amp;</span>GetOutputSchema());
</span></span></code></pre></div><p>å¦å¤–éœ€è¦æ³¨æ„çš„å°±æ˜¯è¿™äº› å¢åŠ /åˆ é™¤ tuple æ—¶ï¼Œå¯¹åº”çš„ç´¢å¼•é¡¹ä¹Ÿéœ€è¦å¢åŠ /åˆ é™¤ã€‚</p>
<h3 id="indexscan">IndexScan</h3>
<p>è¿™ä¸ªå°±ç®€å•äº†ï¼Œåœ¨ Init() æ—¶å€™ä¿å­˜ index_iterï¼Œ next() æ—¶ç›´æ¥è°ƒç”¨å†è‡ªå¢å°±å¯ä»¥ã€‚</p>
<h2 id="task-2---aggregation--join-executors">Task #2 - Aggregation &amp; Join Executors</h2>
<h3 id="aggregation">Aggregation</h3>
<p>aggregation æ“ä½œæ˜¯ä¸€ä¸ª <code>pipeline breaker</code>ã€‚ä»–ä¼šåœ¨ init å¾—åˆ°å…¨éƒ¨ç­”æ¡ˆç„¶åå† next æ—¶ä¸€æ¡ä¸€æ¡è¿”å›ã€‚</p>
<p><code>SimpleAggregationHashTable</code> ç»´æŠ¤ä¸€å¼ å“ˆå¸Œè¡¨ï¼Œé”®ä¸º <code>AggregateKey</code>ï¼Œå€¼ä¸º <code>AggregateValue</code>ï¼Œå‡ä¸º <code>std::vector&lt;Value&gt;</code>ã€‚key ä»£è¡¨ group by çš„å­—æ®µçš„æ•°ç»„ï¼Œvalue åˆ™æ˜¯éœ€è¦ aggregate çš„å­—æ®µçš„æ•°ç»„ã€‚åœ¨ä¸‹å±‚ç®—å­ä¼ æ¥ä¸€ä¸ª tuple æ—¶ï¼Œå°† tuple çš„ group by å­—æ®µå’Œ aggregate å­—æ®µåˆ†åˆ«æå–å‡ºæ¥ï¼Œè°ƒç”¨ <code>InsertCombine()</code> å°† group by å’Œ aggregate çš„æ˜ å°„å…³ç³»å­˜å…¥ <code>SimpleAggregationHashTable</code>ã€‚è‹¥å½“å‰ hashmap ä¸­æ²¡æœ‰ group by çš„è®°å½•ï¼Œåˆ™åˆ›å»ºåˆå€¼ï¼›è‹¥å·²æœ‰è®°å½•ï¼Œåˆ™æŒ‰ aggregate è§„åˆ™é€ä¸€æ›´æ–°æ‰€æœ‰çš„ aggregate å­—æ®µï¼Œä¾‹å¦‚å– max/minï¼Œæ±‚ sum ç­‰ç­‰ã€‚ä¾‹å¦‚ä¸‹é¢è¿™æ¡ sqlï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> <span style="color:#66d9ef">min</span>(t.z), <span style="color:#66d9ef">max</span>(t.z), <span style="color:#66d9ef">sum</span>(t.z) <span style="color:#66d9ef">FROM</span> t <span style="color:#66d9ef">GROUP</span> <span style="color:#66d9ef">BY</span> t.x, t.y;
</span></span></code></pre></div><p>group byï¼ˆAggregateKeyï¼‰ä¸º {t.x, t.y}ï¼Œaggregateï¼ˆAggregateValueï¼‰ä¸º {t.z, t.z, t.z}ã€‚aggregate è§„åˆ™ä¸º {min, max, sum}ã€‚</p>
<p>éœ€è¦é¢å¤–æ³¨æ„ <code>count(column)</code> å’Œ <code>count(*)</code> çš„åŒºåˆ«ï¼Œä»¥åŠå¯¹ç©ºå€¼çš„å¤„ç†ã€‚</p>
<p>åœ¨ Init() ä¸­è®¡ç®—å‡ºæ•´å¼  hashmap åï¼Œåœ¨ Next() ä¸­ç›´æ¥åˆ©ç”¨ hashmap iterator å°†ç»“æœä¾æ¬¡å–å‡ºã€‚è¿™é‡Œçš„è¾“å‡ºå½¢å¼æœ‰ç‚¹å¥‡æ€ªï¼Œéœ€è¦è¿™æ ·çš„è¾“å‡ºï¼š
<img loading="lazy" src="/img/busTub/query_excution/aggregate-return.png" alt=""  />
</p>
<p><code>schema</code> å·²ç»åœ¨ <code>GetOutputSchema()</code> ä¸­å‡†å¤‡å¥½äº†ã€‚</p>
<h3 id="nestedloopjoin">NestedLoopJoin</h3>
<p>æˆ‘çš„å®ç°æ¯”è¾ƒ trickyã€‚æˆ‘åœ¨ init æ—¶å€™ç›´æ¥æŠŠä¸‹å±‚ç®—å­ï¼ˆleft_executorå’Œright_executorï¼‰æ‰€æœ‰çš„tupleéƒ½å¾—åˆ°äº†ï¼ˆç›¸å½“äºå½“ä½œ pipeline breakerï¼‰ï¼Œä¿å­˜åœ¨ä¸¤å¼ è¡¨ä¸­ã€‚å† nextæ—¶å€™è¿›è¡ŒåŒ¹é…ã€‚è¿™é‡Œçš„ left-join å’Œ inner-join æ˜¯éœ€è¦åˆ†å¼€å®ç°çš„ï¼Œå¯ä»¥åœ¨ç½‘ä¸ŠæŸ¥ä¸‹left-joinå’Œinner-joinçš„åŒºåˆ«ã€‚
åœ¨è¿™é‡Œåˆ¤æ–­å·¦å³ä¸¤ä¸ª tuple æ˜¯å¦ match å°±éœ€è¦ç”¨åˆ°<code>plan_-&gt;Predicate().EvaluateJoin()</code>ï¼ŒåŒæ ·è¦ <code>GetAs&lt;bool&gt;()</code>ã€‚</p>
<p>å½“æˆ‘ä»¬å¾—åˆ°ä¸€ä¸ª match åï¼Œè¿”å›å‰è®°å¾—<strong>ä¿å­˜ä¸Šä¸‹æ–‡</strong>ï¼Œä¾‹å¦‚ï¼Œä½ å¯ä»¥ä¿å­˜ match çš„ tuple å†å·¦è¡¨ä¸­çš„ä¸‹æ ‡å’Œå³è¡¨ä¸­çš„ä¸‹æ ‡ï¼Œè¿™æ ·ä¸‹æ¬¡è°ƒç”¨ next æ—¶å€™ï¼Œå°±ä¸ç”¨é‡æ–°æ‰«æä¸€æ¬¡ã€‚</p>
<h3 id="nestedindexjoin">NestedIndexJoin</h3>
<p>åœ¨è¿›è¡Œ equi-join æ—¶ï¼Œå¦‚æœå‘ç° JOIN ON å³è¾¹çš„å­—æ®µä¸Šå»ºäº† indexï¼Œåˆ™ Optimizer ä¼šå°† NestedLoopJoin ä¼˜åŒ–ä¸º NestedIndexJoinã€‚å…·ä½“å®ç°å’Œ NestedLoopJoin å·®ä¸å¤šï¼Œåªæ˜¯åœ¨å°è¯•åŒ¹é…å³è¡¨ tuple æ—¶ï¼Œä¼šæ‹¿ join key å» B+Tree Index é‡Œè¿›è¡ŒæŸ¥è¯¢ã€‚å¦‚æœæŸ¥è¯¢åˆ°ç»“æœï¼Œå°±æ‹¿ç€æŸ¥åˆ°çš„ RID å»å³è¡¨è·å– tuple ç„¶åè£…é…æˆç»“æœè¾“å‡ºã€‚</p>
<h2 id="task-3---sort--limit-executors-and-top-n-optimization">Task #3 - Sort + Limit Executors and Top-N Optimization</h2>
<h3 id="sort">sort</h3>
<p>è¿™ä¸ªå®éªŒçš„ sort æ— éœ€è¿›è¡Œå¤–éƒ¨æ’åºï¼Œé‡è½½å°äºåå°±å¯ä»¥å®ç°ã€‚å°±æ˜¯æ¯”è¾ƒçš„æ–¹å¼æœ‰ç‚¹å¥‡æ€ªï¼Œå¯ä»¥ç±»æ¯”ä»¥ä¸‹å†™ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>order_key.second<span style="color:#f92672">-&gt;</span>Evaluate(<span style="color:#f92672">&amp;</span>lhs, schema).CompareLessThan(order_key.second<span style="color:#f92672">-&gt;</span>Evaluate(<span style="color:#f92672">&amp;</span>rhs, schema))
</span></span></code></pre></div><h3 id="limit">limit</h3>
<p>ç®€å•ï¼Œlimit é™åˆ¶åœ¨ <code>plan_-&gt;Getlimit()</code>é‡Œé¢ã€‚</p>
<h3 id="top-n-optimization-rule">Top-N Optimization Rule</h3>
<p>ç®€å•ï¼Œä¼˜å…ˆé˜Ÿåˆ—é‡è½½å°äºï¼ˆé‡è½½æ–¹å¼ä¸ sort ç›¸åŒï¼‰ï¼Œç„¶åæˆªå–å‰ n ä¸ªã€‚</p>
<h3 id="sort--limit-as-topn">Sort + Limit As TopN</h3>
<p>è¿™æ˜¯ Project 3 é‡Œæœ€åä¸€ä¸ªå¿…åšçš„å°é—®ï¼Œä¹Ÿæ˜¯å”¯ä¸€ä¸€ä¸ª Optimizer ï¼Œå°† Sort + Limit ä¼˜åŒ–ä¸º TopNã€‚å…ˆçœ‹çœ‹ Optimizer æ˜¯å¦‚ä½•æ‰§è¡Œä¼˜åŒ–è§„åˆ™çš„ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">auto</span> Optimizer<span style="color:#f92672">::</span>OptimizeCustom(<span style="color:#66d9ef">const</span> AbstractPlanNodeRef <span style="color:#f92672">&amp;</span>plan) <span style="color:#f92672">-&gt;</span> AbstractPlanNodeRef {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">auto</span> p <span style="color:#f92672">=</span> plan;
</span></span><span style="display:flex;"><span>  p <span style="color:#f92672">=</span> OptimizeMergeProjection(p);
</span></span><span style="display:flex;"><span>  p <span style="color:#f92672">=</span> OptimizeMergeFilterNLJ(p);
</span></span><span style="display:flex;"><span>  p <span style="color:#f92672">=</span> OptimizeNLJAsIndexJoin(p);
</span></span><span style="display:flex;"><span>  p <span style="color:#f92672">=</span> OptimizeNLJAsHashJoin(p);  <span style="color:#75715e">// Enable this rule after you have implemented hash join.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  p <span style="color:#f92672">=</span> OptimizeOrderByAsIndexScan(p);
</span></span><span style="display:flex;"><span>  p <span style="color:#f92672">=</span> OptimizeSortLimitAsTopN(p);  <span style="color:#75715e">// what we should add
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">return</span> p;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>å¯ä»¥çœ‹åˆ°ï¼Œè®©æœªç»ä¼˜åŒ–çš„åŸå§‹ plan æ ‘ä¾æ¬¡ç»å†å¤šæ¡è§„åˆ™ï¼Œæ¥ç”Ÿæˆä¼˜åŒ–è¿‡çš„ planã€‚æˆ‘ä»¬çš„ä»»åŠ¡å°±æ˜¯æ–°å¢ä¸€æ¡è§„åˆ™ã€‚çœ‹çœ‹å…¶ä»–è§„åˆ™æ˜¯æ€ä¹ˆå®ç°çš„ï¼Œä¾‹å¦‚ NLJAsIndexJoinï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">auto</span> Optimizer<span style="color:#f92672">::</span>OptimizeNLJAsIndexJoin(<span style="color:#66d9ef">const</span> AbstractPlanNodeRef <span style="color:#f92672">&amp;</span>plan) <span style="color:#f92672">-&gt;</span> AbstractPlanNodeRef {
</span></span><span style="display:flex;"><span>  std<span style="color:#f92672">::</span>vector<span style="color:#f92672">&lt;</span>AbstractPlanNodeRef<span style="color:#f92672">&gt;</span> children;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">auto</span> <span style="color:#f92672">&amp;</span>child : plan<span style="color:#f92672">-&gt;</span>GetChildren()) {
</span></span><span style="display:flex;"><span>    children.emplace_back(OptimizeNLJAsIndexJoin(child));
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">auto</span> optimized_plan <span style="color:#f92672">=</span> plan<span style="color:#f92672">-&gt;</span>CloneWithChildren(std<span style="color:#f92672">::</span>move(children));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (optimized_plan<span style="color:#f92672">-&gt;</span>GetType() <span style="color:#f92672">==</span> PlanType<span style="color:#f92672">::</span>NestedLoopJoin) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// apply the rule and return
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> optimized_plan;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>å¯ä»¥çœ‹åˆ°ï¼Œå®é™…ä¸Šå°±æ˜¯å¯¹ plan tree è¿›è¡Œååºéå†ï¼Œè‡ªåº•å‘ä¸Šåœ°é€‚ç”¨è§„åˆ™ï¼Œæ”¹å†™èŠ‚ç‚¹ã€‚éå†åˆ°æŸä¸ªèŠ‚ç‚¹æ—¶ï¼Œé€šè¿‡ if è¯­å¥æ¥åˆ¤æ–­å½“å‰èŠ‚ç‚¹çš„ç±»å‹æ˜¯å¦ç¬¦åˆæˆ‘ä»¬è¦ä¼˜åŒ–çš„ç±»å‹ï¼Œè‹¥ç¬¦åˆåˆ™è¿›è¡Œä¼˜åŒ–ã€‚</p>
<p>å¤§è‡´äº†è§£å¦‚ä½•å¯¹ plan è¿›è¡Œä¼˜åŒ–åï¼Œå°±å¯ä»¥å¼€å§‹å†™æˆ‘ä»¬çš„ä¼˜åŒ–è§„åˆ™äº†ã€‚éœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼Œèƒ½ä¼˜åŒ–ä¸ºä¸€ä¸ª TopN ç®—å­çš„å½¢å¼æ˜¯ï¼Œä¸Šå±‚èŠ‚ç‚¹ä¸º Limitï¼Œä¸‹å±‚èŠ‚ç‚¹ä¸º Sortï¼Œä¸èƒ½åè¿‡æ¥ã€‚åŒæ ·ï¼Œæˆ‘ä»¬å¯¹ plan tree è¿›è¡Œåç»­éå†ï¼Œåœ¨é‡åˆ° Limit æ—¶ï¼Œåˆ¤æ–­å…¶ä¸‹å±‚èŠ‚ç‚¹æ˜¯å¦ä¸º Sortï¼Œè‹¥ä¸º Sortï¼Œåˆ™å°†è¿™ä¸¤ä¸ªèŠ‚ç‚¹æ›¿æ¢ä¸ºä¸€ä¸ª TopNã€‚è¿˜æ˜¯æ¯”è¾ƒå¥½å®ç°çš„ï¼Œåªæ˜¯ä»£ç çœ‹èµ·æ¥å¯èƒ½æœ‰ç‚¹å¤æ‚ã€‚</p>
<h2 id="leaderboard-task">Leaderboard Task</h2>
<p>æš‚æ—¶è¿˜æ²¡å†™ï¼Œæœ‰ç©ºäº†è¡¥è¡¥</p>
<p><strong>AC!</strong>
<img loading="lazy" src="/img/busTub/query_excution/p3-result.png" alt=""  />
</p>
<h2 id="resources">Resources</h2>
<ul>
<li><a href="https://15445.courses.cs.cmu.edu/fall2022/bustub/">bustub on web</a></li>
<li><a href="https://15445.courses.cs.cmu.edu/fall2022">è¯¾ç¨‹å®˜ç½‘</a></li>
<li><a href="https://github.com/cmu-db/bustub">Github Repo</a></li>
<li><a href="https://www.youtube.com/watch?v=uikbtpVZS2s&amp;list=PLSE8ODhjZXjaKScG3l0nuOiDTTqpfnWFf&amp;ab_channel=CMUDatabaseGroup">Youtubeè¯¾ç¨‹è§†é¢‘ 2022fall</a> ï¼ˆå¦‚æœå¯¹è‹±æ–‡å­—å¹•æœ‰å‹åŠ›çš„è¯å¯ä»¥åœ¨ chrome æ’ä»¶é‡Œä¸‹ä¸ªä¸­è‹±æ–‡åŒå­—å¹•æ’ä»¶ï¼‰</li>
</ul>
]]></content:encoded>
    </item>
    
    <item>
      <title>CMU15445-project2 Concurrent B&#43; tree</title>
      <link>https://caaatch22.github.io/posts/cmu15445-project2-concurrent-b-tree/</link>
      <pubDate>Tue, 27 Dec 2022 23:45:12 +0000</pubDate>
      
      <guid>https://caaatch22.github.io/posts/cmu15445-project2-concurrent-b-tree/</guid>
      <description>&lt;h2 id=&#34;overview&#34;&gt;Overview&lt;/h2&gt;
&lt;blockquote&gt;
&lt;p&gt;è¿™ä¸ªå®éªŒåº”è¯¥æ˜¯æœ€éš¾çš„ä¸€ä¸ªå®éªŒäº†ã€‚ã€‚ã€‚ï¼ˆæ„Ÿè§‰å’ŒProject 4 â€”â€” Transactionå®ç°çš„éš¾åº¦å·®ä¸å¤šï¼‰ å¦å¤–ï¼Œ2022fallç‰ˆæœ¬çš„B+ treeæ›´æ˜¯å˜æ€ï¼Œå› ä¸ºå‡ ä¹æ²¡æœ‰ç»™ä»»ä½•å†…éƒ¨çš„APIï¼Œè®©äººæ— ä»ä¸‹æ‰‹ã€‚å»ºè®®åˆ° Github repo é‡Œæ‰¾åˆ°20å¹´çš„ï¼Œæˆ‘åŸºæœ¬æ˜¯æ ¹æ®é‡Œé¢å®šä¹‰çš„å‡½æ•°æ¥å®ç°çš„ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;å®éªŒææ–™&lt;del&gt;è´´å¿ƒçš„&lt;/del&gt;ä¸ºä½ åˆ†æˆäº†ä¸¤ä¸ªæ£€æŸ¥ç‚¹ï¼Œå››ä¸ªå°ä»»åŠ¡ã€‚&lt;/p&gt;
&lt;p&gt;Checkpoint #1&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Task #1 - B+Tree Pages&lt;/li&gt;
&lt;li&gt;Task #2 - B+Tree Data Structure (Insertion, Deletion, Point Search)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Checkpoint #2&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Task #3 - Index Iterator&lt;/li&gt;
&lt;li&gt;Task #4 - Concurrent Index&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;task-1---btree-pages&#34;&gt;Task #1 - B+Tree Pages&lt;/h2&gt;
&lt;p&gt;ç¬¬ä¸€ä¸ªä»»åŠ¡ç®—æ˜¯çƒ­èº«ï¼Œä¸»è¦æ˜¯ææ¸…æ¥š B+ æ ‘çš„ä¸€äº›ç±»ä¹‹é—´çš„å…³ç³»ã€‚
æˆ‘ä»¬çŸ¥é“ï¼Œæ•°æ®åº“ä¸­çš„ç´¢å¼•ä¹Ÿæ˜¯æ•°æ®ï¼ŒåŒæ ·ä»¥ page çš„å½¢å¼è¢«ç»„ç»‡ã€‚æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹è¦å®Œæˆçš„è¿™äº›ç±»ä¹‹é—´çš„å…³ç³»ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; src=&#34;https://caaatch22.github.io/img/busTub/B-tree/B-tree-page-relation.png&#34; alt=&#34;&#34;  /&gt;
&lt;/p&gt;
&lt;p&gt;&lt;code&gt;B+ tree internal page&lt;/code&gt; ä¸ &lt;code&gt;B + tree leaf page&lt;/code&gt; éƒ½ç»§æ‰¿è‡ª&lt;code&gt;B + tree page&lt;/code&gt;ï¼Œ&lt;code&gt;B + tree page&lt;/code&gt; ä¸­å®šä¹‰äº† B+ æ ‘æ¯ä¸ªç»“ç‚¹çš„ä¸€äº›ä¿¡æ¯ã€‚è€ŒB + Tree è¿™ä¸ªç±»åˆ™æ˜¯Checkpoint 1çš„ä¸»è¦å¯¹è±¡ï¼Œå®ƒå¯¹&lt;code&gt;internal page&lt;/code&gt; ä»¥åŠ &lt;code&gt;leaf page&lt;/code&gt; è¿›è¡Œç®¡ç†ï¼Œå¹¶å¯¹å¤–å¼€æ”¾æ¥å£ã€‚è€Œåœ¨å†…å­˜ä¸­ï¼Œinternal page ä¸ leaf page éƒ½å±äº page çš„ä¸€éƒ¨åˆ†ï¼Œå…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ä»–ä»¬å°±æ˜¯ &lt;code&gt;page&lt;/code&gt; ä¸­çš„ data éƒ¨åˆ†ã€‚å› æ­¤ï¼Œæ¯æ¬¡
ä» buffer pool manager å¾—åˆ°ä¸€ä¸ª page åï¼Œè‹¥æ˜¯å°†ä»–ä»¬ç”¨ä½œ B+æ ‘çš„ç»“ç‚¹ï¼Œåˆ™éœ€è¦å¯¹è¿™ä¸ª data è¿›è¡Œ&lt;strong&gt;é‡Šä¹‰&lt;/strong&gt;ï¼Œä¹Ÿå°±æ˜¯å°†ä»–å¼ºåˆ¶è½¬åŒ–ä¸ºinternal page æˆ–è€… leaf pageã€‚è¿™åœ¨ C++ ä¸­é€šè¿‡ &lt;a href=&#34;https://en.cppreference.com/w/cpp/language/reinterpret_cast&#34;&gt;&lt;strong&gt;reinterpret_cast&lt;/strong&gt;&lt;/a&gt; å®Œæˆã€‚&lt;/p&gt;</description>
      <content:encoded><![CDATA[<h2 id="overview">Overview</h2>
<blockquote>
<p>è¿™ä¸ªå®éªŒåº”è¯¥æ˜¯æœ€éš¾çš„ä¸€ä¸ªå®éªŒäº†ã€‚ã€‚ã€‚ï¼ˆæ„Ÿè§‰å’ŒProject 4 â€”â€” Transactionå®ç°çš„éš¾åº¦å·®ä¸å¤šï¼‰ å¦å¤–ï¼Œ2022fallç‰ˆæœ¬çš„B+ treeæ›´æ˜¯å˜æ€ï¼Œå› ä¸ºå‡ ä¹æ²¡æœ‰ç»™ä»»ä½•å†…éƒ¨çš„APIï¼Œè®©äººæ— ä»ä¸‹æ‰‹ã€‚å»ºè®®åˆ° Github repo é‡Œæ‰¾åˆ°20å¹´çš„ï¼Œæˆ‘åŸºæœ¬æ˜¯æ ¹æ®é‡Œé¢å®šä¹‰çš„å‡½æ•°æ¥å®ç°çš„ã€‚</p>
</blockquote>
<p>å®éªŒææ–™<del>è´´å¿ƒçš„</del>ä¸ºä½ åˆ†æˆäº†ä¸¤ä¸ªæ£€æŸ¥ç‚¹ï¼Œå››ä¸ªå°ä»»åŠ¡ã€‚</p>
<p>Checkpoint #1</p>
<ul>
<li>Task #1 - B+Tree Pages</li>
<li>Task #2 - B+Tree Data Structure (Insertion, Deletion, Point Search)</li>
</ul>
<p>Checkpoint #2</p>
<ul>
<li>Task #3 - Index Iterator</li>
<li>Task #4 - Concurrent Index</li>
</ul>
<h2 id="task-1---btree-pages">Task #1 - B+Tree Pages</h2>
<p>ç¬¬ä¸€ä¸ªä»»åŠ¡ç®—æ˜¯çƒ­èº«ï¼Œä¸»è¦æ˜¯ææ¸…æ¥š B+ æ ‘çš„ä¸€äº›ç±»ä¹‹é—´çš„å…³ç³»ã€‚
æˆ‘ä»¬çŸ¥é“ï¼Œæ•°æ®åº“ä¸­çš„ç´¢å¼•ä¹Ÿæ˜¯æ•°æ®ï¼ŒåŒæ ·ä»¥ page çš„å½¢å¼è¢«ç»„ç»‡ã€‚æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹è¦å®Œæˆçš„è¿™äº›ç±»ä¹‹é—´çš„å…³ç³»ã€‚</p>
<p><img loading="lazy" src="/img/busTub/B-tree/B-tree-page-relation.png" alt=""  />
</p>
<p><code>B+ tree internal page</code> ä¸ <code>B + tree leaf page</code> éƒ½ç»§æ‰¿è‡ª<code>B + tree page</code>ï¼Œ<code>B + tree page</code> ä¸­å®šä¹‰äº† B+ æ ‘æ¯ä¸ªç»“ç‚¹çš„ä¸€äº›ä¿¡æ¯ã€‚è€ŒB + Tree è¿™ä¸ªç±»åˆ™æ˜¯Checkpoint 1çš„ä¸»è¦å¯¹è±¡ï¼Œå®ƒå¯¹<code>internal page</code> ä»¥åŠ <code>leaf page</code> è¿›è¡Œç®¡ç†ï¼Œå¹¶å¯¹å¤–å¼€æ”¾æ¥å£ã€‚è€Œåœ¨å†…å­˜ä¸­ï¼Œinternal page ä¸ leaf page éƒ½å±äº page çš„ä¸€éƒ¨åˆ†ï¼Œå…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ä»–ä»¬å°±æ˜¯ <code>page</code> ä¸­çš„ data éƒ¨åˆ†ã€‚å› æ­¤ï¼Œæ¯æ¬¡
ä» buffer pool manager å¾—åˆ°ä¸€ä¸ª page åï¼Œè‹¥æ˜¯å°†ä»–ä»¬ç”¨ä½œ B+æ ‘çš„ç»“ç‚¹ï¼Œåˆ™éœ€è¦å¯¹è¿™ä¸ª data è¿›è¡Œ<strong>é‡Šä¹‰</strong>ï¼Œä¹Ÿå°±æ˜¯å°†ä»–å¼ºåˆ¶è½¬åŒ–ä¸ºinternal page æˆ–è€… leaf pageã€‚è¿™åœ¨ C++ ä¸­é€šè¿‡ <a href="https://en.cppreference.com/w/cpp/language/reinterpret_cast"><strong>reinterpret_cast</strong></a> å®Œæˆã€‚</p>
<p><img loading="lazy" src="/img/busTub/B-tree/pages.png" alt=""  />
</p>
<p>ç„¶åå°±æ˜¯ä¸€äº›getterï¼Œsetterçš„å®ç°ã€‚è¿™ä¸ª <code>MappingType array[1]</code> æ˜¯ä¸ªå¥‡æŠ€æ·«å·§å«<a href="https://en.wikipedia.org/wiki/Flexible_array_member">flexible array member</a>ï¼Œç”±äºæ•´ä¸ªinternal pageçš„å¤§å°æ˜¯ç¡®å®šçš„ï¼ˆç”±data[buffer_size]è½¬ä¹‰è€Œæ¥ï¼‰ï¼Œè¿™ä¸ª array çš„å¤§å°å°±æ˜¯å»æ‰ headeråçš„å¤§å°ã€‚ï¼ˆå¦å¤–ï¼Œå®é™…ä¸Šåº”è¯¥å†™ä½œ <code>MappingType array[0]</code>ï¼Œä¸ç„¶è¿‡ä¸äº† check-formatï¼‰ã€‚</p>
<h2 id="task-2---btree-data-structure-insertion-deletion-point-search">Task #2 - B+Tree Data Structure (Insertion, Deletion, Point Search)</h2>
<p>è¿™ä¸ªä»»åŠ¡å°±æ˜¯æœ¬å®éªŒæœ€ä¸ºæ ¸å¿ƒçš„ä¸€ç‚¹â€”â€”å®ç°åŸºäºç£ç›˜çš„ B+ æ ‘æ•°æ®ç»“æ„ã€‚è¿™é‡Œä¸ä¼šè¯¦ç»†å±•å¼€ï¼Œå› ä¸ºè¿‡äºå¤æ‚ä¸”å¾ˆå¤šç»†èŠ‚<del>å› ä¸ºå¿˜å…‰äº†</del>ã€‚ç»™ä¸ª<a href="https://github.com/cmu-db/bustub/blob/1cc1bb2f7b0746c67a974c0554c843ac35519315/src/storage/index/b_plus_tree.cpp">20å¹´fall</a>çš„B+ treeï¼ŒåŠŸèƒ½æ˜¯ä¸€æ ·çš„ï¼Œä½†æ˜¯æä¾›äº†å®Œå–„çš„å†…éƒ¨æ¥å£ï¼Œç…§ç€è¿™ä¸ªå’Œä¹¦ä¸Šå®Œæˆè¦æ¸…æ™°ä¸å°‘ã€‚</p>
<h3 id="debug">debug</h3>
<p>TAså‡†å¤‡äº†b_plus_tree_printerå·¥å…·ï¼Œå¹¶ä¸”å·²ç»å‡†å¤‡çš„Draw/ToStringæ–¹æ³•ï¼Œå–„ç”¨å®ƒä»¬å°†B+æ ‘å¯è§†åŒ–ï¼Œæ›´å¥½çš„è§‚å¯Ÿæ’å…¥ã€åˆ é™¤è¡Œä¸ºæ˜¯å¦æ­£ç¡®ã€‚ ç¤ºä¾‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> step <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;     
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">auto</span> key : keys) {       
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int64_t</span> value <span style="color:#f92672">=</span> key <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xFFFFFFFF</span>;       
</span></span><span style="display:flex;"><span>  rid.Set(<span style="color:#66d9ef">static_cast</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">int32_t</span><span style="color:#f92672">&gt;</span>(key <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">32</span>), value);       
</span></span><span style="display:flex;"><span>  index_key.SetFromInteger(key);       
</span></span><span style="display:flex;"><span>  tree.Insert(index_key, rid, transaction);       
</span></span><span style="display:flex;"><span>  tree.Draw(bpm, <span style="color:#e6db74">&#34;xxxxx/InsertTest_step&#34;</span> <span style="color:#f92672">+</span> std<span style="color:#f92672">::</span>to_string(step<span style="color:#f92672">++</span>) <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;_insert&#34;</span> <span style="color:#f92672">+</span> std<span style="color:#f92672">::</span>to_string(key) <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;.dot&#34;</span>);     
</span></span><span style="display:flex;"><span>}     
</span></span><span style="display:flex;"><span>tree.Draw(bpm, <span style="color:#e6db74">&#34;xxxxxx/InsertTest_step.dot&#34;</span>);
</span></span></code></pre></div><p>å¾—åˆ°ç”Ÿæˆçš„æ–‡ä»¶åæ‰“å¼€ï¼Œå¯ä»¥å’Œ<a href="https://15445.courses.cs.cmu.edu/fall2022/bpt-printer/">reference solution</a>æ¯”è¾ƒã€‚</p>
<h2 id="task-3---index-iterator">Task #3 - Index Iterator</h2>
<p>æˆ‘æƒ³é‡ç‚¹è¯´ä¸‹è¿™ä¸ª iterator çš„å®ç°ï¼Œå› ä¸ºåœ¨è¿™ä¸ªå®éªŒä¸­ï¼Œæˆ‘è°ƒäº†æœ€ä¹…çš„ bug å°±å‡ºç°åœ¨è¿™ä¸ªå­ä»»åŠ¡ä¸­ã€‚ï¼ˆå®é™…ä¸Šå·²ç»è¿‡äº†lab-2çš„è¯„æµ‹å·²ç»è¿‡äº†ï¼Œæ˜¯åœ¨ lab3è¯„æµ‹æ—¶å‘ç”Ÿé”èµ„æºçš„é—®é¢˜ï¼‰</p>
<p>è®°å¾—å“ªä¸ªå¤§ä½¬è¯´è¿‡ï¼Œå¦‚ä½•çœ‹ä¸€ä¸ªäººçš„ C++ æ°´å¹³ï¼Œä»ä»–å†™çš„æ„é€ å‡½æ•°å°±å¯ä»¥ç•¥çª¥ä¸€äºŒã€‚C++ çš„æ„é€ å‡½æ•°å±å®èŠ±é‡Œèƒ¡å“¨ï¼Œ<code>copy ctor</code>, <code>copy assignment</code>, <code>move ctor</code>, <code>move assignment</code> , å†åŠ ä¸Š <code>initializatier list</code>ä»¥åŠæ¨¡æ¿&hellip; å“ªäº›è¦å†™ï¼Œå“ªäº›åº”å½“ç¦æ­¢éƒ½æ˜¯é—¨å­¦é—®ã€‚</p>
<p>æ ¹æ® <a href="https://zh.wikipedia.org/zh-hans/RAII">RAII</a> çš„æ€æƒ³ï¼ŒC++ çš„ contructorï¼ˆé…åˆdtorï¼‰è‚©è´Ÿäº†ç®¡ç†èµ„æºçš„ä½œç”¨ã€‚è¿™ä¸ªèµ„æºä¸çŸ¥åŒ…æ‹¬å†…å­˜èµ„æºï¼Œè¿˜åŒ…æ‹¬é”èµ„æºç­‰ç­‰ã€‚è€Œå¯¹äº Index iterator æ¥è¯´ï¼Œæ¯ä¸ª iterator éƒ½å¸¦æœ‰ä¸€ä¸ªéšå«çš„è¯»å±æ€§ï¼Œå¹¶å‘è¯»è¦æ±‚å¯¹ page ä¸Šè¯»é”ï¼Œä½†æ˜¯æˆ‘ä»¬çš„ iterator åˆä¸ç›´æ¥ç®¡ç† page èµ„æºï¼Œéœ€è¦é€šè¿‡ä¼ å…¥æŒ‡é’ˆï¼ˆç”¨shared_ptræœ€å¥½ï¼‰çš„æ–¹å¼å¯¹ page è¿›è¡Œæ“ä½œã€‚</p>
<p>æˆ‘ä»¬æ¥çœ‹è¿™ä¸ªä¾‹å­ åœ¨</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>index_iter_ <span style="color:#f92672">=</span> GetBPlusTreeIndex()<span style="color:#f92672">-&gt;</span>GetBeginIterator();
</span></span></code></pre></div><p>è¿™æ˜¯lab3ä¸­ç”¨åˆ°ç´¢å¼•è¿­ä»£å™¨çš„ä¸€ä¸ªåœ°æ–¹çš„ä»£ç ã€‚æ³¨æ„åˆ°è¿™ä¼šäº§ç”Ÿä¸€ä¸ªä¸´æ—¶å¯¹è±¡ï¼Œå¹¶æŠŠå®ƒèµ‹å€¼ç»™ index_iter_ã€‚å¦‚æœæˆ‘ä»¬åœ¨ææ„çš„æ—¶å€™é‡Šæ”¾äº†å¯¹åº” page çš„é”è€Œæ²¡æœ‰å†™<code>copy assignment</code>ï¼Œç¼–è¯‘å™¨ç”Ÿæˆçš„assignmentæ˜¯ä¸ä¼šåœ¨èµ‹å€¼çš„æ—¶å€™ä¸ºpageä¸Šé”çš„ã€‚</p>
<p>è¿™ä¸ªbugå½’æ ¹ç»“åº•åœ¨äºï¼Œæˆ‘ä»¬çš„è¿­ä»£å™¨åº”è¯¥æ˜¯ <strong>å€¼è¯­ä¹‰(value semantic)</strong> çš„ï¼ˆè‡³å°‘å¯¹äºé”èµ„æºæ¥è®²ï¼‰</p>
<p>æˆ‘ä»¬ç”¨ <strong>copy and swap</strong> idiom æ¥è§£å†³è¿™ä¸ªé—®é¢˜</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>INDEX_TEMPLATE_ARGUMENTS
</span></span><span style="display:flex;"><span>INDEXITERATOR_TYPE<span style="color:#f92672">::</span>IndexIterator(BufferPoolManager <span style="color:#f92672">*</span>bpm, Page <span style="color:#f92672">*</span>page, <span style="color:#66d9ef">int</span> index, page_id_t page_id)
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">:</span> bpm_(bpm), page_(page), index_(index), page_id_(page_id) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (page <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nullptr</span>) {
</span></span><span style="display:flex;"><span>    leaf_ <span style="color:#f92672">=</span> <span style="color:#66d9ef">reinterpret_cast</span><span style="color:#f92672">&lt;</span>LeafPage <span style="color:#f92672">*&gt;</span>(page<span style="color:#f92672">-&gt;</span>GetData());
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    leaf_ <span style="color:#f92672">=</span> <span style="color:#66d9ef">nullptr</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>INDEX_TEMPLATE_ARGUMENTS
</span></span><span style="display:flex;"><span>INDEXITERATOR_TYPE<span style="color:#f92672">::</span>IndexIterator(<span style="color:#66d9ef">const</span> IndexIterator <span style="color:#f92672">&amp;</span>rhs)
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">:</span> bpm_(rhs.bpm_), index_(rhs.index_), page_id_(rhs.page_id_), leaf_(rhs.leaf_) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (page_id_ <span style="color:#f92672">!=</span> INVALID_PAGE_ID) {
</span></span><span style="display:flex;"><span>    page_ <span style="color:#f92672">=</span> bpm_<span style="color:#f92672">-&gt;</span>FetchPage(page_id_);
</span></span><span style="display:flex;"><span>    page_<span style="color:#f92672">-&gt;</span>RLatch();
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>INDEX_TEMPLATE_ARGUMENTS
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">auto</span> INDEXITERATOR_TYPE<span style="color:#f92672">::</span><span style="color:#66d9ef">operator</span><span style="color:#f92672">=</span>(IndexIterator rhs) <span style="color:#f92672">-&gt;</span> IndexIterator <span style="color:#f92672">&amp;</span> {
</span></span><span style="display:flex;"><span>  Swap(<span style="color:#f92672">*</span><span style="color:#66d9ef">this</span>, rhs);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">this</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">friend</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">Swap</span>(IndexIterator <span style="color:#f92672">&amp;</span>lhs, IndexIterator <span style="color:#f92672">&amp;</span>rhs) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">using</span> std<span style="color:#f92672">::</span>swap;
</span></span><span style="display:flex;"><span>  swap(lhs.bpm_, rhs.bpm_);
</span></span><span style="display:flex;"><span>  swap(lhs.page_, rhs.page_);
</span></span><span style="display:flex;"><span>  swap(lhs.index_, rhs.index_);
</span></span><span style="display:flex;"><span>  swap(lhs.page_id_, rhs.page_id_);
</span></span><span style="display:flex;"><span>  swap(lhs.leaf_, rhs.leaf_);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="task-4---index-iterator">Task #4 - Index Iterator</h2>
<p>è¿™æ˜¯å¹¶å‘ B+ æ ‘çš„é‡ç‚¹ã€‚æˆ‘ä»¬è¦ä½¿æ­¤å‰å®ç°çš„ B+ æ ‘æ”¯æŒå¹¶å‘çš„ Search/Insert/Delete æ“ä½œã€‚æ•´æ£µæ ‘ä¸€æŠŠé”é€»è¾‘ä¸Šæ¥è¯´å½“ç„¶æ˜¯å¯ä»¥çš„ï¼Œä½†æ€§èƒ½è‚¯å®šä¸è¡Œï¼Œæˆ‘ä»¬éœ€è¦æ›´åŠ ç»†ç²’åº¦çš„é”ç®¡ç†ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ä¼šä½¿ç”¨ä¸€ç§ç‰¹æ®Šçš„åŠ é”æ–¹å¼ï¼Œå«åš latch crabbingã€‚é¡¾åæ€ä¹‰ï¼Œå°±åƒèƒèŸ¹ä¸€æ ·ï¼Œç§»åŠ¨ä¸€åªè„šï¼Œæ”¾ä¸‹ï¼Œç§»åŠ¨å¦ä¸€åªè„šï¼Œå†æ”¾ä¸‹ã€‚åŸºæœ¬æ€æƒ³æ˜¯ï¼š</p>
<ol>
<li>å…ˆé”ä½ parent pageï¼Œ</li>
<li>å†é”ä½ child pageï¼Œ</li>
<li>å‡è®¾ child page æ˜¯å®‰å…¨çš„ï¼Œåˆ™é‡Šæ”¾ parent page çš„é”ã€‚å®‰å…¨æŒ‡å½“å‰ page åœ¨å½“å‰æ“ä½œä¸‹ä¸€å®šä¸ä¼šå‘ç”Ÿ split/steal/mergeã€‚åŒæ—¶ï¼Œå®‰å…¨å¯¹ä¸åŒæ“ä½œçš„å®šä¹‰æ˜¯ä¸åŒçš„ï¼ŒSearch æ—¶ï¼Œä»»ä½•èŠ‚ç‚¹éƒ½å®‰å…¨ï¼›Insert æ—¶ï¼Œåˆ¤æ–­ max sizeï¼›Delete æ—¶ï¼Œåˆ¤æ–­ min sizeã€‚</li>
</ol>
<p>è¿™ä¹ˆåšçš„åŸå› å’Œæ­£ç¡®æ€§è¿˜æ˜¯æ¯”è¾ƒæ˜æ˜¾çš„ã€‚å½“ page ä¸ºå®‰å…¨çš„æ—¶å€™ï¼Œå½“å‰æ“ä½œä»…å¯èƒ½æ”¹å˜æ­¤ page åŠå…¶ child page çš„å€¼ï¼Œå› æ­¤å¯ä»¥æå‰é‡Šæ”¾æ‰å…¶ç¥–å…ˆçš„é”æ¥æé«˜å¹¶å‘æ€§èƒ½ã€‚</p>
<p>æœ€åæ˜¯ACæˆªå›¾ï¼š</p>
<p><img loading="lazy" src="/img/busTub/B-tree/p2-result.png" alt=""  />
</p>
<h2 id="resources">Resources</h2>
<ul>
<li><a href="https://15445.courses.cs.cmu.edu/fall2022">è¯¾ç¨‹å®˜ç½‘</a></li>
<li><a href="https://github.com/cmu-db/bustub">Github Repo</a></li>
<li><a href="https://www.youtube.com/watch?v=uikbtpVZS2s&amp;list=PLSE8ODhjZXjaKScG3l0nuOiDTTqpfnWFf&amp;ab_channel=CMUDatabaseGroup">Youtubeè¯¾ç¨‹è§†é¢‘ 2022fall</a> ï¼ˆå¦‚æœå¯¹è‹±æ–‡å­—å¹•æœ‰å‹åŠ›çš„è¯å¯ä»¥åœ¨ chrome æ’ä»¶é‡Œä¸‹ä¸ªä¸­è‹±æ–‡åŒå­—å¹•æ’ä»¶ï¼‰</li>
</ul>
]]></content:encoded>
    </item>
    
    <item>
      <title>CMU15445-project1 Buffer Pool Manager</title>
      <link>https://caaatch22.github.io/posts/cmu15445-project1-buffer-pool-manager/</link>
      <pubDate>Thu, 22 Dec 2022 15:37:34 +0000</pubDate>
      
      <guid>https://caaatch22.github.io/posts/cmu15445-project1-buffer-pool-manager/</guid>
      <description>&lt;h1 id=&#34;buffer-pool-manager&#34;&gt;Buffer Pool Manager&lt;/h1&gt;
&lt;blockquote&gt;
&lt;p&gt;cmu15445 æ˜¯ä¸€é—¨å…³äºæ•°æ®åº“ç®¡ç†ç³»ç»Ÿï¼ˆDBMSï¼‰è®¾è®¡ä¸å®ç°çš„ç»å…¸å…¬å¼€è¯¾ï¼Œæ˜¯å¾ˆå¤šdbaå’Œå†…æ ¸å¼€å‘äººå‘˜çš„å…¥é—¨è¯¾ç¨‹ã€‚å¼€è¯¾æ•™æˆAndy Pavlo éå¸¸é£è¶£å¹½é»˜ï¼Œä»–æœ‰è‡ªå·±ä¸Šè¯¾çš„DJï¼Œä»–æ›¾åœ¨æµ´ç¼¸é‡Œå½•è¯¾ï¼Œä¸”æ—¶å¸¸è¯­å‡ºæƒŠäººã€‚è¿™é—¨è¯¾çš„å®éªŒé¡¹ç›®BusTubéå¸¸æœ‰æŒ‘æˆ˜æ€§ï¼Œå¹¶å¯¹æ‰€æœ‰äººå¼€æ”¾è¯„æµ‹èµ„æºã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&#34;overview&#34;&gt;Overview&lt;/h2&gt;
&lt;p&gt;BusTubæ˜¯ä¸€ä¸ªé¢å‘ç£ç›˜çš„ DBMS(Database Management System)ã€‚ç”±äºç£ç›˜ä¸Šçš„æ•°æ®ä¸æ”¯æŒå­—èŠ‚ç²’åº¦çš„è®¿é—®ï¼Œè¿™å°±éœ€è¦ä¸€ä¸ªç®¡ç†é¡µçš„ä¸­é—´å±‚ï¼Œè€Œ Andy åšæŒ&lt;a href=&#34;https://db.cs.cmu.edu/mmap-cidr2022/&#34;&gt;&amp;ldquo;The OS is not your friend&amp;rdquo;&lt;/a&gt;ï¼Œ åå¯¹ä½¿ç”¨ mmap è¿›è¡Œé¡µæ“ä½œï¼Œå› æ­¤å®éªŒä¸€çš„ç›®æ ‡ä¾¿åœ¨äºé€šè¿‡å®ç° Buffer Pool Manager ä¸»åŠ¨ç®¡ç†ç£ç›˜ä¸­çš„é¡µï¼ˆpageï¼‰åœ¨å†…å­˜ä¸­çš„ç¼“å­˜ï¼Œä»è€Œï¼Œæœ€å°åŒ–ç£ç›˜è®¿é—®æ¬¡æ•°ï¼ˆæ—¶é—´ä¸Šï¼‰ã€æœ€å¤§åŒ–ç›¸å…³æ•°æ®è¿ç»­ï¼ˆç©ºé—´ä¸Šï¼‰ã€‚&lt;/p&gt;
&lt;p&gt;è¿™æ¬¡å®éªŒæœ‰ä¸‰ä¸ªå­ä»»åŠ¡ï¼Œåˆ†åˆ«æ˜¯&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Task #1: Extendible Hash Table&lt;/li&gt;
&lt;li&gt;Task #2: LRU-K Replacer&lt;/li&gt;
&lt;li&gt;Task #3: Buffer Pool Manager Instance&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;å¯æ‹“å±•å“ˆå¸Œè¡¨æ˜¯è¿™ä¸ªæ˜¯å®éªŒä¸­ç›¸å¯¹ç‹¬ç«‹çš„æ¨¡å—ã€‚è¿™é‡Œä¸ä¼šè®²å®ƒçš„ç»†èŠ‚ï¼Œåé¢çš„ä¸¤ä¸ªä»»åŠ¡ä¸­éœ€è¦ç”¨åˆ°å“ˆå¸Œè¡¨çš„åœ°æ–¹æˆ‘ç›´æ¥ç”¨std::unordered_mapæ›¿ä»£ï¼Œè€Œä¸”æ•ˆç‡è¿˜æ›´é«˜ã€‚åº”è¯¥æ˜¯å› ä¸º Extendible Hash Table è¦æ±‚çº¿ç¨‹å®‰å…¨ï¼Œä¸ºäº†æ–¹ä¾¿åœ¨æˆ‘åœ¨æ¯ä¸ªå‡½æ•°å…¥å£éƒ½åŠ äº†å¤§é”ã€‚
æƒ³è¦ Extendible Hash Table å…·ä½“ç»†èŠ‚çš„å¯ä»¥çœ‹è¿™ä¸ª&lt;a href=&#34;https://www.bilibili.com/video/BV1nV4y1N7LM/?spm_id_from=333.788&amp;amp;vd_source=11c680307875dda5d5b5c13fca2e5c57&#34;&gt;bç«™è§†é¢‘&lt;/a&gt;ã€‚å…³äºå®ƒçš„ä¼˜åŒ–ï¼Œæˆ‘æƒ³å¯ä»¥è¿›è¡Œæ›´ç»†ç²’åº¦çš„é”ç®¡ç†ç”šè‡³å†™ä¸€ä¸ªæ— é”(lockfree)çš„å“ˆå¸Œè¡¨ã€‚&lt;/p&gt;
&lt;h2 id=&#34;buffer-pool-manager-1&#34;&gt;Buffer Pool Manager&lt;/h2&gt;
&lt;p&gt;åœ¨åä¸¤ä¸ªå®éªŒå¼€å§‹ä¹‹å‰ï¼Œæˆ‘å»ºè®®å…ˆå°†Task #2å’ŒTask #3çš„&lt;a href=&#34;https://15445.courses.cs.cmu.edu/fall2022/project1/&#34;&gt;å®éªŒææ–™&lt;/a&gt;å®Œæ•´çš„çœ‹å®Œåœ¨å¼€å§‹å†™ä»£ç ã€‚å› ä¸º &lt;code&gt;replacer&lt;/code&gt; å’Œ &lt;code&gt;buffer pool manager&lt;/code&gt; æœ‰è¾ƒå¤§ç¨‹åº¦çš„è€¦åˆã€‚å¾ˆå¤šAPIè®¾è®¡éœ€è¦å¯¹ç…§ä¸¤ä¸ªç»„ä»¶æ‰èƒ½çŸ¥é“è‡ªå·±åº”è¯¥ç»´æŠ¤çš„æ•°æ®ä¸åŠŸèƒ½çš„è¾¹ç•Œã€‚ä¸ºäº†æ›´ç¬¦åˆç›´è§‰ï¼Œæˆ‘ä¼šå…ˆé˜è¿° &lt;code&gt;buffer pool manager&lt;/code&gt; çš„è®¾è®¡ï¼ŒåŒæ—¶ä¼šç©¿æ’ç€ &lt;code&gt;LRU-k&lt;/code&gt; çš„APIä»€ä¹ˆæ—¶å€™ï¼Œåœ¨å“ªç”¨ã€‚&lt;/p&gt;</description>
      <content:encoded><![CDATA[<h1 id="buffer-pool-manager">Buffer Pool Manager</h1>
<blockquote>
<p>cmu15445 æ˜¯ä¸€é—¨å…³äºæ•°æ®åº“ç®¡ç†ç³»ç»Ÿï¼ˆDBMSï¼‰è®¾è®¡ä¸å®ç°çš„ç»å…¸å…¬å¼€è¯¾ï¼Œæ˜¯å¾ˆå¤šdbaå’Œå†…æ ¸å¼€å‘äººå‘˜çš„å…¥é—¨è¯¾ç¨‹ã€‚å¼€è¯¾æ•™æˆAndy Pavlo éå¸¸é£è¶£å¹½é»˜ï¼Œä»–æœ‰è‡ªå·±ä¸Šè¯¾çš„DJï¼Œä»–æ›¾åœ¨æµ´ç¼¸é‡Œå½•è¯¾ï¼Œä¸”æ—¶å¸¸è¯­å‡ºæƒŠäººã€‚è¿™é—¨è¯¾çš„å®éªŒé¡¹ç›®BusTubéå¸¸æœ‰æŒ‘æˆ˜æ€§ï¼Œå¹¶å¯¹æ‰€æœ‰äººå¼€æ”¾è¯„æµ‹èµ„æºã€‚</p>
</blockquote>
<h2 id="overview">Overview</h2>
<p>BusTubæ˜¯ä¸€ä¸ªé¢å‘ç£ç›˜çš„ DBMS(Database Management System)ã€‚ç”±äºç£ç›˜ä¸Šçš„æ•°æ®ä¸æ”¯æŒå­—èŠ‚ç²’åº¦çš„è®¿é—®ï¼Œè¿™å°±éœ€è¦ä¸€ä¸ªç®¡ç†é¡µçš„ä¸­é—´å±‚ï¼Œè€Œ Andy åšæŒ<a href="https://db.cs.cmu.edu/mmap-cidr2022/">&ldquo;The OS is not your friend&rdquo;</a>ï¼Œ åå¯¹ä½¿ç”¨ mmap è¿›è¡Œé¡µæ“ä½œï¼Œå› æ­¤å®éªŒä¸€çš„ç›®æ ‡ä¾¿åœ¨äºé€šè¿‡å®ç° Buffer Pool Manager ä¸»åŠ¨ç®¡ç†ç£ç›˜ä¸­çš„é¡µï¼ˆpageï¼‰åœ¨å†…å­˜ä¸­çš„ç¼“å­˜ï¼Œä»è€Œï¼Œæœ€å°åŒ–ç£ç›˜è®¿é—®æ¬¡æ•°ï¼ˆæ—¶é—´ä¸Šï¼‰ã€æœ€å¤§åŒ–ç›¸å…³æ•°æ®è¿ç»­ï¼ˆç©ºé—´ä¸Šï¼‰ã€‚</p>
<p>è¿™æ¬¡å®éªŒæœ‰ä¸‰ä¸ªå­ä»»åŠ¡ï¼Œåˆ†åˆ«æ˜¯</p>
<ul>
<li>Task #1: Extendible Hash Table</li>
<li>Task #2: LRU-K Replacer</li>
<li>Task #3: Buffer Pool Manager Instance</li>
</ul>
<p>å¯æ‹“å±•å“ˆå¸Œè¡¨æ˜¯è¿™ä¸ªæ˜¯å®éªŒä¸­ç›¸å¯¹ç‹¬ç«‹çš„æ¨¡å—ã€‚è¿™é‡Œä¸ä¼šè®²å®ƒçš„ç»†èŠ‚ï¼Œåé¢çš„ä¸¤ä¸ªä»»åŠ¡ä¸­éœ€è¦ç”¨åˆ°å“ˆå¸Œè¡¨çš„åœ°æ–¹æˆ‘ç›´æ¥ç”¨std::unordered_mapæ›¿ä»£ï¼Œè€Œä¸”æ•ˆç‡è¿˜æ›´é«˜ã€‚åº”è¯¥æ˜¯å› ä¸º Extendible Hash Table è¦æ±‚çº¿ç¨‹å®‰å…¨ï¼Œä¸ºäº†æ–¹ä¾¿åœ¨æˆ‘åœ¨æ¯ä¸ªå‡½æ•°å…¥å£éƒ½åŠ äº†å¤§é”ã€‚
æƒ³è¦ Extendible Hash Table å…·ä½“ç»†èŠ‚çš„å¯ä»¥çœ‹è¿™ä¸ª<a href="https://www.bilibili.com/video/BV1nV4y1N7LM/?spm_id_from=333.788&amp;vd_source=11c680307875dda5d5b5c13fca2e5c57">bç«™è§†é¢‘</a>ã€‚å…³äºå®ƒçš„ä¼˜åŒ–ï¼Œæˆ‘æƒ³å¯ä»¥è¿›è¡Œæ›´ç»†ç²’åº¦çš„é”ç®¡ç†ç”šè‡³å†™ä¸€ä¸ªæ— é”(lockfree)çš„å“ˆå¸Œè¡¨ã€‚</p>
<h2 id="buffer-pool-manager-1">Buffer Pool Manager</h2>
<p>åœ¨åä¸¤ä¸ªå®éªŒå¼€å§‹ä¹‹å‰ï¼Œæˆ‘å»ºè®®å…ˆå°†Task #2å’ŒTask #3çš„<a href="https://15445.courses.cs.cmu.edu/fall2022/project1/">å®éªŒææ–™</a>å®Œæ•´çš„çœ‹å®Œåœ¨å¼€å§‹å†™ä»£ç ã€‚å› ä¸º <code>replacer</code> å’Œ <code>buffer pool manager</code> æœ‰è¾ƒå¤§ç¨‹åº¦çš„è€¦åˆã€‚å¾ˆå¤šAPIè®¾è®¡éœ€è¦å¯¹ç…§ä¸¤ä¸ªç»„ä»¶æ‰èƒ½çŸ¥é“è‡ªå·±åº”è¯¥ç»´æŠ¤çš„æ•°æ®ä¸åŠŸèƒ½çš„è¾¹ç•Œã€‚ä¸ºäº†æ›´ç¬¦åˆç›´è§‰ï¼Œæˆ‘ä¼šå…ˆé˜è¿° <code>buffer pool manager</code> çš„è®¾è®¡ï¼ŒåŒæ—¶ä¼šç©¿æ’ç€ <code>LRU-k</code> çš„APIä»€ä¹ˆæ—¶å€™ï¼Œåœ¨å“ªç”¨ã€‚</p>
<p><strong>Buffer Pool Manager</strong> ç»´æŠ¤çš„æ•°æ®çš„åŸºæœ¬å•ä½ä¸ºä¸€æ®µé€»è¾‘è¿ç»­çš„å­—èŠ‚æ•°ç»„ï¼Œåœ¨ç£ç›˜ä¸Šè¡¨ç°ä¸º<strong>é¡µï¼ˆpageï¼‰</strong>ï¼Œé¡µå†…éƒ¨ç»“æ„æœ‰è‡ªå·±çš„ä¸€äº›ç»“æ„ï¼ˆåŒ…æ‹¬header, contentç­‰ï¼‰ï¼Œåœ¨è¿™ä¸ªå®éªŒä¸­æˆ‘ä»¬åªå…³å¿ƒ <code>page_id_</code> (é¡µçš„å”¯ä¸€æ ‡è¯†)ï¼Œ <code>pin_conut_</code> ä»¥åŠ <code>is_dirty_</code> ã€‚å¯¹åº”åœ¨å†…å­˜ä¸Šï¼Œæˆ‘ä»¬ç”¨ <strong>frame</strong> è¿™ä¸ªè¯ä»£è¡¨ <strong>æ¡†</strong>ï¼Œå°±æ˜¯è£…ç€æŸä¸ªç‰©ç†é¡µçš„æ¡†ã€‚åœ¨ä»£ç ä¸­å…¶å®å°±æ˜¯buffer poolç®¡ç†ç€ä¸€å¤§ç‰‡å†…å­˜ <code>Page pages[pool_size_]</code>ï¼Œä½†æ˜¯ buffer pool åˆå§‹åŒ–æ—¶ï¼ˆèµ„æºè·å–æ—¶ï¼‰æˆ‘ä»¬å¾—åˆ°çš„ pages å¹¶ä¸åŒ…å«æˆ‘ä»¬æƒ³è¦çš„é¡µï¼Œå®ƒé‡Œé¢çš„æ•°æ®æ˜¯æ²¡æœ‰æ„ä¹‰çš„ï¼Œä»è€Œå®ƒæ˜¯ä¸€ä¸ª<em>ç©ºçš„æ¡†</em>ã€‚frame_idæŒ‡çš„å°±æ˜¯è¿™ä¸ªæ•°ç»„çš„ä¸‹æ ‡ã€‚é‡Œé¢è£…çš„é¡µæœ‰è‡ªå·±çš„<code>page_id</code>ã€‚å¦å¤–ï¼Œæˆ‘ä»¬ç”¨ä¸€ä¸ªå“ˆå¸Œè¡¨<code>page_table_</code>ä¿å­˜ä» é¡µå·(page id) åˆ° æ¡†å·(frame_id) çš„æ˜ å°„ã€‚</p>
<!-- raw HTML omitted -->
<p>ç®¡ç†å¸§çš„å†…å­˜æ± å¤§å°ä¸€èˆ¬æ¥è¯´æ˜¯è¿œå°äºç£ç›˜çš„ï¼Œå› æ­¤åœ¨å†…å­˜æ± æ»¡äº†åï¼Œå†ä»ç£ç›˜åŠ è½½æ–°çš„é¡µåˆ°å†…å­˜æ± ï¼Œéœ€è¦æŸç§æ›¿æ¢ç­–ç•¥ï¼ˆreplacerï¼‰å°†ä¸€äº›ä¸å†ä½¿ç”¨çš„é¡µè¸¢å‡ºå†…å­˜æ± ä»¥è…¾å‡ºç©ºé—´ã€‚</p>
<p>buffer pool manager çš„<strong>å®ç°æ ¸å¿ƒ</strong>åœ¨äºå¯¹æ‰€æœ‰ page çš„çŠ¶æ€çš„ç®¡ç†ã€‚æ¯ä¸ªpageæœ‰å››ç§çŠ¶æ€ï¼š</p>
<ol>
<li><strong>Not Allocated(Not Exist):</strong> æˆ‘ä»¬å°†ä¸å­˜åœ¨çš„ page ä¹Ÿå½“ä½œä¸€ç§çŠ¶æ€</li>
<li><strong>Allocated but Not in MEM:</strong> allocated ä½†æ˜¯ä¸å­˜åœ¨äºå†…å­˜ä¸­ï¼ˆæŸä¸€æ—¶åˆ»å†…å­˜è£…çš„ page è¾¾åˆ°ä¸Šçº¿åè¢« evict å‡ºå†…å­˜ï¼‰</li>
<li><strong>Unpinned and in MEM:</strong> éšæ—¶å¯èƒ½è¢« evict</li>
<li><strong>Pinned(definitely in MEM)</strong></li>
</ol>
<p><strong>è¿™å‡ ç§çŠ¶æ€æ˜¯äº’æ–¥çš„</strong></p>
<p>å¾…å®ç°å‡½æ•°ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">auto</span> BufferPoolManagerInstance<span style="color:#f92672">::</span>NewPgImp(page_id_t <span style="color:#f92672">*</span>page_id) <span style="color:#f92672">-&gt;</span> Page <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">auto</span> BufferPoolManagerInstance<span style="color:#f92672">::</span>FetchPgImp(page_id_t page_id) <span style="color:#f92672">-&gt;</span> Page <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">auto</span> BufferPoolManagerInstance<span style="color:#f92672">::</span>UnpinPgImp(page_id_t page_id, <span style="color:#66d9ef">bool</span> is_dirty) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">bool</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">auto</span> BufferPoolManagerInstance<span style="color:#f92672">::</span>DeletePgImp(page_id_t page_id) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">bool</span>
</span></span></code></pre></div><p>ä¾¿æ˜¯é©±åŠ¨çŠ¶æ€æœºä¸­ä¸Šè¿°çŠ¶æ€å‘ç”Ÿæ”¹å˜çš„åŠ¨ä½œï¼ˆactionï¼‰ï¼Œï¼ˆæ³¨æ„ï¼š <em>AllocatePage å’Œ DeallocatePage</em>ä¸å¯¹å¤–éƒ¨å…¬å¼€ï¼‰ çŠ¶æ€æœºå¦‚ä¸‹ï¼š</p>
<!-- raw HTML omitted -->
<p>æ¯ä¸ªå‡½æ•°å£°æ˜å¤„çš„æ³¨é‡Šå·²ç»éå¸¸è¯¦ç»†çš„æè¿°äº†å‡½æ•°è¡Œä¸ºäº†ã€‚ä»¥ä¸‹åˆ—å‡ºä¸€äº›æˆ‘åœ¨åšçš„æ—¶å€™å®¹æ˜“å›°æƒ‘çš„ç‚¹ï¼š</p>
<ul>
<li><code>page_table_</code>ç»´æŠ¤çš„åªæ˜¯åœ¨å†…å­˜ä¸­çš„pageçš„<code>page_id</code>åˆ°<code>frame_id</code>çš„æ˜ å°„ã€‚ä¹Ÿå°±æ˜¯è¯´å®ƒä¸ä¿å­˜ <em>Allocated but not in MEM</em> çš„ pageï¼ˆå› ä¸ºåœ¨ç£ç›˜ä¸Šçš„pageä¹Ÿæ²¡æœ‰ä¸€ä¸ªåˆ° <code>frame_id</code> çš„æ˜ å°„ï¼‰</li>
<li><code>Unpin</code> æ“ä½œå¹¶ä¸ä¸€å®šä¼šä½¿ page å˜æˆ <em>Unpinned and in MEM</em>ï¼Œå› ä¸ºè¿™åªæ˜¯è¿™ä¸€ä¸ª <em>workerï¼ˆä¸€èˆ¬æ¥è¯´æ˜¯ä¸€ä¸ªthreadï¼‰</em> å¯¹è¯¥ page è¿›è¡Œ unpinï¼Œå…¶ä»–çº¿ç¨‹å¯èƒ½ä¹Ÿæ­£åœ¨è¯»å–è¿™ä¸ª page çš„å†…å®¹ã€‚ åªæœ‰å½“ æŸæ¬¡ Unpin æ“ä½œåï¼Œå®ƒçš„<code>pin_count_</code> ç­‰äº0æ—¶ï¼Œæ‰èƒ½è®©è¿™ä¸ª page å˜æˆ <code>evitable</code>çš„çŠ¶æ€ï¼ˆåœ¨ replacer ä¸­ç»´æŠ¤ï¼‰</li>
<li><code>AllocatePage</code> åªåœ¨ <code>NewPage</code>ä¸­ç”¨åˆ°ï¼Œ<code>DeallocatePage</code> åªåœ¨ <code>DeletePage</code> ä¸­ç”¨åˆ°</li>
<li><code>Unpin</code> çš„ <code>is_dirty</code> å‚æ•°ä¸º true æ—¶ï¼Œå°†è¿™ä¸ª page çš„<code>is_dirty_</code>è®¾ç½®ä¸ºtrueï¼Œ <strong>è€Œå½“å‚æ•°ä¸ºfalseæ—¶ï¼Œä¸å¯ä»¥å°†pageçš„ is_dirty_ è®¾ç½®ä¸ºfalse! è€Œåº”è¯¥ä¿æŒåŸ dirty çŠ¶æ€ä¸å˜</strong> å› ä¸º <code>is_dirty</code> å‚æ•°è¡¨ç¤ºçš„åªæ˜¯è¿™ä¸ªçº¿ç¨‹æ˜¯å¦å¯¹è¿™ä¸ª page æœ‰ä¿®æ”¹æ“ä½œã€‚ï¼ˆè¿™ä¸ªç‚¹å®³æˆ‘debugäº†å¥½ä¹…ï¼‰</li>
</ul>
<p>ç°åœ¨æˆ‘ä»¬å€ŸåŠ© replacer çš„ API æ¥ç†è§£ä¸€ä¸‹æ¯ä¸ª page åœ¨ä»–çš„ç”Ÿå‘½å‘¨æœŸä¸­éœ€è¦è¢«ç»´æŠ¤ä»€ä¹ˆå†…å®¹ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * å‘ç”Ÿåœ¨NewPageå’ŒFetchPageæ—¶ï¼Œä¸”free_list_ä¸ºç©º
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param[out] frame_id id of frame that is evicted.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">auto</span> <span style="color:#a6e22e">Evict</span>(frame_id_t <span style="color:#f92672">*</span>frame_id) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">bool</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* å‘ç”Ÿåœ¨NewPageå’ŒFetchPageä¸­ */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">RecordAccess</span>(frame_id_t frame_id);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/** åœ¨NewPageå’ŒFetchPage set_evictable è®¾ç½®ä¸º false
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *  åœ¨ Unpinåï¼Œpin_countä¸º0ä¸‹ set_evictable è®¾ç½®ä¸º true
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">SetEvictable</span>(frame_id_t frame_id, <span style="color:#66d9ef">bool</span> set_evictable);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* å‘ç”Ÿåœ¨DeletePageä¸­ */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">Remove</span>(frame_id_t frame_id);
</span></span></code></pre></div><p>ä»¥ FetchPageImpl ä¸ºä¾‹å¼ºè°ƒä¸‹ä¸€äº›å®ç°çš„ç»†èŠ‚ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">auto</span> BufferPoolManagerInstance<span style="color:#f92672">::</span>FetchPgImp(page_id_t page_id) <span style="color:#f92672">-&gt;</span> Page <span style="color:#f92672">*</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 1. ä¸Šé”ï¼
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// 2. æŸ¥çœ‹ page æ˜¯å¦åœ¨ page_table_ ä¸­
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">//  2.1 è‹¥åœ¨ 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">//   2.1.2 å¾—åˆ°frame_id, ç›®æ ‡ä¸ºpages[frame_id]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">//   2.1.3 ç›®æ ‡å†…éƒ¨çš„pin_countçŠ¶æ€ç»´æŠ¤
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">//   2.1.4 replacer ç»´æŠ¤recordAccesså’ŒsetEvictable
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">//   2.1.5 è¿”å›
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// 2.2 è‹¥ä¸åœ¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">//  2.2.1 æ‰¾ä¸€ä¸ªå¯ç”¨çš„ frame (å…ˆä»free listé‡Œæ‰¾ï¼Œæ²¡æœ‰åˆ™è®© replacer evictä¸€ä¸ª)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">//  2.2.2 æ¸…ç©ºframe_idä¸­åŸæ¥çš„ä¿¡æ¯ ï¼ˆåŒ…æ‹¬old_page dirtyçš„è¯å†™å›ç£ç›˜ï¼‰
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">//  2.2.3 ç»´æŠ¤ page_table (åˆ é™¤è¿™ä¸ªframe_idå¯¹åº”çš„old_pageçš„ä¿¡æ¯)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">//  2.2.4 è®¾ç½®æ–°çš„page_idï¼Œä»ç£ç›˜ä¸­è¯»å…¥ï¼Œå¹¶ç»´æŠ¤æ–° page å†…éƒ¨ä¿¡æ¯
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">//  2.2.5 ç»´æŠ¤ replacer ç›¸å…³
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">//  2.2.6 ç»´æŠ¤page_table 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">//  2.2.7 è¿”å›
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="lru-k-replacer">LRU-K Replacer</h2>
<p><strong>LRU-k evict policy</strong> æ˜¯è®©è®¿é—®æ¬¡æ•°æœªåˆ° k çš„ç»“ç‚¹ä¼šè¢«ä¼˜å…ˆ evict å‡ºå»ï¼ˆè¿™ä¹ˆåšæˆ–è®¸æ˜¯ä¸ºäº†é˜²æ­¢ä¸€äº›å¾®å°çš„ <em>æ‰°åŠ¨è®¿é—®</em> æ±¡æŸ“äº†åŸæ¥ç»å¸¸è®¿é—®çš„åŒºåŸŸï¼‰ï¼Œç„¶åå¯¹äºè®¿é—®æ¬¡æ•°åˆ°è¾¾ k æ¬¡çš„ç»“ç‚¹åˆ™æŒ‰ç…§æœ€è¿‘è®¿é—®æ—¶é—´ï¼ˆæˆ–é€»è¾‘ä¸Šçš„æ—¶é—´æˆ³ï¼‰æœ€ä¹…è¿œçš„è¢« evictã€‚ï¼ˆå®é™…ä¸ŠæŒ‰ç…§åŸå§‹è®ºæ–‡å’Œ slides ä¸Šçš„æ„æ€åº”è¯¥æ˜¯æœ€è¿‘è®¿é—®æ—¶é—´å’Œç¬¬å‰ k æ¬¡è®¿é—®æ—¶é—´<strong>ä¹‹å·®</strong>ç›¸å·®æœ€å¤§çš„è¢« evictï¼Œä½†æ˜¯æŒ‰ç…§å‰é¢çš„æ–¹æ³•ä¹Ÿè¿‡äº†ã€‚ã€‚ã€‚ï¼‰</p>
<ul>
<li><a href="https://www.cs.cmu.edu/~natassa/courses/15-721/papers/p297-o_neil.pdf">LRU-kçš„åŸå§‹è®ºæ–‡</a></li>
<li><a href="https://leetcode.cn/problems/lru-cache/">leetcodeä¸Šçš„lruç®—æ³•</a>ï¼Œä¸ç†Ÿæ‚‰çš„å¯ä»¥å…ˆè¯•è¯•</li>
</ul>
<p>é’ˆå¯¹ LRU-k ç®—æ³•ï¼Œæˆ‘å®ç°äº†ä¸¤ç§æ–¹æ³•ï¼Œç®€å•è¯´ä¸€ä¸‹æ€è·¯ã€‚</p>
<h3 id="æ–¹æ³•ä¸€">æ–¹æ³•ä¸€</h3>
<p>ç»´æŠ¤ä¸¤ä¸ªé“¾è¡¨ï¼Œä¸€ä¸ªå­˜æœªåˆ° k æ¬¡è®¿é—®çš„<code>frame_id</code>,å¦ä¸€ä¸ªå­˜å·²åˆ°ï¼ˆæˆ–è¶…è¿‡ï¼‰k æ¬¡è®¿é—®çš„ <code>frame_id</code>ï¼Œæˆ‘ä»¬åˆ†åˆ«å°†å…¶å«åš <code>history_list</code>ä»¥åŠ<code>cache_list</code>ã€‚</p>
<p>åŒæ—¶ç»´æŠ¤ä¸€ä¸ªä»<code>frame_id</code>åˆ° <code>FrameEntry</code>çš„å“ˆå¸Œè¡¨ï¼Œè¿™ä¸ª<code>FrameEntry</code>ä¿å­˜äº†<code>hit_count</code>ï¼Œ<code>evictible</code>ä»¥åŠä¸€ä¸ªlist&lt;frame_id_t&gt;çš„è¿­ä»£å™¨ã€‚</p>
<ul>
<li><strong>Evict:</strong> è‹¥ hist_list éç©ºï¼Œæ‰¾åˆ°ç¬¬ä¸€ä¸ª evictable çš„ frame å°†å…¶è¸¢å‡ºï¼Œå¦åˆ™æ‰¾cache_list ä¸­ç¬¬ä¸€ä¸ªevictable çš„ frameã€‚</li>
<li><strong>RecordAccess(frame_id):</strong>  é€šè¿‡ <code>FrameEntry</code> æŸ¥çœ‹ hit_count ï¼ˆ1ï¼‰è‹¥ä»–æ˜¯ç¬¬ä¸€æ¬¡è®¿é—®ï¼Œåˆ™å°†å…¶æ”¾åœ¨ history_list å°¾éƒ¨ï¼Œæ³¨æ„ï¼ŒåŒæ—¶è¿˜è¦ç»´æŠ¤è¿™ä¸ª frame_id åœ¨FrameEntry ä¸­çš„è¿­ä»£å™¨ ã€‚ï¼ˆ2ï¼‰è‹¥ new_count == k åˆ™åœ¨history_listä¸­åˆ å»è¿™ä¸ªframe(æ— éœ€éå†ï¼Œé€šè¿‡ä¿å­˜åœ¨å“ˆå¸Œè¡¨ä¸­çš„è¿­ä»£å™¨è¿›è¡Œ $\mathcal{O}(1)$ åˆ é™¤)ï¼Œæ·»åŠ åˆ° cache_list ä¸­ï¼ŒåŒæ—¶ç»´æŠ¤å“ˆå¸Œè¡¨ ï¼ˆ3ï¼‰new_count &gt; kï¼Œå°†è¿™ä¸ª frame_id ç§»åŠ¨åˆ° cache_list æœ€åï¼ˆåˆ é™¤å’Œæ·»åŠ éƒ½å¯ä»¥åšåˆ° $\mathcal{O}(1)$ ï¼‰</li>
<li><strong>SetEvictable</strong> å’Œ <strong>Remove</strong>éƒ½å¯ä»¥ç±»ä¼¼çš„æ“ä½œã€‚</li>
</ul>
<h3 id="æ–¹æ³•ä¸€æ—¶é—´å¤æ‚åº¦">æ–¹æ³•ä¸€æ—¶é—´å¤æ‚åº¦ï¼š</h3>
<p>å‡è®¾ history_list å’Œ cache_list ä¸­çš„å…ƒç´ ä¸ªæ•°éƒ½æ˜¯ nï¼Œ ä¸¤ä¸ªé˜Ÿåˆ—ä¸­ non-evictable çš„ä¸ªæ•°éƒ½ä¸º mï¼Œåˆ™ Evict çš„æ—¶é—´å¤æ‚åº¦ä¸º $\mathcal{O}(m)$ï¼ˆæœ€å·®éå† m ä¸ªå…ƒç´ ï¼‰ å…¶ä½™æ“ä½œæ—¶é—´å¤æ‚åº¦éƒ½æ˜¯ $\mathcal{O}(1)$ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒRecordAccess è¦æ¯” Evict ç»å¸¸ä½¿ç”¨çš„å¤šï¼Œä¸” Evict éå† m ä¸ªå…ƒç´ æ˜¯åœ¨ non-evictable page éƒ½åœ¨ evictable page çš„å…ˆå‰è®¿é—®ã€‚å®é™…ä¸Šå¯ä»¥çœ‹ä½œä¸€ä¸ªå¸¸æ•°ã€‚</p>
<h3 id="æ–¹æ³•äºŒ">æ–¹æ³•äºŒ</h3>
<p>ä¸ºäº†ç»å¯¹ $\mathcal{O}(1)$ çš„ evictï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨std::setï¼ˆçº¢é»‘æ ‘ï¼‰ï¼Œç»“ç‚¹å†…éƒ¨ç»´æŠ¤ <em>hit_count</em> å’Œ <em>åˆ°è¾¾æ—¶é—´</em>ï¼Œéœ€è¦é‡è½½&lt;=ï¼Œå°±å¯ä»¥è¾¾åˆ°ã€‚ä½†æ˜¯è¿™ç§åšæ³•ä¸ä»…å¸¸æ•°å¤§ï¼ˆç»“ç‚¹ä¹‹é—´æ¯”è¾ƒéœ€è¦å…ˆæ¯”è¾ƒè®¿é—®äº†kæ¬¡æ²¡æœ‰ï¼Œå¯¹åˆ°è¾¾kæ¬¡å’Œæ²¡åˆ°è¾¾kæ¬¡çš„ç»“ç‚¹è¿˜éœ€åˆ†åˆ«æ¯”è¾ƒï¼‰ï¼Œæ›´è‡´å‘½çš„æ˜¯å®ƒä½¿å¾— <code>RecordAccess(frame_id)</code>çš„å¤æ‚åº¦å˜æˆ $\mathcal{O}(log(n))$ ï¼ˆéœ€è¦ä¸€æ¬¡ findï¼Œ ä¸€æ¬¡ deleteï¼Œä¸€æ¬¡ insertï¼‰ã€‚</p>
<h2 id="summary">Summary</h2>
<p>è¿™æ˜¯å››ä¸ªå®éªŒï¼ˆä¸ç®—primerï¼‰ä¸­æœ€ç®€å•çš„ä¸€ä¸ªäº†ï¼Œå¦‚æœå®åœ¨å¡åœ¨æŸéƒ¨åˆ†çš„è¯è¯•è¯•é€šè¿‡åˆ†ææµ‹è¯•æ ·ä¾‹æ¥å¾—åˆ°é¢„æœŸè¡Œä¸ºï¼Œæˆ–è€…ä½¿ç”¨ gdb ï¼ˆå¯ä»¥ä½¿ç”¨ lldb é…åˆ vscode ä»£æ›¿å‘½ä»¤è¡Œæ¡ä»¶ä¸‹è¿›è¡Œè°ƒè¯•ï¼‰ã€‚ç›¸ä¿¡æˆ‘ï¼Œè¶Šæ—©å­¦ä¼šå¦‚ä½•è°ƒè¯•å¯¹åé¢è¶Šæœ‰ç›Šã€‚</p>
<p>æœ€åå½“ç„¶æ˜¯ AC æˆªå›¾äº†</p>
<p><img loading="lazy" src="/img/busTub/buffer_pool_manager/p1-result.png" alt=""  />
</p>
<h2 id="resources">Resources</h2>
<ul>
<li><a href="https://15445.courses.cs.cmu.edu/fall2022">è¯¾ç¨‹å®˜ç½‘</a></li>
<li><a href="https://github.com/cmu-db/bustub">Github Repo</a></li>
<li><a href="https://www.youtube.com/watch?v=uikbtpVZS2s&amp;list=PLSE8ODhjZXjaKScG3l0nuOiDTTqpfnWFf&amp;ab_channel=CMUDatabaseGroup">Youtubeè¯¾ç¨‹è§†é¢‘ 2022fall</a> ï¼ˆå¦‚æœå¯¹è‹±æ–‡å­—å¹•æœ‰å‹åŠ›çš„è¯å¯ä»¥åœ¨ chrome æ’ä»¶é‡Œä¸‹ä¸ªä¸­è‹±æ–‡åŒå­—å¹•æ’ä»¶ï¼‰</li>
</ul>
]]></content:encoded>
    </item>
    
  </channel>
</rss>
