<!DOCTYPE html>
<html lang="en" dir="auto">

<head>
	<meta name="generator" content="Hugo 0.140.1"><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Mingjie&#39;s Home</title>

<meta name="description" content="">
<meta name="author" content="">
<link rel="canonical" href="https://caaatch22.github.io/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.678b5c47efa744d2e0dd0d61101075e6aecdc9a0631e7ad8538f4ec0cca79273.css" integrity="sha256-Z4tcR&#43;&#43;nRNLg3Q1hEBB15q7NyaBjHnrYU49OwMynknM=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://caaatch22.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://caaatch22.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://caaatch22.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://caaatch22.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://caaatch22.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" type="application/rss+xml" href="https://caaatch22.github.io/index.xml">
<link rel="alternate" type="application/json" href="https://caaatch22.github.io/index.json">
<link rel="alternate" hreflang="en" href="https://caaatch22.github.io/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-WEG841BBW9"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-WEG841BBW9');
        }
      </script><meta property="og:title" content="Mingjie&#39;s Home" />
<meta property="og:description"
  content="" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://caaatch22.github.io/" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="Mingjie&#39;s Home" />
<meta name="twitter:description"
    content="" />

<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Organization",
  "name": "Mingjie's Home",
  "url": "https://caaatch22.github.io/",
  "description": "",
  "thumbnailUrl": "https://caaatch22.github.io/favicon.ico",
  "sameAs": [
      "https://github.com/caaatch22", "mailto:mr.liumingjie@gmail.com", "https://zhihu.com/people/lmj-catch22", "index.xml"
  ]
}
</script>
</head>

<body class="list" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://caaatch22.github.io/" accesskey="h" title="Mingjie&#39;s Home (Alt + H)">Mingjie&#39;s Home</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
                <ul class="lang-switch"><li>|</li>
                </ul>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://caaatch22.github.io/about/" title="About">
                    <span>About</span>
                </a>
            </li>
            <li>
                <a href="https://caaatch22.github.io/cv/" title="CV">
                    <span>CV</span>
                </a>
            </li>
            <li>
                <a href="https://caaatch22.github.io/archives/" title="Archives">
                    <span>Archives</span>
                </a>
            </li>
            <li>
                <a href="https://caaatch22.github.io/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main"> 
<article class="first-entry home-info">
    <header class="entry-header">
        <h1>Hi there ğŸ‘‹</h1>
    </header>
    <div class="entry-content">
        Chance favors the bold.
    </div>
    <footer class="entry-footer">
        <div class="social-icons">
    <a href="https://github.com/caaatch22" target="_blank" rel="noopener noreferrer me" title="Github">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path
        d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22">
    </path>
</svg>
    </a>
    <a href="mailto:mr.liumingjie@gmail.com" target="_blank" rel="noopener noreferrer me" title="Email">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 21" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
    <polyline points="22,6 12,13 2,6"></polyline>
</svg>
    </a>
    <a href="https://zhihu.com/people/lmj-catch22" target="_blank" rel="noopener noreferrer me" title="Zhihu">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" stroke="none" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path d="m13.3334,3.60098l0,17.1471l1.79582,0l0.75424,2.13703l3.18459,-2.13703l3.93584,0l0,-17.1471l-9.6705,0zm7.41375,14.87538l-1.79283,0l-2.24777,1.50849l-0.53276,-1.50849l-0.53875,0l0,-12.53483l5.10911,0l0,12.53483l0.00299,0zm-8.56906,-7.18927l-3.97475,0c0.06285,-1.34387 0.1287,-3.12174 0.19754,-5.17496l3.91788,0l-0.00299,-0.24244c0,-0.01796 -0.00599,-0.43998 -0.06884,-0.87097c-0.06285,-0.44896 -0.19754,-1.04457 -0.62854,-1.04457l-6.5727,0c0.13169,-0.61657 0.46991,-2.08615 0.87995,-2.80747l0.19155,-0.33522l-0.3861,-0.02095c-0.02394,0 -0.58663,-0.02694 -1.23912,0.31726c-1.06851,0.56868 -1.5474,1.68807 -1.75691,2.52612c-0.55072,2.18791 -1.33489,3.70837 -1.66712,4.35786c-0.09877,0.19155 -0.15863,0.30529 -0.18557,0.38311c-0.05387,0.14666 -0.02394,0.29332 0.0838,0.38909c0.31427,0.28434 1.14334,-0.0868 1.15232,-0.08979c0.01796,-0.00898 0.03891,-0.01796 0.06585,-0.02993c0.41603,-0.18856 1.64916,-0.74826 2.08914,-2.52911l1.69705,0c0.02095,0.96376 0.09278,4.14236 0.0868,5.17496l-4.22018,0l-0.06285,0.0449c-0.69139,0.50582 -0.91288,1.8916 -0.92185,1.95146l-0.0419,0.27536l4.99837,0c-0.36814,2.34355 -0.79315,3.3941 -1.01763,3.81313c-0.11074,0.20951 -0.21849,0.41902 -0.32025,0.62255c-0.63752,1.26306 -1.29898,2.56802 -3.7802,4.5973c-0.10775,0.0838 -0.20951,0.23944 -0.14367,0.41005c0.07183,0.18856 0.27835,0.27237 0.73629,0.27237c0.16162,0 0.35318,-0.00898 0.58065,-0.02993c1.49352,-0.13169 3.01698,-0.53875 4.04359,-2.6219c0.50882,-1.05056 0.94879,-2.14601 1.31394,-3.25941l4.08549,4.78886l0.14965,-0.35916c0.02394,-0.05687 0.56868,-1.38578 0.15264,-2.87032l-0.01497,-0.05387l-3.23547,-3.68143l-0.65847,0.49684c0.19155,-0.78118 0.31726,-1.49352 0.37413,-2.12805l4.74995,0l0,-0.23944c0,-1.20021 -0.55371,-1.91255 -0.57466,-1.94248l-0.07183,-0.08979z"/>
</svg>
    </a>
    <a href="index.xml" target="_blank" rel="noopener noreferrer me" title="Rss">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path d="M4 11a9 9 0 0 1 9 9" />
    <path d="M4 4a16 16 0 0 1 16 16" />
    <circle cx="5" cy="19" r="1" />
</svg>
    </a>
</div>

    </footer>
</article>

<article class="post-entry"> 
  <header class="entry-header">
    <h2>cuCollections
    </h2>
  </header>
  <div class="entry-content">
    <p> still draft, to be updated
å®ç°äº†ä¸€ä¸ªdynamic_mapçš„retrieve_all è®¿å­˜ç®—å­ï¼Œç»å…¸è¿‡æ»¤é—®é¢˜ï¼Œpredictä¸ºtrueçš„å…ƒç´ æ‹·è´åˆ°outæ•°ç»„ï¼Œé‡ç‚¹æ˜¯éœ€è¦ç»´æŠ¤ä¸€ä¸ª atomic çš„out index, https://developer.nvidia.com/blog/cuda-pro-tip-optimized-filtering-warp-aggregated-atomics/, ç¿»è¯‘ï¼šhttps://zhuanlan.zhihu.com/p/581078557
hostç«¯ï¼š
template &lt;typename Key, typename Value, cuda::thread_scope Scope, typename Allocator&gt; template &lt;typename KeyOut, typename ValueOut&gt; std::pair&lt;KeyOut, ValueOut&gt; dynamic_map&lt;Key, Value, Scope, Allocator&gt;::retrieve_all( KeyOut keys_out, ValueOut values_out, cudaStream_t stream) const { auto constexpr block_size = 128; auto constexpr stride = 1; auto const capacity = get_capacity(); auto grid_size = (capacity &#43; stride * block_size - 1) / (stride * block_size); std::vector&lt;size_t&gt; submap_cap_prefix(submaps_.size()); std::inclusive_scan(submaps_.begin(), submaps_.end(), submap_cap_prefix.begin(), [](auto const&amp; sum, auto const&amp; submap) { return sum &#43; submap-&gt;get_capacity(); }, (size_t)0); thrust::device_vector&lt;size_t&gt; submap_cap_prefix_d(submap_cap_prefix); // å¤ç”¨alloc_ï¼ˆç”¨äºslots_çš„alloc_ï¼‰ä¼šæ¯”ç›´æ¥cudaMallocå¿«ä¸€ä¸ªæ•°é‡çº§ï¼Œä¸éœ€è¦é‡æ–°åˆ†é…å†…å­˜ // å•çº¯cudaMallocä¼šè§¦å‘GPU driver/runtime çš„â€¯allocationâ€¯åˆå§‹åŒ–ã€é¡µè¡¨å»ºç«‹ç­‰ using temp_allocator_type = typename std::allocator_traits&lt;Allocator&gt;::template rebind_alloc&lt;char&gt;; auto temp_allocator = temp_allocator_type{alloc_}; auto d_num_out = reinterpret_cast&lt;unsigned long long*&gt;( std::allocator_traits&lt;temp_allocator_type&gt;::allocate(temp_allocator, sizeof(unsigned long long))); CUCO_CUDA_TRY(cudaMemsetAsync(d_num_out, 0, sizeof(unsigned long long), stream)); detail::retrieve_all&lt;block_size&gt;&lt;&lt;&lt;grid_size, block_size, 0, stream&gt;&gt;&gt;( keys_out, values_out, submap_views_.data().get(), submaps_.size(), capacity, d_num_out, submap_cap_prefix_d.data().get(), empty_key_sentinel_, erased_key_sentinel_); size_t h_num_out; CUCO_CUDA_TRY( cudaMemcpyAsync(&amp;h_num_out, d_num_out, sizeof(size_t), cudaMemcpyDeviceToHost, stream)); CUCO_CUDA_TRY(cudaStreamSynchronize(stream)); CUCO_CUDA_TRY(cudaFree(d_num_out)) return {keys_out &#43; h_num_out, values_out &#43; h_num_out}; } naiveå®ç°ï¼Œä¸€ä¸ªå…¨å±€atomic template &lt;uint32_t block_size, typename OutputIt, typename viewT, typename PrefixT, typename Key&gt; CUCO_KERNEL void retrieve_all(OutputIt keys_out, OutputIt values_out, viewT* submap_views, uint32_t num_submaps, uint64_t capacity, unsigned long long* d_num_out, PrefixT* prefix_sum, Key empty_key_sentinel, Key erased_key_sentinel) { auto tid = blockDim.x * blockIdx.x &#43; threadIdx.x; auto stride = blockDim.x * gridDim.x; for (; tid &lt; capacity; tid &#43;= stride) { uint32_t submap_idx = 0; uint32_t submap_offset = tid; // prefix_sumé•¿åº¦ä¸€èˆ¬å°±10ä»¥å†…ï¼Œä¸éœ€è¦äºŒåˆ†ä¹‹ç±»çš„æ“ä½œ while (tid &gt;= prefix_sum[submap_idx] &amp;&amp; submap_idx &lt; num_submaps ) &#43;&#43;submap_idx; if (submap_idx &gt; 0) { submap_offset = tid - prefix_sum[submap_idx - 1]; } auto const &amp;current_slot = submap_views[submap_idx].get_slots()[submap_offset]; Key const existing_key = current_slot.first.load(cuda::std::memory_order_relaxed); auto const is_filled = not(cuco::detail::bitwise_compare(existing_key, empty_key_sentinel) or cuco::detail::bitwise_compare(existing_key, erased_key_sentinel)); if (is_filled) { auto idx = atomicAdd(d_num_out, static_cast&lt;unsigned long long&gt;(1)); auto value = current_slot.second.load(cuda::std::memory_order_relaxed); keys_out[idx] = existing_key; values_out[idx] = value; } } } blockå†…atomicAdd &#43; å…¨å±€atomicAdd // ä¸€ä¸ªblockå†…ç”¨ä¸€ä¸ª__shared__ local_countè¡¨ç¤ºè¿™ä¸ªblockä¸­predictä¸ºtrueçš„æ•°é‡ // local_posè¡¨ç¤ºå½“å‰çº¿ç¨‹åœ¨è¯¥blockå†…ç¬¬å‡ ä¸ªpredictä¸ºtrue template &lt;uint32_t block_size, typename OutputIt, typename viewT, typename PrefixT, typename Key&gt; CUCO_KERNEL void retrieve_all(OutputIt keys_out, OutputIt values_out, viewT* submap_views, uint32_t num_submaps, uint64_t capacity, unsigned long long* d_num_out, PrefixT* prefix_sum, Key empty_key_sentinel, Key erased_key_sentinel) { auto tid = blockDim.x * blockIdx.x &#43; threadIdx.x; auto stride = blockDim.x * gridDim.x; __shared__ unsigned int local_count; if (threadIdx.x == 0) { local_count = 0; } __syncthreads(); for (; tid &lt; capacity; tid &#43;= stride) { uint32_t submap_idx = 0; uint32_t submap_offset = tid; while (tid &gt;= prefix_sum[submap_idx] &amp;&amp; submap_idx &lt; num_submaps ) &#43;&#43;submap_idx; if (submap_idx &gt; 0) { submap_offset = tid - prefix_sum[submap_idx - 1]; } auto const &amp;current_slot = submap_views[submap_idx].get_slots()[submap_offset]; Key const existing_key = current_slot.first.load(cuda::std::memory_order_relaxed); auto const is_filled = not(cuco::detail::bitwise_compare(existing_key, empty_key_sentinel) or cuco::detail::bitwise_compare(existing_key, erased_key_sentinel)); unsigned int local_pos = 0; if (is_filled) { local_pos = atomicAdd_block(&amp;local_count, 1); } __syncthreads(); if (threadIdx.x == 0) { local_count = atomicAdd(d_num_out, local_count); } __syncthreads(); if (is_filled) { auto value = current_slot.second.load(cuda::std::memory_order_relaxed); keys_out[local_count &#43; local_pos] = existing_key; values_out[local_count &#43; local_pos] = value; } } } // ç±»ä¼¼åŸç†ï¼Œä½†æ˜¯ç”¨cub::BlockScanå®ç° template &lt;uint32_t block_size, typename OutputIt, typename viewT, typename PrefixT, typename Key&gt; CUCO_KERNEL void retrieve_all(OutputIt keys_out, OutputIt values_out, viewT* submap_views, uint32_t num_submaps, uint64_t capacity, unsigned long long* d_num_out, PrefixT* prefix_sum, Key empty_key_sentinel, Key erased_key_sentinel) { using BlockScan = cub::BlockScan&lt;unsigned int, block_size&gt;; // Shared memory __shared__ typename BlockScan::TempStorage scan_temp_storage; __shared__ unsigned int block_base; auto tid = blockDim.x * blockIdx.x &#43; threadIdx.x; auto stride = blockDim.x * gridDim.x; for (; tid &lt; capacity; tid &#43;= stride) { // Compute submap index and offset uint32_t submap_idx = 0; uint32_t submap_offset = tid; while (tid &gt;= prefix_sum[submap_idx] &amp;&amp; submap_idx &lt; num_submaps) &#43;&#43;submap_idx; if (submap_idx &gt; 0) { submap_offset = tid - prefix_sum[submap_idx - 1]; } auto const&amp; current_slot = submap_views[submap_idx].get_slots()[submap_offset]; Key const existing_key = current_slot.first.load(cuda::std::memory_order_relaxed); // Check key validity bool is_filled = not(cuco::detail::bitwise_compare(existing_key, empty_key_sentinel) || cuco::detail::bitwise_compare(existing_key, erased_key_sentinel)); // Perform block-wide exclusive scan to compute local write index unsigned int local_idx = 0; unsigned int total_valid = 0; BlockScan(scan_temp_storage).ExclusiveSum(is_filled ? 1u : 0u, local_idx, total_valid); // Block leader calculates global offset if (threadIdx.x == 0) { block_base = atomicAdd(d_num_out, total_valid); } __syncthreads(); if (is_filled) { auto value = current_slot.second.load(cuda::std::memory_order_relaxed); keys_out[block_base &#43; local_idx] = existing_key; values_out[block_base &#43; local_idx] = value; } } } 3. warp-aggregated atomics: warp(or cooperative group)ç²’åº¦atomicAdd &#43; blockå†…atomicAdd&#43;å…¨å±€atomicAdd ```cpp template &lt;uint32_t block_size, typename OutputIt, typename viewT, typename PrefixT, typename Key&gt; CUCO_KERNEL void retrieve_all(OutputIt keys_out, OutputIt values_out, viewT* submap_views, uint32_t num_submaps, uint64_t capacity, unsigned long long* d_num_out, PrefixT* prefix_sum, Key empty_key_sentinel, Key erased_key_sentinel) { auto tid = blockDim.x * blockIdx.x &#43; threadIdx.x; auto stride = blockDim.x * gridDim.x; __shared__ unsigned int block_count; __shared__ unsigned int block_base; if (threadIdx.x == 0) { block_count = 0; block_base = 0; } __syncthreads(); unsigned int local_idx = 0; for (; tid &lt; capacity; tid &#43;= stride) { uint32_t submap_idx = 0; uint32_t submap_offset = tid; while (tid &gt;= prefix_sum[submap_idx] &amp;&amp; submap_idx &lt; num_submaps ) &#43;&#43;submap_idx; if (submap_idx &gt; 0) { submap_offset = tid - prefix_sum[submap_idx - 1]; } auto const &amp;current_slot = submap_views[submap_idx].get_slots()[submap_offset]; Key const existing_key = current_slot.first.load(cuda::std::memory_order_relaxed); auto const is_filled = not(cuco::detail::bitwise_compare(existing_key, empty_key_sentinel) or cuco::detail::bitwise_compare(existing_key, erased_key_sentinel)); unsigned mask = __ballot_sync(0xffffffff, is_filled); int lane = threadIdx.x &amp; 0x1f; int warp_prefix = __popc(mask &amp; ((1u &lt;&lt; lane) - 1)); if (is_filled) local_idx = warp_prefix; unsigned int warp_vote = __popc(mask); unsigned int warp_base = 0; if (lane == 0 &amp;&amp; warp_vote) { warp_base = atomicAdd_block(&amp;block_count, warp_vote); } warp_base = __shfl_sync(0xffffffff, warp_base, 0); __syncthreads(); if (threadIdx.x == 0) { block_base = atomicAdd(d_num_out, block_count); } __syncthreads(); if (is_filled) { auto value = current_slot.second.load(cuda::std::memory_order_relaxed); keys_out[block_base &#43; warp_base &#43; local_idx] = existing_key; values_out[block_base &#43; warp_base &#43; local_idx] = value; } } } // ç±»ä¼¼çš„ï¼Œä½†æ˜¯ç”¨cooperative groupå®ç°,å®æµ‹è¿˜æ˜¯tile_size=32æœ€å¿«ï¼Œå’Œwarpæ²¡åŒºåˆ« // å†™èµ·æ¥æ›´modernä¸€ç‚¹ template &lt;uint32_t block_size, uint32_t tile_size, typename OutputIt, typename viewT, typename PrefixT, typename Key&gt; CUCO_KERNEL void retrieve_all(OutputIt keys_out, OutputIt values_out, viewT* submap_views, uint32_t num_submaps, uint64_t capacity, unsigned long long* d_num_out, PrefixT* prefix_sum, Key empty_key_sentinel, Key erased_key_sentinel) { auto tile = cg::tiled_partition&lt;tile_size&gt;(cg::this_thread_block()); auto block = cg::this_thread_block(); auto tid = blockDim.x * blockIdx.x &#43; threadIdx.x; auto stride = blockDim.x * gridDim.x; __shared__ unsigned int block_count; __shared__ unsigned int block_base; if (threadIdx.x == 0) { block_count = 0; block_base = 0; } block.sync(); for (; tid &lt; capacity; tid &#43;= stride) { uint32_t submap_idx = 0; uint32_t submap_offset = tid; while (tid &gt;= prefix_sum[submap_idx] &amp;&amp; submap_idx &lt; num_submaps ) &#43;&#43;submap_idx; if (submap_idx &gt; 0) { submap_offset = tid - prefix_sum[submap_idx - 1]; } auto const &amp;current_slot = submap_views[submap_idx].get_slots()[submap_offset]; Key const existing_key = current_slot.first.load(cuda::std::memory_order_relaxed); auto const is_filled = not(cuco::detail::bitwise_compare(existing_key, empty_key_sentinel) or cuco::detail::bitwise_compare(existing_key, erased_key_sentinel)); unsigned int tile_mask = tile.ballot(is_filled); unsigned int tile_rank = tile.thread_rank(); unsigned int tile_vote = __popc(tile_mask); unsigned int tile_prefix = __popc(tile_mask &amp; ((1u &lt;&lt; tile_rank) - 1)); unsigned int tile_base = 0; if (tile_rank == 0 &amp;&amp; tile_mask) { tile_base = atomicAdd_block(&amp;block_count, tile_vote); } tile_base = tile.shfl(tile_base, 0); block.sync(); if (block.thread_rank() == 0) { block_base = atomicAdd(d_num_out, block_count); } block.sync(); if (is_filled) { auto value = current_slot.second.load(cuda::std::memory_order_relaxed); keys_out[block_base &#43; tile_base &#43; tile_prefix] = existing_key; values_out[block_base &#43; tile_base &#43; tile_prefix] = value; } } } å®æµ‹2/3é€Ÿåº¦å·®ä¸å¤šï¼Œåœ¨æ’å…¥1äº¿æ•°æ®åï¼ˆå®é™…æ€»capè¾¾åˆ°2äº¿ï¼‰ï¼Œ&lt;key, value&gt;éƒ½æ˜¯cuda::atomic&lt;int64_t&gt;çš„æƒ…å†µä¸‹ï¼Œretrieve_all cost 3mså·¦å³ï¼›
...</p>
  </div>
  <footer class="entry-footer"><span title='2025-04-28 00:00:00 +0000 UTC'>April 28, 2025</span>&nbsp;Â·&nbsp;6 min</footer>
  <a class="entry-link" aria-label="post link to cuCollections" href="https://caaatch22.github.io/posts/cuco/"></a>
</article>

<article class="post-entry"> 
  <header class="entry-header">
    <h2>TinyMl â€”â€” æ¨¡å‹é‡åŒ–(quantization)
    </h2>
  </header>
  <div class="entry-content">
    <p>Overview æ¨¡å‹é‡åŒ–ï¼ˆquantizationï¼‰æŒ‡çš„æ˜¯ç”¨æ›´å°‘çš„bitè¡¨ç¤ºæ¨¡å‹å‚æ•°ï¼Œä»è€Œå‡å°‘æ¨¡å‹çš„å¤§å°ï¼ŒåŠ é€Ÿæ¨ç†è¿‡ç¨‹çš„æŠ€æœ¯ã€‚
ä¸€ç§å¸¸è§çš„é‡åŒ–æ–¹å¼æ˜¯çº¿æ€§é‡åŒ–(linear quantization)ï¼Œä¹Ÿå«ä»¿å°„é‡åŒ–(affine quantization)ã€‚å…¶å®å°±æ˜¯æŒ‰æ¯”ä¾‹å°†tensorï¼ˆä¸€èˆ¬ä¸ºfp32ï¼‰æ”¾ç¼©åˆ° $2^{bitwidth}$ çš„èŒƒå›´å†…ï¼Œæ¯”å¦‚8bitç­‰ã€‚æˆ‘ä»¬å¾ˆå®¹æ˜“ç»™å‡ºé‡åŒ–å…¬å¼ï¼š $$ r = s(q - z) $$ å…¶ä¸­ï¼Œr(real value)å€¼å¾—æ˜¯é‡åŒ–å‰çš„å€¼ï¼Œq(quantized value)æ˜¯é‡åŒ–åçš„å€¼ï¼Œs(scale)æ˜¯æ”¾ç¼©æ¯”ä¾‹ï¼Œz(zero point)ç›¸å½“äºæ˜¯ä¸€ä¸ªåç§»é‡ã€‚
å¦‚ä½•æ±‚å‡º$s$å’Œ$z$å‘¢ï¼Ÿä¸€ç§ç®€å•ä¸”å¸¸è§çš„æ–¹å¼æ˜¯é€šè¿‡æœ€å¤§æœ€å°å€¼æ¥ä¼°è®¡ï¼Œå³ï¼š
$$ s = \frac{r_{max} - r_{min}}{q_{max} - q_{min}} $$ $r_{max}$å°±æ˜¯è¿™ä¸ªtensorçš„æœ€å¤§å€¼ï¼Œ$r_{min}$æ˜¯æœ€å°å€¼ï¼Œ$q_{max}$å’Œ$q_{min}$æ˜¯æˆ‘ä»¬æŒ‡å®šçš„é‡åŒ–åçš„æœ€å¤§æœ€å°å€¼ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š æœ‰äº†scale, å®¹æ˜“å¾—åˆ° $z = q_{min} - \frac{r_{min}}{s}$ã€‚åœ¨å®é™…æ“ä½œä¸­ï¼Œzä¸€èˆ¬ä¼šè¢«roundåˆ°æœ€è¿‘çš„æ•´æ•°$z = round(q_{min} - \frac{r_{min}}{s})$ï¼ˆæœ‰å¾ˆå¤šä¸åŒçš„roundè§„åˆ™ï¼Œè¿™ä¸ªæœ‰å…·ä½“å®ç°å†³å®šï¼‰ã€‚
å¾—åˆ°é‡åŒ–æ–¹ç¨‹ï¼š $$ q = clip(round(\frac{r}{s}) &#43; z, q_{min}, q_{max}) $$
ä»£ç ç¤ºæ„å¦‚ä¸‹ï¼šï¼ˆå®é™…ä¼šç”¨pytorchå·²æœ‰çš„quantize apiæˆ–è€…å…¶ä»–æ¨ç†æ¡†æ¶ï¼‰
def get_quantized_range(bitwidth): quantized_max = (1 &lt;&lt; (bitwidth - 1)) - 1 quantized_min = -(1 &lt;&lt; (bitwidth - 1)) return quantized_min, quantized_max def linear_quantize(fp_tensor, bitwidth, scale, zero_point, dtype=torch.int8) -&gt; torch.Tensor: rounded_tensor = torch.round(fp_tensor / scale).to(dtype) shifted_tensor = rounded_tensor &#43; zero_point quantized_min, quantized_max = get_quantized_range(bitwidth) quantized_tensor = shifted_tensor.clamp_(quantized_min, quantized_max) return quantized_tensor ä¸Šè¿°è¿‡ç¨‹è¢«ç§°ä¸ºéå¯¹ç§°é‡åŒ–(asymmetric quantization)ã€‚
...</p>
  </div>
  <footer class="entry-footer"><span title='2024-02-27 22:19:21 +0000 UTC'>February 27, 2024</span>&nbsp;Â·&nbsp;3 min</footer>
  <a class="entry-link" aria-label="post link to TinyMl â€”â€” æ¨¡å‹é‡åŒ–(quantization)" href="https://caaatch22.github.io/posts/tinyml-quantization/"></a>
</article>

<article class="post-entry"> 
  <header class="entry-header">
    <h2>TinyMl â€”â€” æ¨¡å‹å‰ªæ(pruning)
    </h2>
  </header>
  <div class="entry-content">
    <p> æœ€è¿‘æ­£åœ¨å­¦ä¹  MIT 6.5940, éŸ©æ¾è€å¸ˆçš„è¯¾ï¼Œåšdeep learning compressionçš„åº”è¯¥éƒ½åªçŸ¥é“ã€‚è¯¾ç¨‹åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼Œefficient inference, domain-specific optimization, efficient trainingã€‚æœ‰å®Œæ•´çš„è¯¾ä»¶ï¼Œè§†é¢‘å’Œå®éªŒã€‚æœ€åä¸€ä¸ªlabæ˜¯å°†llama2éƒ¨ç½²åœ¨ä¸ªäººç”µè„‘ä¸Šï¼Œéå¸¸æœ‰æ„æ€ï¼ˆè°ä¸æƒ³è¦ä¸ªè‡ªå·±çš„å¤§æ¨¡å‹å‘¢ï¼‰ã€‚å…¶ä½™labä¹Ÿéƒ½å¯ä»¥ç™½å«–google colabçš„gpu
Introduction æ­£å¼ä»‹ç»pruning and sparsityä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥èŠèŠä¸ºä»€ä¹ˆè¦åšmodel compressionè¿™ä¸ªäº‹æƒ…ã€‚ Todayâ€™s Model is Too Big!
éšç€Large language modelçš„å‡ºç°ï¼Œå¦‚GPT-3ï¼Œå¦‚ä»Šçš„æ¨¡å‹å‚æ•°é‡å·²ç»è¾¾åˆ°äº†ä¸Šç™¾billionï¼Œåˆ«è¯´è®­ç»ƒï¼Œæˆ‘ä»¬ç”šè‡³æ— æ³•åœ¨ä¸€ä¸ªgpuä¸Šå¯¹å…¶è¿›è¡Œæ¨ç†ã€‚æ›´åˆ«æå¦‚æœæˆ‘ä»¬æƒ³è¦å°†å…¶éƒ¨ç½²åœ¨å…¶ä»–è¾¹ç¼˜è®¾å¤‡ä¸Šã€‚
æ‰€ä»¥å½“å‰åœ¨åšinferenceä¹‹å‰ï¼Œä¸€èˆ¬éƒ½ä¼šæœ‰ä¸ªmodel-compressionçš„è¿‡ç¨‹ï¼ŒåŒ…æ‹¬pruningï¼ˆå‰ªæï¼‰ï¼Œquantizationï¼ˆé‡åŒ–ï¼‰ï¼Œdistillationï¼ˆè’¸é¦ï¼‰ç­‰ã€‚è¿™äº›æ–¹æ³•éƒ½æ˜¯ä¸ºäº†å‡å°‘æ¨¡å‹çš„å¤§å°ï¼ŒåŠ é€Ÿæ¨ç†è¿‡ç¨‹ã€‚è¿™äº›æ–¹æ³•ä¹Ÿè¢«å¹¿æ³›åœ°é›†æˆåˆ°äº†å„ç§åŠ é€Ÿå¡ï¼Œgpuä¸­ã€‚ä¾‹å¦‚nvçš„A100å°±æ”¯æŒstructured sparsityï¼ˆ[N:M]å½¢å¼çš„ï¼Œå…·ä½“å«ä¹‰ä¸‹æ–‡ä¼šè¯¦ç»†ä»‹ç»ï¼‰ã€‚
Efficiency Metrics æˆ‘ä»¬å†æ¥çœ‹çœ‹ä¸€äº› efficiency metricsï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬åœ¨åšinferenceè¿‡ç¨‹ä¸­éœ€è¦è€ƒè™‘çš„æŒ‡æ ‡ï¼š
Memory-Related Metrics # parameters model size total/peak #activations Computation-Related Metrics MACs FLOP, FLOPs # parameters ä¸‹è¡¨æ˜¯ä¸€äº›å¸¸è§ç»“æ„çš„å‚æ•°æ•°é‡ï¼š
Model #Parameters Linear Layer(FC) $feature_{in} * feature_{out}$ Conv Layer $c_{i} * c_{o} * k_{h} * k_{w} $ Grouped Conv Layer $c_{i} * c_{o} * k_{h} * k_{w} / g$ Depthwise Conv Layer $c_{o} * k_{h} * k_{w}$ å…¶ä¸­ï¼ŒGrouped ConvæŒ‡çš„æ˜¯å°†è¾“å…¥åœ¨channelç»´åº¦è¿›è¡Œåˆ†ç»„ï¼Œç„¶ååˆ†åˆ«è¿›è¡Œå·ç§¯ï¼Œæœ€åconcatenateã€‚Depthwise Convæ˜¯åˆ†ç»„ä¸ªæ•° $g$ ç­‰äºè¾“å…¥channelæ•°çš„æƒ…å†µã€‚
...</p>
  </div>
  <footer class="entry-footer"><span title='2024-02-20 15:35:59 +0000 UTC'>February 20, 2024</span>&nbsp;Â·&nbsp;3 min</footer>
  <a class="entry-link" aria-label="post link to TinyMl â€”â€” æ¨¡å‹å‰ªæ(pruning)" href="https://caaatch22.github.io/posts/tinyml-pruning/"></a>
</article>

<article class="post-entry"> 
  <header class="entry-header">
    <h2>CUDAç¼–ç¨‹æ¨¡å‹
    </h2>
  </header>
  <div class="entry-content">
    <p> æœ¬ç³»åˆ—ç¬”è®°ä¸»è¦å‚è€ƒäº† â€œProgramming massively parallel processors&#34;è¿™æœ¬ä¹¦ï¼Œä»¥åŠç½‘ä¸Šç›¸å…³èµ„æ–™ï¼›ä¸ä¼šç‰¹åˆ«è¯¦ç»†ï¼Œå½“ä½œä¸ªäººæ•´ç†çš„é¢ç»
CUDAè½¯ä»¶æ¶æ„ CUDAä»è½¯ä»¶å±‚é¢ä¸Šæä¾›äº†ä¸‰å±‚ç»“æ„åŒ…æ‹¬grid, blockå’Œthreadã€‚æ¯ä¸ªkernalå†…å¯åŠ¨çš„æ‰€æœ‰çº¿ç¨‹åœ¨ä¸€ä¸ªgridå†…ã€‚å¯åŠ¨kernelæ—¶æŒ‡å®šÂ«&lt;dimGrid, dimBlockÂ»&gt;ï¼Œéƒ½æ˜¯ä¸€ä¸ªdim3ç»“æ„ã€‚
gridDimçš„æœ€å¤§å€¼èŒƒå›´ï¼š (x,y,z): (2^31 - 1, 65535, 65535) blockDimçš„æœ€å¤§å€¼èŒƒå›´ï¼š(x,y,z): (1024, 1024, 64) ä¸”è¿˜è¦åŒæ—¶æ»¡è¶³ï¼šä¸€ä¸ªblockå†…çš„threadsæ•°é‡ä¸èƒ½è¶…è¿‡1024(ä»keplerå¼€å§‹)ã€‚å³ï¼š$ blockDim.x * blockDim.y * blockDim.z &lt;= 1024 $ CUDAå†…å­˜æ¶æ„ å˜é‡å£°æ˜ æ‰€åœ¨å†…å­˜ ä½œç”¨åŸŸ ç”Ÿå‘½å‘¨æœŸ kernelå†…é™¤äº†arrayçš„å˜é‡ register thread grid kernelå†…çš„array å˜é‡ local thread grid __shared__ ä¿®é¥°çš„kernelå†…çš„å˜é‡ shared block grid __device__ ä¿®é¥°çš„å…¨å±€å˜é‡ global grid application __device__ __constant__ ä¿®é¥°çš„å…¨å±€å˜é‡ constant grid application å…¶ä¸­ å¯„å­˜å™¨æ˜¯GPUä¸Šè¿è¡Œé€Ÿåº¦æœ€å¿«çš„å†…å­˜ç©ºé—´ï¼Œå»¶è¿Ÿä¸º1ä¸ªæ—¶é’Ÿå‘¨æœŸã€‚ æ¥ä¸‹æ¥æ˜¯å…±äº«å†…å­˜ï¼Œå…±äº«å†…å­˜æ˜¯GPUä¸Šå¯å—ç”¨æˆ·æ§åˆ¶çš„ä¸€çº§ç¼“å­˜ ã€‚å…±äº«å†…å­˜ç±»ä¼¼äºCPUçš„ç¼“å­˜ï¼Œä¸è¿‡ä¸CPUçš„ç¼“å­˜ä¸åŒï¼ŒGPUçš„å…±äº«å†…å­˜å¯ä»¥æœ‰CUDAå†…æ ¸ç›´æ¥ç¼–ç¨‹æ§åˆ¶ã€‚å»¶è¿Ÿä¸º1ï½32ä¸ªæ—¶é’Ÿå‘¨æœŸã€‚ local memoryå®é™…ä¸Šå°±åœ¨global memoryä¸Šï¼Œåªæ˜¯é€šè¿‡ç¼–è¯‘å™¨å¤„ç†æˆç§æœ‰çš„ã€æ¯ä¸ªçº¿ç¨‹ç‹¬ç«‹çš„ä¸€å—å†…å­˜åŒºåŸŸã€‚ä¸€èˆ¬ä¸€ä¸ªkernalå†…çš„æ•°ç»„ä¼šè¢«å¤„ç†æˆlocal memoryã€‚å»¶è¿Ÿå’Œglobal memoryç±»ä¼¼ã€‚ è¿˜æœ‰texture memeoryï¼Œä½†æ˜¯å’Œç§‘å­¦è®¡ç®—ç›¸å…³ä¸å¤§ã€‚ CUDAç¡¬ä»¶ç»“æ„ ä¸€ä¸ªGPUå¯ä»¥çœ‹ä½œæ˜¯SM(streaming multiprocessor)çš„é›†åˆï¼Œæ¯ä¸ªSMåŒ…å«å¤šä¸ªSP(streaming processorï¼Œæˆ–è€…ç°åœ¨ä¸€èˆ¬å«CUDA cores)ã€‚ ...</p>
  </div>
  <footer class="entry-footer"><span title='2024-01-26 22:35:22 +0000 UTC'>January 26, 2024</span>&nbsp;Â·&nbsp;2 min</footer>
  <a class="entry-link" aria-label="post link to CUDAç¼–ç¨‹æ¨¡å‹" href="https://caaatch22.github.io/posts/cuda/"></a>
</article>

<article class="post-entry"> 
  <header class="entry-header">
    <h2>Back to Basics -- c&#43;&#43; move sematics
    </h2>
  </header>
  <div class="entry-content">
    <p>1.3 Copying as a Fallback
1.4 const Return Values const std::string get_value();ä¸å†æ˜¯guidelineï¼Œå› ä¸ºconst disables ç§»åŠ¨è¯­ä¹‰ ä¾‹å¦‚ï¼š
const std::string getValue(); std::vector&lt;std::string&gt; coll; coll.push_back(getValue()); // copies(because the return value is const) const std::string getValue(); // BAD: disables move semantics for return values const std::string&amp; getRef(); // OK const std::string* getPtr(); // OK Summary Move semantics allows us to optimize the copying of objects, where we no longer need the value. It can be used implicitly (for unnamed temporary objects or local return values) or explicitly (with std::move()). std::move() means I no longer need this value here. It marks the object as movable. An object marked with std::move() is not (partially) destroyed (the destructor still will be called). By declaring a function with a non-const rvalue reference (such as std::string&amp;&amp;), you define an interface where the caller semantically claims that it no longer needs the passed value. The implementer of the function can use this information to optimize its task by â€œstealingâ€ the value or do any other modification with the passed argument. Usually, the implementer also has to ensure that the passed argument is in a valid state after the call. Moved-from objects of the C&#43;&#43; standard library are still valid objects, but you no longer know their value. Copy semantics is used as a fallback for move semantics (if copy semantics is supported). If there is no implementation taking an rvalue reference, any implementation taking an ordinary const lvalue reference (such as const std::string&amp;) is used. This fallback is then used even if the object is explicitly marked with std::move(). Calling std::move() for a const object usually has no effect. If you return by value (not by reference), do not declare the return value as a whole to be const. Moved-from objects Valid but Unspecified State
...</p>
  </div>
  <footer class="entry-footer"><span title='2023-10-17 23:38:14 +0000 UTC'>October 17, 2023</span>&nbsp;Â·&nbsp;2 min</footer>
  <a class="entry-link" aria-label="post link to Back to Basics -- c&#43;&#43; move sematics" href="https://caaatch22.github.io/posts/back2basics-cpp-move-sematic/"></a>
</article>

<article class="post-entry"> 
  <header class="entry-header">
    <h2>Computer Architecture â€”â€” åˆ†æ”¯é¢„æµ‹
    </h2>
  </header>
  <div class="entry-content">
    <p> H&amp;Pé‚£æœ¬å…³äºåˆ†æ”¯é¢„æµ‹çš„éƒ¨åˆ†æ¯”è¾ƒç®€çŸ­ä¸”è¡¨è¿°æœ‰ç‚¹æ™¦æ¶©ï¼Œï¼ˆé¡ºä¾¿åæ§½ä¸€ä¸‹ç¬¬äº”ç‰ˆçš„ä¸­æ–‡ç¿»è¯‘ï¼Œå»ºè®®çœ‹è‹±æ–‡åŸç‰ˆï¼‰æœ¬æ–‡ä¸»è¦å‚è€ƒè¶…æ ‡é‡å¤„ç†å™¨è®¾è®¡ï¼Œå›½äººå†™çš„ï¼Œç”¨è¯­ç¬¦åˆä¹ æƒ¯ï¼Œå¼ºçƒˆæ¨èï¼
Motivation åœ¨å¤„ç†å™¨ä¸­ï¼Œé™¤äº†cacheä¹‹å¤–ï¼Œå¦ä¸€ä¸ªé‡è¦çš„å†…å®¹å°±æ˜¯åˆ†æ”¯é¢„æµ‹ï¼Œå®ƒå’Œcacheä¸€èµ·å·¦å³å¤„ç†å™¨çš„æ€§èƒ½ã€‚ä»¥SPECint95ä½œä¸ºbenchmarkï¼Œå®Œç¾çš„cacheå’ŒBP(branch-predictor)èƒ½ä½¿IPCæé«˜ä¸¤å€å·¦å³ï¼š å›¾ç‰‡æ¥è‡ªè®ºæ–‡SSMTã€‚å½“ç„¶ï¼Œè¿™æ˜¯21ä¸–çºªä¹‹å‰çš„ç»“æœäº†ã€‚ç°ä»£å¤„ç†å™¨åˆ†æ”¯é¢„æµ‹æ™®éèƒ½è¾¾åˆ°97%~98%ä»¥ä¸Šçš„ç²¾åº¦ï¼Œåœ¨å¤šæ•°æµ®ç‚¹benchmarkä¸­åŸºæœ¬éƒ½æ˜¯99%çš„å‡†ç¡®ç‡ã€‚
ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¹ˆé«˜çš„ç²¾åº¦å‘¢ï¼Ÿ ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œåˆ†æ”¯æŒ‡ä»¤çš„å æ¯”é€šå¸¸åœ¨ 15% åˆ° 30% ä¹‹é—´ã€‚å¯¹äºç»å…¸äº”çº§æµæ°´çº¿æ— åˆ†æ”¯é¢„æµ‹cpuï¼Œä¸€ä¸ªbranchä¼šé€ æˆä¸€æ¬¡stallï¼›è€Œå¯¹äºç°ä»£çš„superscalarä¸”æµæ°´çº¿çº§æ•°è¿œé«˜äº5çš„ï¼ˆä¸€èˆ¬æ˜¯äºŒåçº§ä»¥ä¸Šï¼‰cpuï¼Œå…¶misprediction penaltyæ˜¯ $M * N$ çš„ï¼ˆM = fetch groupå†…æŒ‡ä»¤æ•°, N = branch resolution latencyï¼Œå°±æ˜¯å†³å®šåˆ†æ”¯æœ€ç»ˆæ˜¯å¦è·³è½¬éœ€è¦å¤šå°‘å‘¨æœŸï¼‰ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š æˆ‘ä»¬å†åšä¸€ä¸ªå®šé‡å®éªŒï¼š å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ª
$ N = 20 (20\ pipe stages), W = 5 (5\ wide fetch) $ 1 out of 5 instructions is a branch Each 5 instruction-block ends with a branch çš„CPUï¼Œé‚£ä¹ˆæˆ‘ä»¬å–å‡º500æ¡æŒ‡ä»¤éœ€è¦å¤šå°‘ä¸ªå‘¨æœŸå‘¢ï¼Ÿ
100% é¢„æµ‹æ­£ç¡®ç‡ 100 ä¸ªæ—¶é’Ÿå‘¨æœŸ (all instructions fetched on the correct path) æ— é¢å¤–å·¥ä½œ 99% é¢„æµ‹æ­£ç¡®ç‡ 100 (correct path) &#43; 20 (wrong path) = 120 ä¸ªæ—¶é’Ÿå‘¨æœŸ 20% é¢å¤–æŒ‡ä»¤è¢«å–å‡º 98% é¢„æµ‹æ­£ç¡®ç‡ 100 (correct path) &#43; 20 * 2 (wrong path) = 140 ä¸ªæ—¶é’Ÿå‘¨æœŸ 40% é¢å¤–æŒ‡ä»¤è¢«å–å‡º 95% é¢„æµ‹æ­£ç¡®ç‡ 100 (correct path) &#43; 20 * 5 (wrong path) = 200 ä¸ªæ—¶é’Ÿå‘¨æœŸ 100% é¢å¤–æŒ‡ä»¤è¢«å–å‡º å¯ä»¥çœ‹å‡ºï¼Œåˆ†æ”¯é¢„æµ‹å¤±è´¥åœ¨ç°ä»£çš„è¶…æ ‡é‡å¤šæµæ°´çº¿cpuä¸­çš„penaltyè¢«æå¤§çš„æ”¾å¤§äº†ã€‚æ‰€ä»¥åˆ†æ”¯é¢„æµ‹çš„æ­£ç¡®æ€§å°±æ˜¾å¾—é¢å¤–é‡è¦ã€‚
...</p>
  </div>
  <footer class="entry-footer"><span title='2023-10-17 23:38:14 +0000 UTC'>October 17, 2023</span>&nbsp;Â·&nbsp;3 min</footer>
  <a class="entry-link" aria-label="post link to Computer Architecture â€”â€” åˆ†æ”¯é¢„æµ‹" href="https://caaatch22.github.io/posts/branch-prediction/"></a>
</article>

<article class="post-entry"> 
  <header class="entry-header">
    <h2>C&#43;&#43;å†…å­˜æ¨¡å‹ â€”â€” ç°ä»£Architectureçš„å¦¥å
    </h2>
  </header>
  <div class="entry-content">
    <p> ä»‹ç» ä»€ä¹ˆæ˜¯å†…å­˜æ¨¡å‹(Memory Model)å‘¢ï¼Ÿè¿™é‡Œä»‹ç»çš„å†…å­˜æ¨¡å‹å¹¶éC&#43;&#43;å¯¹è±¡çš„å†…å­˜æ’å¸ƒæ¨¡å‹ï¼Œè€Œæ˜¯ä¸€ä¸ªéç¼–ç¨‹è¯­è¨€å±‚é¢çš„æ¦‚å¿µã€‚æˆ‘ä»¬çŸ¥é“åœ¨C&#43;&#43;11ä¸­ï¼Œæ ‡å‡†å¼•å…¥äº† std::atomic&lt;&gt;åŸå­å¯¹è±¡ï¼ŒåŒæ—¶è¿˜å¼•å…¥äº†
memory_order_relaxed memory_order_consume memory_order_acquire memory_order_release memory_order_acq_rel memory_order_seq_cst è¿™å…­ç§ memory orderã€‚å¼•å…¥å¯ä»¥è®©æˆ‘ä»¬è¿›è¡Œæ— é”ç¼–ç¨‹ï¼Œè€Œå¦‚æœä½ æƒ³è¦æ›´é«˜æ€§èƒ½çš„ç¨‹åºï¼Œä½ å°±å¿…é¡»æ·±æŒ–è¿™å…­ç§å†…å­˜æ¨¡å‹çš„å«ä¹‰å¹¶æ­£ç¡®åº”ç”¨ã€‚ï¼ˆå½“ç„¶ï¼Œåœ¨ä¸æ˜¾å¼æŒ‡æ˜memory orderçš„æƒ…å†µä¸‹ï¼Œä½ èƒ½ä¿è¯è·å¾—æ­£ç¡®çš„ä»£ç ï¼Œä½†å­˜åœ¨æ€§èƒ½æŸå¤±ï¼‰
å†…å­˜æ¨¡å‹ åœ¨ä»‹ç»C&#43;&#43; memory orderä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆå›ç­”å¦ä¸€ä¸ªé—®é¢˜ã€‚ä½ çš„è®¡ç®—æœºæ‰§è¡Œçš„ç¨‹åºå°±æ˜¯ä½ å†™çš„ç¨‹åºå—? â€”â€” æ˜¾ç„¶ä¸æ˜¯çš„ã€‚
åŸå› ä¹Ÿå¾ˆç®€å•ï¼Œä¸ºäº†æ›´é«˜æ•ˆçš„æ‰§è¡ŒæŒ‡ä»¤ï¼Œç¼–è¯‘å™¨ã€CPUç»“æ„ã€ç¼“å­˜åŠå…¶ä»–ç¡¬ä»¶ç³»ç»Ÿéƒ½ä¼šå¯¹æŒ‡ä»¤è¿›è¡Œå¢åˆ ï¼Œä¿®æ”¹ï¼Œé‡æ’ã€‚ä½†è¦å›ç­”å…·ä½“è¿›è¡Œäº†ä»€ä¹ˆæ ·çš„ä¿®æ”¹ï¼Œåˆæ˜¯ä¸€ä¸ªæå…¶å¤æ‚çš„é—®é¢˜ã€‚æˆ–è€…è¯´ï¼Œæ•´ä¸ªç°ä»£ä½“ç³»ç»“æ„ï¼Œå°±æ˜¯åœ¨ä¿è¯ç¨‹åºæ­£ç¡®æ€§çš„å‰æä¸‹åˆ©ç”¨å„ç§æ‰‹æ®µå¯¹ç¨‹åºä¼˜åŒ–ã€‚æˆ‘ä»¬å¯ä»¥ç²—ç•¥çš„å°†å…¶åˆ†æˆå‡ ä¸ªéƒ¨åˆ†ï¼š
source code order: ç¨‹åºå‘˜åœ¨æºä»£ç ä¸­æŒ‡å®šçš„é¡ºåº program code order: åŸºæœ¬ä¸Šå¯ä»¥çœ‹æˆæ±‡ç¼–/æœºå™¨ç çš„é¡ºåºï¼Œå®ƒå¯ä»¥ç”±ç¼–è¯‘å™¨ä¼˜åŒ–åå¾—åˆ° execution code order: CPUæ‰§è¡ŒæŒ‡ä»¤é¡ºåºä¹Ÿä¸è§å¾—ä¸æ±‡ç¼–ç›¸åŒï¼Œä¸åŒCPUåœ¨æ‰§è¡Œç›¸åŒæœºå™¨ç æ—¶ä»»ç„¶å­˜åœ¨ä¼˜åŒ–ç©ºé—´ã€‚ perceived order/physical order: æœ€ç»ˆçš„æ‰§è¡Œé¡ºåºã€‚å³ä¾¿CPUæŒ‰ç…§æŸç§ç¡®å®šæŒ‡ä»¤æ‰§è¡Œï¼Œç‰©ç†æ—¶é—´ä¸Šçš„æ‰§è¡Œé¡ºåºä»ç„¶å¯èƒ½ä¸åŒã€‚ä¾‹å¦‚ï¼Œåœ¨è¶…æ ‡é‡CPUä¸­ï¼Œä¸€æ¬¡å¯ä»¥fetch and decodeå¤šä¸ªæŒ‡ä»¤ï¼Œè¿™äº›æŒ‡ä»¤ä¹‹é—´çš„ç‰©ç†æ‰§è¡Œé¡ºåºå°±æ˜¯ä¸ç¡®å®šçš„ï¼›ç”±äºä¸åŒå±‚çº§ç¼“å­˜ä¹‹é—´å»¶æ—¶ä¸åŒï¼Œä»¥åŠç¼“å­˜ä¹‹é—´çš„é€šä¿¡éœ€è¦ç­‰å¸¦æ¥çš„ä¸ç¡®å®šçš„æ‰§è¡Œé¡ºåºç­‰ ä¸Šå›¾ç®€è¦è¯´æ˜äº†ä½ çš„æºä»£ç å¯èƒ½ç»å†çš„ä¼˜åŒ–æ­¥éª¤ã€‚
è¿™äº›ä¼˜åŒ–çš„ä¸€ä¸ªä¸»è¦åŸå› åœ¨äº æ©ç›–memory accessæ“ä½œä¸CPUæ‰§è¡Œé€Ÿåº¦ä¸Šçš„å·¨å¤§é¸¿æ²Ÿã€‚å¦‚æœæ²¡æœ‰cacheï¼ŒCPUæ¯ä¸ªè®¿å­˜æŒ‡ä»¤éƒ½éœ€è¦stallä¸€ä¸¤ç™¾ä¸ªæ—¶é’Ÿå‘¨æœŸï¼Œè¿™æ˜¯ä¸å¯æ¥å—çš„ã€‚ä½†æ˜¯å¼•å…¥cacheçš„åŒæ—¶åˆä¼šå¸¦æ¥ cache coherenceç­‰é—®é¢˜ï¼Œè¿™ä¹Ÿæ˜¯é€ æˆxåˆå§‹ä¸º0ï¼Œä¸¤ä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œ x&#43;&#43;ï¼Œè€Œxæœ€ç»ˆä¸ä¸€å®šä¸º 2çš„å…ƒå‡¶ã€‚è€Œä¸€ä¸ªå†…å­˜æ¨¡å‹åˆ™å¯¹ä¸Šè¿°å¹¶å‘ç¨‹åºçš„åŒä¸€å—å†…å­˜è¿›è¡Œäº†ä¸€å®šçš„é™åˆ¶ï¼Œå®ƒç»™å‡ºäº†åœ¨å¹¶å‘ç¨‹åºä¸‹ï¼Œä»»æ„ä¸€ç»„å†™æ“ä½œæ—¶ï¼Œå¯èƒ½è¯»åˆ°çš„å€¼ã€‚ ä¸åŒä½“ç³»ç»“æ„(x86, arm, powerâ€¦)é€šè¿‡ä¸åŒçš„å†…å­˜æ¨¡å‹æ¥ä¿è¯ç¨‹åºçš„æ­£ç¡®æ€§ã€‚
bonus question: ä¸åŒç­‰çº§çš„cache latencyï¼Ÿ
answer: l1: 1ns, l2: 5ns, l3: 50~100ns, main memory: 200ns
...</p>
  </div>
  <footer class="entry-footer"><span title='2023-09-01 15:51:19 +0000 UTC'>September 1, 2023</span>&nbsp;Â·&nbsp;3 min</footer>
  <a class="entry-link" aria-label="post link to C&#43;&#43;å†…å­˜æ¨¡å‹ â€”â€” ç°ä»£Architectureçš„å¦¥å" href="https://caaatch22.github.io/posts/c-%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B--%E7%8E%B0%E4%BB%A3architecture%E7%9A%84%E5%A6%A5%E5%8D%8F/"></a>
</article>

<article class="post-entry"> 
  <header class="entry-header">
    <h2>Computer Architecture â€”â€” é«˜çº§ç¼“å­˜æŠ€æœ¯
    </h2>
  </header>
  <div class="entry-content">
    <p> æœ¬æ–‡ä¸ä¼šä»‹ç»cacheçš„ç»„ç»‡å½¢å¼ç­‰åŸºæœ¬å†…å®¹ï¼Œä½†ä¹Ÿç®—ä¸ä¸Šä»€ä¹ˆ&#34;Advanced&#34;ã€‚ä¸»è¦åŒ…å«ä¸€äº›ä»ç¡¬ä»¶å±‚é¢ä¼˜åŒ–cacheçš„æ‰‹æ®µã€‚
ä¼˜åŒ–cacheçš„å‡ ç§æ–¹æ³• pipeline caches ä¸Šå›¾ä¸ºæ•™ç§‘ä¹¦ä¸Šç»å¸¸å‡ºç°çš„cacheå½¢å¼(2-way associativeä¸ºä¾‹)ï¼Œå®ƒå¾ˆç²¾ç‚¼çš„è§£é‡Šäº†cacheçš„å®ç°ã€‚ä½†ä¹Ÿç¨å¾®å¼•å…¥äº†äº›â€œè¯¯å¯¼â€ï¼š
å›¾ä¸­vã€tagå’Œdataéƒ¨åˆ†ç”»åœ¨è¿ç»­çš„ä¸€è¡Œä¸Šï¼Œä»¿ä½›ç¡¬ä»¶ä¸Šä»–ä»¬å°±æ˜¯åŒä¸€å— SRAM çš„ä¸åŒbit å›¾ä¸­è¯†åˆ«tagä¸dataæ˜¯å¹¶è¡Œå®Œæˆçš„ï¼Œè¿™å¾ˆå¥½ï¼ŒæŸç§æ„ä¹‰ä¸Šèƒ½é™ä½æ—¶å»¶ï¼›ä½†æˆ‘ä»¬ç»å¸¸é—å¿˜ä¸€ä¸ªäº‹å®ï¼Œåªæœ‰è¯»cacheçš„æ—¶å€™æˆ‘ä»¬æ‰èƒ½è¿™ä¹ˆæ“ä½œï¼ˆæˆ–è€…è¯´åœ¨å†™cacheæ—¶ï¼Œè¯»å–data blockæ˜¯æ²¡æœ‰æ„ä¹‰çš„ï¼‰ å¯¹äºç¬¬ä¸€ç‚¹ï¼Œåœ¨å®é™…çš„å®ç°å½“ä¸­ï¼Œtagå’Œdataéƒ¨åˆ†éƒ½æ˜¯åˆ†å¼€æ”¾ç½®çš„ï¼Œtagä¸€èˆ¬æ˜¯ç”±ä¸€ç§å«CAM(Context-Addressable Memory)çš„ææ–™æ„æˆã€‚å½“ç„¶ï¼Œè¿™ä¸piä¸pipelineæ²¡ä»€ä¹ˆå…³ç³»ï¼›
è¯»cacheä¸»è¦å°±ä¸¤ä¸ªéƒ¨åˆ†ï¼šæ¯”è¾ƒtagï¼Œè·å–dataï¼›æˆ‘ä»¬æš‚ä¸”ä¸è€ƒè™‘ä»¥pipelineçš„æ–¹å¼ä¼˜åŒ–ï¼Œé‚£ä¹ˆserialçš„å…ˆæ¯”è¾ƒtagå†è¯»dataä¸€å®šä¸å¦‚parallelçš„æ–¹å¼è¿›è¡Œå—ï¼Ÿå½“æˆ‘ä»¬å¹¶è¡Œçš„è¯»å–tagå’Œdataçš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¼šå‘ç°ï¼Œè¯»å‡ºæ¥çš„dataæœ‰å¯èƒ½æ²¡ç”¨ï¼ˆæ²¡æœ‰åŒ¹é…çš„tagï¼‰ï¼›å¹¶ä¸”ï¼Œåœ¨n-way set associate cacheä¸­ï¼Œæˆ‘ä»¬ä¼šæµªè´¹çš„è¯»å‡º$n-1$ä¸ªdataé¡¹ï¼›è¿™ç»™æˆ‘ä»¬ä»€ä¹ˆå¯ç¤ºå‘¢ï¼Ÿå¦‚æœæˆ‘ä»¬ä¸²è¡Œçš„è¯»cacheï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥åœ¨æ¯”è¾ƒtagé˜¶æ®µå°±çŸ¥é“æˆ‘ä»¬æƒ³è¦çš„æ•°æ®åœ¨ä¸åœ¨cacheå½“ä¸­ï¼›æ›´æœ‰æ„ä¹‰çš„æ˜¯ï¼Œæ ¹æ®tagæ¯”è¾ƒçš„ç»“æœï¼Œæˆ‘ä»¬å°±çŸ¥é“å“ªä¸€è·¯çš„æ•°æ®æ˜¯éœ€è¦è¢«è®¿é—®çš„ï¼ˆæå‰çŸ¥é“äº†åœ¨n-wayä¸­çš„å“ªä¸€wayï¼‰ï¼Œé‚£ä¹ˆæˆ‘ä»¬è®¿é—®data blockæ—¶ï¼Œå°±æ— éœ€å¤šè·¯é€‰æ‹©å™¨ï¼Œç›´æ¥è®¿é—®æŒ‡å®šçš„wayï¼Œå°†å…¶ä»–wayçš„dataè®¿é—®çš„ä½¿èƒ½ä¿¡å·ç½®ä¸ºæ— æ•ˆï¼Œè¿™ç§åšæ³•çš„ä¼˜ç‚¹åœ¨äºæœ‰æ•ˆå‡å°åŠŸè€—ã€‚
serialçš„åšæ³•è‚¯å®šæ¯”parallelçš„å»¶æ—¶è¦å¤§ï¼Œè‹¥è¿™æ—¶è®¿é—®cacheå¤„äºå¤„ç†å™¨çš„critical path(å…³é”®è·¯å¾„)ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥å†å°†å…¶è¿›è¡Œæµæ°´çº¿åŒ–ã€‚ æˆ‘ä»¬ç°åœ¨å†æ¥çœ‹çœ‹å†™cacheæ—¶çš„æƒ…å†µï¼š
å†™cacheæ—¶ï¼Œåªæœ‰é€šè¿‡tagæ¯”è¾ƒï¼Œç¡®è®¤è¦å†™çš„åœ°å€åœ¨cacheä¸­åï¼Œæ‰å¯ä»¥å†™data SRAMï¼Œåœ¨ä¸»é¢‘è¾ƒé«˜çš„å¤„ç†å™¨ä¸­ï¼Œè¿™äº›æ“ä½œå¾ˆéš¾åœ¨ä¸€ä¸ªå‘¨æœŸå†…å®Œæˆï¼Œè¿™ä¹Ÿè¦æ±‚æˆ‘ä»¬å°†å…¶æµæ°´çº¿åŒ–ã€‚ä¸‹å›¾ä¸ºå¯¹cacheè¿›è¡Œå†™æ“ä½œä½¿ç”¨çš„æµæ°´çº¿ç¤ºæ„å›¾ï¼š
åœ¨ä¸Šå›¾çš„å®ç°æ–¹å¼ä¸­ï¼Œstoreç¬¬ä¸€ä¸ªå‘¨æœŸè¯»å–Tagå¹¶è¿›è¡Œæ¯”è¾ƒï¼Œæ ¹æ®æ¯”è¾ƒçš„ç»“æœï¼Œåœ¨ç¬¬äºŒä¸ªå‘¨æœŸé€‰æ‹©æ˜¯å¦å°†æ•°æ®å†™åˆ°Data SRAMä¸­ã€‚è¿˜éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå½“æ‰§è¡ŒloadæŒ‡ä»¤æ—¶ï¼Œå®ƒæƒ³è¦çš„æ•°æ®å¯èƒ½æ­£å¥½åœ¨storeæŒ‡ä»¤çš„æµæ°´çº¿å¯„å­˜å™¨ä¸­ï¼ˆRAWçš„æƒ…å†µï¼›ä¸Šå›¾ä¸­çš„DelayedStoreDataå¯„å­˜å™¨ï¼‰ï¼Œè€Œä¸æ˜¯æ¥è‡ªäºData SRAMã€‚å› æ­¤éœ€è¦ä¸€ç§æœºåˆ¶æ£€æµ‹è¿™ç§æƒ…å†µï¼Œè¿™éœ€è¦å°†loadæŒ‡ä»¤æ‰€æºå¸¦çš„åœ°å€å’ŒstoreæŒ‡ä»¤çš„æµæ°´çº¿å¯„å­˜å™¨(å³DelayedStoreAddrå¯„å­˜å™¨)è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœç›¸ç­‰ï¼Œé‚£ä¹ˆå°±å°†storeæŒ‡ä»¤çš„æ•°æ®ä½œä¸ºloadæŒ‡ä»¤çš„ç»“æœã€‚
ç”±æ­¤å¯ä»¥çœ‹å‡ºï¼Œå¯¹å†™D-Cacheä½¿ç”¨æµæ°´çº¿ä¹‹åï¼Œä¸ä»…å¢åŠ äº†æµæ°´çº¿æœ¬èº«çš„ç¡¬ä»¶ï¼Œä¹Ÿå¸¦æ¥äº†å…¶ä»–ä¸€äº›é¢å¤–çš„ç¡¬ä»¶å¼€é”€ã€‚å…¶å®ã€‚ä¸ä»…åœ¨Cacheä¸­æœ‰è¿™ç§ç°è±¡ï¼Œåœ¨å¤„ç†å™¨çš„å…¶ä»–éƒ¨åˆ†å¢åŠ æµæ°´çº¿çš„çº§æ•°ï¼Œä¹Ÿä¼šä¼´éšç€å…¶ä»–æ–¹é¢çš„ç¡¬ä»¶éœ€æ±‚,å› æ­¤è¿‡æ·±çš„æµæ°´çº¿å¸¦æ¥çš„ç¡¬ä»¶å¤æ‚åº¦æ˜¯éå¸¸é«˜çš„ï¼Œå°±åƒIntelçš„Pentium 4å¤„ç†å™¨ï¼Œå¹¶ä¸ä¼šä»è¿‡æ·±çš„æµæ°´çº¿ä¸­å¾—åˆ°é¢„æƒ³çš„å¥½å¤„ã€‚å½“ç„¶ï¼Œcacheçš„æµæ°´çº¿åŒ–å·²ç»æ˜¯ä¸€ç§å¹¿æ³›ä½¿ç”¨çš„ç”¨äºé™ä½latencyçš„æ–¹æ³•äº†ã€‚
write buffers æˆ‘æ„¿ç§°ä¹‹ä¸ºbuffer of bufferï¼Œæœ¬æ¥cacheå°±èµ·bufferçš„ä½œç”¨äº†ï¼Œä½†æˆ‘ä»¬å†åŠ ä¸€ä¸ªbufferï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š è¿™å’Œå¤šä¸€çº§çš„cacheæœ‰ä»€ä¹ˆä¸åŒå‘¢ï¼Ÿè¿™æ˜¯ä¸€ä¸ªä¸“é—¨ä¸ºå†™æ“ä½œè®¾è®¡çš„bufferï¼ˆæ³¨æ„ï¼šloadä¹Ÿå¯èƒ½é€ æˆå†™æ“ä½œï¼‰ã€‚åŸå› åœ¨äºæˆ‘ä»¬çŸ¥é“å†™é€šå¸¸æ¯”è¯»æ›´æ…¢ï¼Œç‰¹åˆ«å¯¹äºwrite-throughæ¥è¯´ï¼›å…¶æ¬¡ï¼Œå½“ä¸Šå±‚cacheæ»¡åï¼Œéœ€è¦å…ˆå°†dirty cache lineå†™å›ä¸‹å±‚cacheï¼Œå†è¯»å–ä¸‹å±‚cacheä¸­çš„æ•°æ®ã€‚è‹¥ä¸‹å±‚cacheåªæœ‰ä¸€ä¸ªè¯»å†™ç«¯å£ï¼Œé‚£ä¹ˆè¿™ç§ä¸²è¡Œçš„è¿‡ç¨‹å¯¼è‡´D-Cacheå‘ç”Ÿç¼ºå¤±çš„å¤„ç†æ—¶é—´å˜å¾—å¾ˆé•¿ï¼Œæ­¤æ—¶å°±å¯ä»¥é‡‡ç”¨write bufferæ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚è„çŠ¶æ€çš„cache-lineä¼šé¦–å…ˆæ”¾åˆ°å†™çº§å­˜ä¸­ï¼Œç­‰åˆ°ä¸‹çº§å­˜å‚¨å™¨æœ‰ç©ºé—²çš„æ—¶å€™ï¼Œæ‰ä¼šå°†å†™ç¼“å­˜ä¸­çš„æ•°æ®å†™åˆ°ä¸‹çº§å­˜å‚¨å™¨ä¸­ã€‚
å¯¹äºwrite bufferï¼Œæˆ‘ä»¬è¿˜å¯ä»¥å¯¹å…¶è¿›è¡Œ åˆå¹¶(merging) æ“ä½œã€‚æ‰€è°“mergingï¼ŒæŒ‡çš„æ˜¯å°†åœ¨åŒä¸€ä¸ªcache-lineä¸Šçš„æ•°æ®ä¸€å¹¶å†™å…¥ä¸‹å±‚cacheä¸­ï¼Œè€Œéå¤šæ¬¡å†™å…¥åŒä¸€ä¸ªcache-lineã€‚ ä¸Šå›¾ä¸­çš„å³ä¾§è¡¨ç¤ºäº†ä¸€ä¸ªé‡‡ç”¨äº†merging write bufferç­–ç•¥çš„å†™ç¼“å†²åŒºã€‚
critial word first and early restart å…ˆæ¥çœ‹ä¸€ä¸‹cache missæ—¶çš„cpuï¼š å›¾ä¸­å±•ç¤ºäº†ä¸€ä¸ªblocking cacheåœ¨cache missæ—¶ï¼Œcpu stallï¼Œè€Œåcacheå°†éœ€è¦å–å¾—çš„cache-lineæ”¾å…¥åï¼Œcpu resumeçš„timelineã€‚æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œè‹¥æˆ‘ä»¬åªéœ€è¦cache-lineä¸­çš„ç¬¬3ä¸ªwordï¼Œcpuå®Œå…¨å¯ä»¥ææ—©resumeã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š ...</p>
  </div>
  <footer class="entry-footer"><span title='2023-08-23 23:38:14 +0000 UTC'>August 23, 2023</span>&nbsp;Â·&nbsp;2 min</footer>
  <a class="entry-link" aria-label="post link to Computer Architecture â€”â€” é«˜çº§ç¼“å­˜æŠ€æœ¯" href="https://caaatch22.github.io/posts/advanced-cache/"></a>
</article>

<article class="post-entry"> 
  <header class="entry-header">
    <h2>phmap â€”â€” ç¼“å­˜å‹å¥½çš„é«˜æ•ˆhashtable
    </h2>
  </header>
  <div class="entry-content">
    <p> ä¼—æ‰€å‘¨çŸ¥ï¼ŒC&#43;&#43;æ ‡å‡†åº“çš„ unordered_mapåœ¨æ€§èƒ½ä¸Šå‘æ¥ä¸æ˜¯ä¸€ä¸ªå¥½çš„é€‰æ‹©ã€‚å¼€æºå¸‚åœºä¸Šæœ‰éå¸¸å¤šçš„é«˜æ€§èƒ½å“ˆå¸Œè¡¨å¯ä¾›é€‰æ‹©ï¼Œphmapç»§æ‰¿è‡ª absl-hashmapï¼Œæœ‰ç€éå¸¸å¥½çš„æ’å…¥ã€æŸ¥æ‰¾æ€§èƒ½ã€‚åœ¨è‘—åçš„Comprehensive C&#43;&#43; Hashmap Benchmarks 2022æ¦œå•ä¸­ååˆ—å‰èŒ…ã€‚äº‹å®ä¸Šï¼Œæˆ‘æ¯”å¯¹äº† phmap::flat_hash_mapä¸æ¦œå•ä¸­ç»¼åˆæ€§èƒ½ç¬¬ä¸€çš„ ankerl::unordered_dense::mapï¼Œæˆ‘çš„benchmarkä¸­åªæœ‰éå†å“ˆå¸Œè¡¨æ—¶ï¼Œflat_hash_mapçš„æ€§èƒ½ä½äº unordered_dense::mapï¼Œå…¶ä½™æ— è®ºæ˜¯æ’å…¥è¿˜æ˜¯éšå³æŸ¥æ‰¾ï¼Œå¤§éƒ¨åˆ†æƒ…å†µä¸‹ flat_hash_mapçš„æ€§èƒ½éƒ½æ›´ä¼˜ã€‚æœ¬æ–‡ç®€å•ä»‹ç»äº† flat_hash_mapç›¸å…³æƒ…å†µï¼Œä»¥åŠä¸€äº›ä½¿ç”¨ä¸Šçš„å»ºè®®ä¸å‘ç‚¹ã€‚
flat_hash_map å’Œ node_hash_mapåŒºåˆ« phmapä¸­æœ‰æä¾›äº†ä¸¤ç±»å“ˆå¸Œè¡¨ï¼Œå…¶å†…éƒ¨å¸ƒå±€ç¤ºæ„å›¾å¦‚ä¸‹ï¼š
ç”±ä¸Šå›¾ï¼ˆå¿½ç•¥äº†bucketçš„ç»†èŠ‚ï¼‰å¯ä»¥çœ‹å‡ºï¼Œflat_hash_mapçš„æœ€å¤§çš„ä¼˜ç‚¹åœ¨äº
nodeä¹‹é—´çš„å†…å­˜æ˜¯è¿ç»­çš„(è™½ç„¶å¯èƒ½ä¸­é—´å­˜åœ¨ç©ºnode)ï¼Œéå†çš„æ—¶å€™å¯¹cacheæ›´åŠ å‹å¥½ å¹¶ä¸”ç›¸æ¯”äº node_hash_mapç‰ˆå°‘ä¸€æ¬¡å¯»å€è¿‡ç¨‹ï¼ˆstd::unordered_mapçš„è®¾è®¡ä¸ node_hash_mapï¼‰ç›¸åŒã€‚ è€Œ flat_*ç³»åˆ—çš„ç¼ºç‚¹å°±æ˜¯åœ¨ rehashçš„æ—¶å€™:
ä¼šå¼•å‘åŸæ¥çš„valueå¤±æ•ˆï¼ˆè¿™é‡Œçš„å¤±æ•ˆæŒ‡çš„æ˜¯åŸæ¥çš„é‚£ä¸ªå¯¹è±¡æ‰€å¯¹åº”çš„å†…å­˜å¤±æ•ˆï¼Œè€Œä¸æ˜¯valueæ‰€åŒ…å«çš„å†…å®¹å¤±æ•ˆï¼Œä¾‹å¦‚ï¼Œvalueæ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œé‚£å®ƒçš„å€¼â€”â€”æ‰€æŒ‡å‘çš„å¯¹è±¡ï¼Œä¸ä¼šå—åˆ°å½±å“ï¼‰ã€‚ä¸¾ä¸ªä¾‹å­ï¼š flat_hash_map&lt;int, Data&gt; mp; node_hash_map&lt;int, Data&gt; nodemp; mp[0] = Data(); nodemp[0] = Data(); auto&amp; mp0 = mp[0]; auto&amp; nodemp0 = nodemp[0]; // tigger rehash for (int i = 1; i &lt;= 10; i &#43;&#43;) { mp[i] = Data(); nodemp[i] = Data(); } assert(std::addressof(mp[0]) != std::addressof(mp0)); assert(std::addressof(nodemp[0]) == std::addressof(nodemp0)); åŸå› å°±æ˜¯ flat_hash_mapçš„å†…å­˜å¸ƒå±€å¯¼è‡´çš„ã€‚è€Œ node_hash_mapæˆ–è€… std::unordered_mapå°±ä¿è¯ä¸ä¼šå‡ºç°è¿™ç§æƒ…å†µï¼Œå› ä¸ºå½“ä»–ä»¬rehashçš„æ—¶å€™ï¼Œåªéœ€è¦å°†bucketå†…çš„æŒ‡é’ˆé‡æ–°åˆ†é…ï¼ŒæŒ‡é’ˆçš„å€¼è¿˜æ˜¯æŒ‡å‘åŸæ¥çš„ node&lt;key, value&gt;.
...</p>
  </div>
  <footer class="entry-footer"><span title='2023-07-23 21:23:15 +0000 UTC'>July 23, 2023</span>&nbsp;Â·&nbsp;3 min</footer>
  <a class="entry-link" aria-label="post link to phmap â€”â€” ç¼“å­˜å‹å¥½çš„é«˜æ•ˆhashtable" href="https://caaatch22.github.io/posts/phmap/"></a>
</article>

<article class="post-entry"> 
  <header class="entry-header">
    <h2>ICPCè¥¿å®‰æ¸¸è®°
    </h2>
  </header>
  <div class="entry-content">
    <p>æ²¡å†™è®°å½•ï¼Œå­¦å¼Ÿå†™äº†ï¼Œç›´æ¥ç”¨
ICPCè¥¿å®‰é‚€è¯·èµ›
</p>
  </div>
  <footer class="entry-footer"><span title='2023-05-29 13:35:22 +0000 UTC'>May 29, 2023</span>&nbsp;Â·&nbsp;1 min</footer>
  <a class="entry-link" aria-label="post link to ICPCè¥¿å®‰æ¸¸è®°" href="https://caaatch22.github.io/posts/icpc%E8%A5%BF%E5%AE%89%E6%B8%B8%E8%AE%B0/"></a>
</article>
<footer class="page-footer">
  <nav class="pagination">
    <a class="next" href="https://caaatch22.github.io/page/2/">Next&nbsp;&nbsp;Â»
    </a>
  </nav>
</footer>
    </main>
    
<footer class="footer">
    <span>&copy; 2025 <a href="https://caaatch22.github.io/">Mingjie&#39;s Home</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
